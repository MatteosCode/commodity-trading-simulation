<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commodity Trading Club — Full Day Simulation</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --black: #080a0d;
    --panel: #0d1117;
    --panel2: #101820;
    --border: #1a2332;
    --amber: #ffb300;
    --amber-dim: #7a5500;
    --green: #00e676;
    --green-dim: #00573d;
    --red: #ff1744;
    --red-dim: #5c0019;
    --blue: #40c4ff;
    --cyan: #00e5ff;
    --text: #c8d6e5;
    --text-dim: #4a5568;
    --gold: #ffd54f;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--black); color: var(--text); font-family: 'Barlow', sans-serif; font-size: 14px; line-height: 1.5; min-height: 100vh; }

  /* HEADER */
  .header { background: var(--panel); border-bottom: 1px solid var(--amber); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 200; }
  .logo { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 900; letter-spacing: 3px; color: var(--amber); text-transform: uppercase; }
  .logo span { color: var(--green); }
  .tagline { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); letter-spacing: 2px; }
  .clock { font-family: 'Share Tech Mono', monospace; font-size: 22px; color: var(--green); letter-spacing: 2px; }
  .session-badge { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 2px; padding: 4px 10px; border: 1px solid var(--amber); color: var(--amber); text-transform: uppercase; }

  /* NAV */
  .nav { background: var(--panel); border-bottom: 1px solid var(--border); display: flex; padding: 0 24px; overflow-x: auto; gap: 0; }
  .tab { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 11px 18px; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-dim); transition: all 0.2s; white-space: nowrap; border-top: none; border-left: none; border-right: none; background: none; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--amber); border-bottom: 3px solid var(--amber); }
  .tab.energy.active { color: #40c4ff; border-bottom-color: #40c4ff; }
  .tab.agri.active { color: var(--green); border-bottom-color: var(--green); }
  .tab.risk.active { color: var(--red); border-bottom-color: var(--red); }
  .tab.live-tab { color: var(--cyan); }
  .tab.live-tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }
  .tab-dot { display: inline-block; width: 6px; height: 6px; background: var(--red); border-radius: 50%; margin-left: 5px; animation: blink 1s infinite; vertical-align: middle; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  /* PAGES */
  .page { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
  .page.active { display: block; }

  /* TYPOGRAPHY */
  .section-title { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; color: var(--amber); margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .section-title.blue { color: var(--blue); }
  .section-title.green { color: var(--green); }
  .section-title.red { color: var(--red); }
  .section-title.cyan { color: var(--cyan); }

  /* GRIDS */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 22px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 18px; margin-bottom: 22px; }
  .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 14px; margin-bottom: 22px; }
  .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 18px; margin-bottom: 22px; }

  /* CARDS */
  .card { background: var(--panel); border: 1px solid var(--border); padding: 16px; position: relative; }
  .card::before { content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: var(--amber); }
  .card.blue::before { background: var(--blue); }
  .card.green::before { background: var(--green); }
  .card.red::before { background: var(--red); }
  .card.cyan::before { background: var(--cyan); }
  .card-title { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 12px; }

  /* STAT BOX */
  .stat-box { background: var(--panel); border: 1px solid var(--border); padding: 16px; text-align: center; }
  .stat-value { font-family: 'Share Tech Mono', monospace; font-size: 24px; color: var(--amber); line-height: 1; margin-bottom: 4px; }
  .stat-value.blue { color: var(--blue); }
  .stat-value.green { color: var(--green); }
  .stat-value.red { color: var(--red); }
  .stat-value.cyan { color: var(--cyan); }
  .stat-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }

  /* TIMELINE */
  .timeline { position: relative; padding-left: 28px; }
  .timeline::before { content: ''; position: absolute; left: 8px; top: 8px; bottom: 8px; width: 1px; background: linear-gradient(to bottom, var(--amber), transparent); }
  .timeline-item { position: relative; margin-bottom: 18px; }
  .timeline-item::before { content: ''; position: absolute; left: -24px; top: 6px; width: 8px; height: 8px; border: 1px solid var(--amber); background: var(--black); transform: rotate(45deg); }
  .timeline-item.red::before { border-color: var(--red); }
  .timeline-item.blue::before { border-color: var(--blue); }
  .timeline-item.green::before { border-color: var(--green); }
  .tl-time { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--amber); margin-bottom: 2px; }
  .tl-time.red { color: var(--red); }
  .tl-time.blue { color: var(--blue); }
  .tl-time.green { color: var(--green); }
  .tl-title { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .tl-body { font-size: 13px; color: var(--text-dim); line-height: 1.6; }

  /* RULE BLOCK */
  .rule-block { background: rgba(255,179,0,0.04); border: 1px solid rgba(255,179,0,0.15); padding: 12px 14px; margin-bottom: 10px; font-size: 13px; }
  .rule-block.blue { background: rgba(64,196,255,0.04); border-color: rgba(64,196,255,0.15); }
  .rule-block.green { background: rgba(0,230,118,0.04); border-color: rgba(0,230,118,0.15); }
  .rule-block.red { background: rgba(255,23,68,0.04); border-color: rgba(255,23,68,0.15); }
  .rule-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .rule-label.amber { color: var(--amber); }
  .rule-label.blue { color: var(--blue); }
  .rule-label.green { color: var(--green); }
  .rule-label.red { color: var(--red); }

  /* TABLES */
  .comm-table { width: 100%; border-collapse: collapse; font-family: 'Share Tech Mono', monospace; font-size: 12px; }
  .comm-table th { text-align: left; padding: 6px 10px; font-size: 10px; letter-spacing: 2px; color: var(--text-dim); border-bottom: 1px solid var(--border); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; }
  .comm-table td { padding: 8px 10px; border-bottom: 1px solid #111820; }
  .comm-table tr:hover td { background: #0f1820; }
  .commodity-name { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 600; color: var(--text); }
  .up { color: var(--green); }
  .down { color: var(--red); }
  .neutral { color: var(--amber); }

  /* EVENT CARDS */
  .event-card { background: var(--panel); border: 1px solid var(--border); border-left: 3px solid var(--amber); padding: 14px 16px; margin-bottom: 12px; }
  .event-card.blue { border-left-color: var(--blue); }
  .event-card.green { border-left-color: var(--green); }
  .event-card.red { border-left-color: var(--red); }
  .event-severity { font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 2px; margin-bottom: 4px; }
  .sev-high { color: var(--red); }
  .sev-med { color: var(--amber); }
  .sev-low { color: var(--green); }
  .event-title { font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .event-body { font-size: 12px; color: var(--text-dim); line-height: 1.6; margin-bottom: 8px; }
  .event-impact { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--amber); padding: 6px 10px; background: rgba(255,179,0,0.05); border: 1px solid rgba(255,179,0,0.15); }
  .event-impact.blue { color: var(--blue); background: rgba(64,196,255,0.05); border-color: rgba(64,196,255,0.15); }
  .event-impact.green { color: var(--green); background: rgba(0,230,118,0.05); border-color: rgba(0,230,118,0.15); }

  /* CHECKLIST */
  .checklist { list-style: none; }
  .checklist li { padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px; display: flex; gap: 10px; align-items: flex-start; }
  .checklist li::before { content: '◆'; color: var(--amber); font-size: 8px; margin-top: 4px; flex-shrink: 0; }
  .checklist li.blue::before { color: var(--blue); }
  .checklist li.green::before { color: var(--green); }
  .checklist li.red::before { color: var(--red); }

  /* DEBRIEF */
  .debrief-q { background: var(--panel); border: 1px solid var(--border); border-left: 3px solid var(--amber); padding: 12px 16px; margin-bottom: 10px; font-size: 13px; font-style: italic; }
  .debrief-q.blue { border-left-color: var(--blue); }
  .debrief-q.green { border-left-color: var(--green); }
  .debrief-q.red { border-left-color: var(--red); }

  /* ROLE CARD */
  .role-card { background: var(--panel); border: 1px solid var(--border); padding: 16px; }
  .role-name { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; letter-spacing: 1px; margin-bottom: 2px; }
  .role-desk { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); margin-bottom: 10px; letter-spacing: 1px; }
  .role-duties { font-size: 12px; color: var(--text-dim); line-height: 1.7; }

  /* ═══ LIVE SIM PAGE ═══ */
  /* Scoreboard */
  .scoreboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
  .desk-score { background: var(--panel); border: 1px solid var(--border); padding: 16px; position: relative; overflow: hidden; transition: all 0.3s; }
  .desk-score::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
  .desk-score.softs::before { background: var(--amber); }
  .desk-score.energy::before { background: var(--blue); }
  .desk-score.agri::before { background: var(--green); }
  .ds-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; }
  .ds-pnl { font-family: 'Share Tech Mono', monospace; font-size: 28px; font-weight: 700; margin-bottom: 4px; transition: all 0.3s; }
  .ds-pnl.pos { color: var(--green); }
  .ds-pnl.neg { color: var(--red); }
  .ds-pnl.zero { color: var(--text-dim); }
  .ds-dll { font-family: 'Share Tech Mono', monospace; font-size: 11px; margin-bottom: 8px; }
  .dll-bar-wrap { height: 4px; background: var(--border); width: 100%; }
  .dll-bar { height: 4px; background: var(--green); transition: width 0.5s, background 0.3s; }
  .dll-bar.warn { background: var(--amber); }
  .dll-bar.danger { background: var(--red); animation: pulse-red 0.5s infinite; }
  @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .ds-meta { font-size: 11px; color: var(--text-dim); margin-top: 6px; font-family: 'Share Tech Mono', monospace; }

  /* Sim controls */
  .sim-controls { background: var(--panel); border: 1px solid var(--border); padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
  .sim-btn { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 8px 16px; border: 1px solid; cursor: pointer; transition: all 0.2s; background: transparent; }
  .sim-btn.amber { color: var(--amber); border-color: var(--amber); }
  .sim-btn.amber:hover { background: var(--amber); color: var(--black); }
  .sim-btn.green { color: var(--green); border-color: var(--green); }
  .sim-btn.green:hover { background: var(--green); color: var(--black); }
  .sim-btn.red { color: var(--red); border-color: var(--red); }
  .sim-btn.red:hover { background: var(--red); color: var(--black); }
  .sim-btn.blue { color: var(--blue); border-color: var(--blue); }
  .sim-btn.blue:hover { background: var(--blue); color: var(--black); }
  .sim-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .sim-timer { font-family: 'Share Tech Mono', monospace; font-size: 13px; color: var(--text-dim); }

  /* Trade entry */
  .trade-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .trade-form { background: var(--panel); border: 1px solid var(--border); padding: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); }
  .form-input, .form-select { background: var(--black); border: 1px solid var(--border); color: var(--text); padding: 8px 10px; font-family: 'Share Tech Mono', monospace; font-size: 13px; width: 100%; outline: none; }
  .form-input:focus, .form-select:focus { border-color: var(--amber); }
  .form-select option { background: var(--panel); }
  .btn-long { background: rgba(0,230,118,0.1); border: 1px solid var(--green); color: var(--green); padding: 10px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 2px; cursor: pointer; width: 100%; transition: all 0.2s; }
  .btn-long:hover { background: var(--green); color: var(--black); }
  .btn-short { background: rgba(255,23,68,0.1); border: 1px solid var(--red); color: var(--red); padding: 10px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 2px; cursor: pointer; width: 100%; transition: all 0.2s; }
  .btn-short:hover { background: var(--red); color: var(--black); }
  .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

  /* Price feed */
  .price-feed { background: var(--panel); border: 1px solid var(--border); padding: 16px; }
  .price-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .price-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 600; }
  .price-val { font-family: 'Share Tech Mono', monospace; font-size: 14px; }
  .price-change { font-family: 'Share Tech Mono', monospace; font-size: 11px; min-width: 60px; text-align: right; }
  .price-input-group { display: flex; gap: 6px; align-items: center; }
  .price-edit { width: 80px; background: var(--black); border: 1px solid var(--border); color: var(--text); padding: 4px 6px; font-family: 'Share Tech Mono', monospace; font-size: 12px; outline: none; }
  .price-edit:focus { border-color: var(--amber); }
  .price-set-btn { background: var(--amber-dim); border: none; color: var(--amber); padding: 4px 8px; cursor: pointer; font-size: 11px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; letter-spacing: 1px; }
  .price-set-btn:hover { background: var(--amber); color: var(--black); }

  /* Trade blotter */
  .blotter { background: var(--panel); border: 1px solid var(--border); padding: 0; overflow: hidden; }
  .blotter-header { display: grid; grid-template-columns: 70px 80px 100px 70px 60px 90px 90px 90px 80px; gap: 0; background: #0a0e14; border-bottom: 1px solid var(--amber-dim); }
  .blotter-header span { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 2px; color: var(--text-dim); padding: 6px 8px; text-transform: uppercase; }
  .blotter-body { max-height: 220px; overflow-y: auto; }
  .blotter-row { display: grid; grid-template-columns: 70px 80px 100px 70px 60px 90px 90px 90px 80px; gap: 0; border-bottom: 1px solid var(--border); animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; background: rgba(255,179,0,0.05); } to { opacity: 1; } }
  .blotter-row span { font-family: 'Share Tech Mono', monospace; font-size: 11px; padding: 7px 8px; color: var(--text-dim); }
  .blotter-row span.long { color: var(--green); }
  .blotter-row span.short { color: var(--red); }
  .blotter-row span.pos { color: var(--green); }
  .blotter-row span.neg { color: var(--red); }
  .blotter-row span.desk { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; color: var(--text); }
  .blotter-empty { padding: 20px; text-align: center; color: var(--text-dim); font-family: 'Share Tech Mono', monospace; font-size: 12px; }

  /* Alert feed */
  .alert-feed { background: var(--panel); border: 1px solid var(--border); }
  .alert-feed-header { padding: 10px 14px; background: #0a0e14; border-bottom: 1px solid var(--border); font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 3px; color: var(--text-dim); text-transform: uppercase; }
  .alert-list { max-height: 200px; overflow-y: auto; }
  .alert-item { padding: 8px 14px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-start; font-size: 12px; animation: fadeIn 0.3s ease; }
  .alert-item.warn { border-left: 3px solid var(--amber); }
  .alert-item.danger { border-left: 3px solid var(--red); background: rgba(255,23,68,0.04); }
  .alert-item.info { border-left: 3px solid var(--blue); }
  .alert-item.good { border-left: 3px solid var(--green); }
  .alert-time { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); white-space: nowrap; }
  .alert-msg { color: var(--text); line-height: 1.4; }

  /* Event fire panel */
  .event-fire-panel { background: var(--panel); border: 1px solid var(--border); padding: 16px; margin-bottom: 20px; }
  .event-btn { background: rgba(64,196,255,0.06); border: 1px solid rgba(64,196,255,0.25); color: var(--blue); padding: 10px 14px; font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 1px; cursor: pointer; margin-bottom: 6px; width: 100%; text-align: left; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
  .event-btn:hover { background: rgba(64,196,255,0.15); border-color: var(--blue); }
  .event-btn.fired { opacity: 0.4; cursor: not-allowed; text-decoration: line-through; }
  .event-btn.fired:hover { background: rgba(64,196,255,0.06); }
  .event-btn .ev-time { font-size: 10px; color: var(--text-dim); font-family: 'Share Tech Mono', monospace; }
  .event-btn.high-sev { border-color: rgba(255,23,68,0.3); color: var(--red); background: rgba(255,23,68,0.05); }
  .event-btn.high-sev:hover { background: rgba(255,23,68,0.12); }

  /* Event modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: var(--panel); border: 1px solid var(--amber); max-width: 600px; width: 90%; position: relative; animation: modalIn 0.2s ease; }
  @keyframes modalIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .modal-header { background: #0a0e14; border-bottom: 1px solid var(--amber-dim); padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; }
  .modal-title { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--amber); }
  .modal-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; line-height: 1; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 18px; }
  .modal-footer { padding: 14px 18px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
  .modal.red { border-color: var(--red); }
  .modal.red .modal-header { border-bottom-color: rgba(255,23,68,0.3); }
  .modal.red .modal-title { color: var(--red); }
  .modal.blue { border-color: var(--blue); }
  .modal.blue .modal-header { border-bottom-color: rgba(64,196,255,0.3); }
  .modal.blue .modal-title { color: var(--blue); }
  .modal.green { border-color: var(--green); }
  .modal.green .modal-header { border-bottom-color: rgba(0,230,118,0.3); }
  .modal.green .modal-title { color: var(--green); }

  /* Alert flash */
  .alert-flash { position: fixed; top: 80px; right: 20px; z-index: 500; max-width: 360px; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  .alert-flash-inner { background: var(--panel); border: 1px solid var(--red); border-left: 4px solid var(--red); padding: 14px 16px; }
  .alert-flash-inner.warn { border-color: var(--amber); }
  .alert-flash-inner.info { border-color: var(--blue); }
  .alert-flash-inner.event { border-color: var(--cyan); }
  .af-title { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; color: var(--red); }
  .af-title.warn { color: var(--amber); }
  .af-title.info { color: var(--blue); }
  .af-title.event { color: var(--cyan); }
  .af-body { font-size: 12px; color: var(--text-dim); }

  /* Morning view form */
  .morning-view { background: var(--panel); border: 1px solid var(--border); padding: 16px; margin-bottom: 20px; }
  .mv-section { margin-bottom: 16px; }
  .mv-label { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 6px; }
  .mv-textarea { background: var(--black); border: 1px solid var(--border); color: var(--text); padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 12px; width: 100%; min-height: 60px; resize: vertical; outline: none; line-height: 1.6; }
  .mv-textarea:focus { border-color: var(--amber); }
  .mv-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .mv-select { background: var(--black); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; font-family: 'Share Tech Mono', monospace; font-size: 12px; width: 100%; outline: none; }
  .mv-select:focus { border-color: var(--amber); }
  .mv-submitted { background: rgba(0,230,118,0.05); border: 1px solid rgba(0,230,118,0.2); padding: 16px; font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--text-dim); line-height: 2; }

  /* Open positions */
  .positions-table { width: 100%; border-collapse: collapse; font-family: 'Share Tech Mono', monospace; font-size: 12px; }
  .positions-table th { text-align: left; padding: 6px 10px; font-size: 10px; letter-spacing: 2px; color: var(--text-dim); border-bottom: 1px solid var(--amber-dim); font-family: 'Barlow Condensed', sans-serif; font-weight: 700; }
  .positions-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  .positions-table tr:hover td { background: #0f1820; }
  .close-pos-btn { background: rgba(255,23,68,0.1); border: 1px solid rgba(255,23,68,0.3); color: var(--red); padding: 3px 8px; cursor: pointer; font-size: 10px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; letter-spacing: 1px; }
  .close-pos-btn:hover { background: var(--red); color: var(--black); }

  /* EOD Report */
  .eod-report { font-family: 'Share Tech Mono', monospace; font-size: 12px; line-height: 2; color: var(--text-dim); padding: 16px; background: #0a0e14; border: 1px solid rgba(255,23,68,0.2); white-space: pre-wrap; }
  .eod-highlight { color: var(--amber); }
  .eod-pos { color: var(--green); }
  .eod-neg { color: var(--red); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: var(--black); }
  ::-webkit-scrollbar-thumb { background: var(--amber-dim); }

  /* Phase toast animation */
  @keyframes phaseToastIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  @keyframes phaseToastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

  /* Spread button */
  .btn-spread { background: rgba(0,229,255,0.08); border: 1px solid var(--cyan); color: var(--cyan); padding: 10px; font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 2px; cursor: pointer; width: 100%; transition: all 0.2s; margin-top: 8px; }
  .btn-spread:hover { background: var(--cyan); color: var(--black); }

  /* Spread badge on blotter row */
  .spread-badge { display:inline-block; font-size:9px; font-family:'Barlow Condensed',sans-serif; font-weight:700; letter-spacing:1px; padding:1px 5px; border:1px solid var(--cyan); color:var(--cyan); vertical-align:middle; margin-left:4px; }

  /* Persistence indicator */
  .persist-dot { display:inline-block; width:7px; height:7px; background:var(--green); border-radius:50%; margin-left:6px; vertical-align:middle; title:"Data saved"; }

  /* Save indicator flash */
  @keyframes savedFlash { 0%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
  .save-flash { animation: savedFlash 1.5s ease forwards; }

  @media (max-width: 900px) {
    .grid-2, .grid-3, .grid-4, .grid-1-2 { grid-template-columns: 1fr; }
    .scoreboard { grid-template-columns: 1fr; }
    .trade-panel { grid-template-columns: 1fr; }
    .blotter-header, .blotter-row { grid-template-columns: 60px 70px 90px 60px 50px 80px 80px 80px 70px; }
  }

  /* Toolbar pulse when alert */
  .alert-badge { display: none; background: var(--red); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; text-align: center; line-height: 16px; font-family: 'Barlow Condensed', sans-serif; font-weight: 700; margin-left: 4px; }
  .alert-badge.show { display: inline-block; animation: blink 1s infinite; }

  /* ═══ INSIDER TIP STYLES ═══ */
  .event-btn-wrap { position: relative; margin-bottom: 6px; }

  .tip-btn {
    position: absolute;
    right: -2px; top: -2px;
    background: var(--amber);
    color: var(--black);
    border: none;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 1px;
    padding: 2px 7px;
    cursor: pointer;
    text-transform: uppercase;
    z-index: 10;
    transition: background 0.2s;
    animation: tipPulse 2s infinite;
  }
  .tip-btn:hover { background: var(--gold); }
  @keyframes tipPulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,179,0,0.5)} 50%{box-shadow:0 0 0 5px rgba(255,179,0,0)} }

  /* The full-screen dimmed tip overlay */
  #insider-tip-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1400;
    align-items: flex-end;
    justify-content: flex-start;
    padding: 0 0 100px 40px;
    pointer-events: none;
  }
  #insider-tip-overlay.active { display: flex; pointer-events: all; }

  .tip-card {
    background: var(--panel);
    border: 1px solid var(--amber);
    border-left: 4px solid var(--amber);
    max-width: 420px;
    width: 100%;
    animation: tipCardIn 0.4s cubic-bezier(0.16,1,0.3,1);
    box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 30px rgba(255,179,0,0.1);
    pointer-events: all;
  }
  @keyframes tipCardIn { from{transform:translateY(30px) translateX(-20px);opacity:0} to{transform:none;opacity:1} }

  .tip-card-header {
    background: #0a0e14;
    border-bottom: 1px solid rgba(255,179,0,0.2);
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .tip-source-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 1px solid var(--amber);
    background: var(--black);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px; font-weight: 900;
    color: var(--amber);
    flex-shrink: 0;
  }
  .tip-source-name { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; color: var(--text); }
  .tip-source-role { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); letter-spacing: 1px; }
  .tip-encrypted-tag {
    margin-left: auto;
    font-family: 'Share Tech Mono', monospace;
    font-size: 8px;
    color: var(--amber);
    border: 1px solid rgba(255,179,0,0.3);
    padding: 2px 6px;
    letter-spacing: 1px;
    animation: blink 2s infinite;
  }
  .tip-card-body { padding: 14px; }
  .tip-message {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--text);
    line-height: 1.8;
    margin-bottom: 10px;
  }
  .tip-hint {
    font-size: 11px;
    color: var(--text-dim);
    font-style: italic;
    border-top: 1px solid var(--border);
    padding-top: 8px;
    line-height: 1.6;
  }
  .tip-close-btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    background: transparent;
    border: 1px solid var(--border);
    padding: 5px 12px;
    cursor: pointer;
    margin-top: 10px;
    transition: all 0.2s;
    width: 100%;
  }
  .tip-close-btn:hover { color: var(--text); border-color: var(--amber); }
  .tip-timestamp { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--amber); margin-bottom: 6px; }

  /* ═══ COMMODITY CHART MODAL ═══ */
  #chart-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1200;
    background: rgba(0,0,0,0.88);
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  #chart-modal.active { display: flex; }

  .chart-modal-inner {
    background: var(--panel);
    border: 1px solid var(--border);
    width: 100%;
    max-width: 860px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalIn 0.25s ease;
  }
  .chart-modal-header {
    background: #0a0e14;
    border-bottom: 1px solid var(--border);
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 5;
  }
  .chart-commodity-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 900;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .chart-modal-body { padding: 20px; }
  .chart-stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 18px;
  }
  .chart-stat {
    background: var(--black);
    border: 1px solid var(--border);
    padding: 10px;
    text-align: center;
  }
  .chart-stat-val { font-family: 'Share Tech Mono', monospace; font-size: 16px; margin-bottom: 2px; }
  .chart-stat-lbl { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }

  .chart-tab-row { display: flex; gap: 0; margin-bottom: 14px; border-bottom: 1px solid var(--border); }
  .chart-tab {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase;
    padding: 8px 16px;
    cursor: pointer;
    color: var(--text-dim);
    border: none; background: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .chart-tab:hover { color: var(--text); }
  .chart-tab.active { color: var(--amber); border-bottom-color: var(--amber); }

  canvas#commodityChart { width: 100% !important; }

  .chart-event-markers { margin-top: 14px; }
  .cem-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 8px 0; border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .cem-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
  .cem-time { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text-dim); min-width: 50px; }
  .cem-text { color: var(--text-dim); line-height: 1.5; }

  /* ═══ COUNTDOWN WIDGET ═══ */
  #event-countdown-bar {
    display: none;
    position: fixed;
    top: 56px; left: 0; right: 0;
    z-index: 900;
    background: rgba(8,10,13,0.97);
    border-bottom: 2px solid var(--red);
    padding: 10px 24px;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    box-shadow: 0 4px 30px rgba(255,23,68,0.25);
    animation: countdownBarIn 0.3s ease;
  }
  #event-countdown-bar.active { display: flex; }
  @keyframes countdownBarIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .cdb-label { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 4px; color: var(--red); text-transform: uppercase; }
  .cdb-event-title { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 900; letter-spacing: 2px; color: var(--text); flex: 1; }
  .cdb-timer {
    font-family: 'Share Tech Mono', monospace;
    font-size: 32px;
    color: var(--red);
    letter-spacing: 3px;
    min-width: 80px;
    text-align: right;
    animation: timerPulse 1s infinite;
  }
  @keyframes timerPulse { 0%,100%{opacity:1;text-shadow:0 0 12px rgba(255,23,68,0.8)} 50%{opacity:0.5;text-shadow:none} }
  .cdb-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--red); animation: blink 0.6s infinite; margin-right: 8px; }

  /* ═══ BREAKING NEWS OVERLAY ═══ */
  #breaking-news-overlay {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1500;
    background: rgba(0,0,0,0);
    pointer-events: none;
    flex-direction: column;
    align-items: stretch;
    justify-content: center;
  }
  #breaking-news-overlay.active { display: flex; pointer-events: all; }

  .bno-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(8,10,13,0.92);
    animation: bnoFadeIn 0.3s ease forwards;
  }
  @keyframes bnoFadeIn { from{opacity:0} to{opacity:1} }

  /* Scanline effect */
  .bno-scanlines {
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(255,23,68,0.02) 3px, rgba(255,23,68,0.02) 4px);
    pointer-events: none;
  }

  .bno-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    gap: 20px;
    text-align: center;
  }

  .bno-breaking-tag {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: 8px;
    color: #fff;
    background: var(--red);
    padding: 6px 24px;
    text-transform: uppercase;
    animation: bnoTagIn 0.3s 0.1s ease both;
    box-shadow: 0 0 30px rgba(255,23,68,0.6);
  }
  @keyframes bnoTagIn { from{transform:scaleX(0);opacity:0} to{transform:scaleX(1);opacity:1} }

  .bno-headline {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 52px;
    font-weight: 900;
    letter-spacing: 1px;
    color: var(--text);
    line-height: 1.1;
    max-width: 900px;
    animation: bnoHeadlineIn 0.5s 0.3s ease both;
    overflow: hidden;
  }
  @keyframes bnoHeadlineIn {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .bno-headline-chars {
    display: inline;
  }

  /* Individual character reveal */
  .bno-char {
    display: inline;
    opacity: 0;
    animation: charReveal 0.04s ease forwards;
  }
  @keyframes charReveal { from{opacity:0;color:var(--red)} to{opacity:1;color:inherit} }

  .bno-subline {
    font-family: 'Share Tech Mono', monospace;
    font-size: 14px;
    color: var(--text-dim);
    max-width: 700px;
    line-height: 1.7;
    animation: bnoHeadlineIn 0.4s 0.6s ease both;
  }

  .bno-impact-box {
    background: rgba(255,23,68,0.08);
    border: 1px solid rgba(255,23,68,0.4);
    padding: 14px 24px;
    max-width: 700px;
    width: 100%;
    animation: bnoHeadlineIn 0.4s 0.8s ease both;
  }
  .bno-impact-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 4px;
    color: var(--red);
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .bno-impact-text {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--amber);
    line-height: 1.8;
  }

  .bno-price-changes {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    justify-content: center;
    animation: bnoHeadlineIn 0.4s 1s ease both;
  }

  .bno-price-chip {
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--border);
    padding: 8px 16px;
    text-align: center;
    min-width: 100px;
  }
  .bno-price-chip .pc-name { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }
  .bno-price-chip .pc-delta { font-family: 'Share Tech Mono', monospace; font-size: 18px; }
  .bno-price-chip .pc-delta.up { color: var(--green); }
  .bno-price-chip .pc-delta.dn { color: var(--red); }

  .bno-dismiss {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-dim);
    background: transparent;
    border: 1px solid var(--border);
    padding: 10px 24px;
    cursor: pointer;
    transition: all 0.2s;
    animation: bnoHeadlineIn 0.4s 1.2s ease both;
    margin-top: 10px;
  }
  .bno-dismiss:hover { color: var(--text); border-color: var(--text-dim); }

  /* Live price direction flash */
  @keyframes priceFlashUp { 0%{background:rgba(0,230,118,0.25)} 100%{background:transparent} }
  @keyframes priceFlashDn { 0%{background:rgba(255,23,68,0.25)} 100%{background:transparent} }
  .price-row.flash-up { animation: priceFlashUp 1.5s ease forwards; }
  .price-row.flash-dn { animation: priceFlashDn 1.5s ease forwards; }

  /* Drift indicator on price */
  .price-trend { font-family: 'Share Tech Mono', monospace; font-size: 10px; margin-left: 4px; }
  .price-trend.up { color: var(--green); }
  .price-trend.dn { color: var(--red); }

  /* ═══ BID/ASK IN PRICE FEED ═══ */
  .price-row { display: grid; grid-template-columns: 1fr auto auto auto auto auto; align-items: center; gap: 6px; padding: 5px 8px; border-bottom: 1px solid rgba(26,35,50,0.6); transition: background 0.15s; cursor: pointer; }
  .price-row:hover { background: rgba(255,179,0,0.04); }
  .ba-bid { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--red); }
  .ba-ask { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--green); }
  .ba-sep { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--border); }
  .spread-label { font-family: 'Share Tech Mono', monospace; font-size: 8px; color: var(--text-dim); letter-spacing: 0.5px; }

  /* ═══ EXECUTION RECEIPT TOAST ═══ */
  #exec-receipt {
    display: none;
    position: fixed;
    bottom: 80px; right: 24px;
    background: #0d1117;
    border: 1px solid var(--border);
    border-left: 3px solid var(--green);
    padding: 12px 16px;
    z-index: 1600;
    min-width: 280px;
    animation: receiptIn 0.25s ease;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
  }
  #exec-receipt.active { display: block; }
  #exec-receipt.reject { border-left-color: var(--red); }
  @keyframes receiptIn { from{transform:translateX(20px);opacity:0} to{transform:none;opacity:1} }
  .receipt-header { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .receipt-row { display: flex; justify-content: space-between; gap: 16px; color: var(--text-dim); padding: 1px 0; }
  .receipt-row span:last-child { color: var(--text); text-align: right; }

  /* ═══ TRADE FORM ENHANCEMENTS ═══ */
  .order-type-row { display: flex; gap: 0; margin-bottom: 12px; }
  .order-type-btn { flex: 1; font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 7px 4px; cursor: pointer; border: 1px solid var(--border); background: none; color: var(--text-dim); transition: all 0.15s; }
  .order-type-btn.active { background: var(--panel2); color: var(--amber); border-color: var(--amber); }
  .order-type-btn:hover:not(.active) { color: var(--text); border-color: var(--text-dim); }
  .bid-ask-display { background: #080a0d; border: 1px solid var(--border); padding: 8px 10px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
  .bad-side { text-align: center; padding: 4px; }
  .bad-side.bid { border-right: 1px solid var(--border); }
  .bad-label { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }
  .bad-price { font-family: 'Share Tech Mono', monospace; font-size: 16px; margin-top: 2px; }
  .bad-price.bid { color: var(--red); }
  .bad-price.ask { color: var(--green); }
  .bad-spread { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); text-align: center; margin-top: 3px; border-top: 1px solid var(--border); padding-top: 4px; }
  .slippage-note { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); text-align: right; padding: 2px 0; }
  .margin-req-display { background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 6px 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .margin-req-display span:first-child { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }
  .margin-req-display span:last-child { font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--amber); }

  /* ═══ BLOTTER UPGRADE — slippage col ═══ */
  .blotter-header { display: grid; grid-template-columns: 50px 42px 110px 55px 40px 70px 70px 70px 70px 60px; gap: 0; padding: 8px 10px; background: #080a0d; border-bottom: 1px solid var(--border); font-family: 'Barlow Condensed', sans-serif; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
  .blotter-row { display: grid; grid-template-columns: 50px 42px 110px 55px 40px 70px 70px 70px 70px 60px; gap: 0; padding: 7px 10px; border-bottom: 1px solid rgba(26,35,50,0.5); font-size: 12px; transition: background 0.1s; }
  .blotter-row:hover { background: rgba(255,255,255,0.02); }

  /* ═══ RISK ANALYTICS PANEL ═══ */
  .risk-analytics-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 16px; }
  .ra-stat { background: #080a0d; border: 1px solid var(--border); padding: 12px 14px; }
  .ra-val { font-family: 'Share Tech Mono', monospace; font-size: 20px; margin-bottom: 3px; }
  .ra-lbl { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
  .ra-sub { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 2px; }
  .var-bar-wrap { height: 3px; background: var(--border); margin-top: 6px; }
  .var-bar { height: 100%; background: var(--amber); transition: width 0.5s; }
  .var-bar.warn { background: var(--amber); }
  .var-bar.danger { background: var(--red); }
  .desk-var-row { display: grid; grid-template-columns: 90px 1fr 80px 80px 80px; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-family: 'Share Tech Mono', monospace; font-size: 11px; }
  .desk-var-row:last-child { border-bottom: none; }
  .desk-var-name { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 1px; color: var(--text); }
  .desk-var-bar-wrap { height: 4px; background: var(--border); border-radius: 2px; }
  .desk-var-bar { height: 100%; border-radius: 2px; transition: width 0.5s; }

  /* ═══ INVENTORY / FUNDAMENTAL DRIVERS ═══ */
  .inv-panel { background: #080a0d; border: 1px solid var(--border); padding: 0; margin-bottom: 12px; overflow: hidden; }
  .inv-header { padding: 8px 12px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .inv-header-title { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim); }
  .inv-grid { display: grid; grid-template-columns: repeat(4,1fr); }
  .inv-item { padding: 10px 12px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
  .inv-item:nth-child(4n) { border-right: none; }
  .inv-comm { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--text); margin-bottom: 4px; }
  .inv-level-wrap { height: 3px; background: var(--border); margin: 4px 0; }
  .inv-level-bar { height: 100%; transition: width 0.8s; }
  .inv-stats { display: flex; justify-content: space-between; }
  .inv-stat { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: var(--text-dim); }
  .inv-stat span { color: var(--text); }
  .curve-tag { font-family: 'Barlow Condensed', sans-serif; font-size: 8px; font-weight: 900; letter-spacing: 1px; padding: 1px 5px; text-transform: uppercase; margin-top: 4px; display: inline-block; }
  .curve-tag.backwardation { background: rgba(0,230,118,0.12); color: var(--green); border: 1px solid rgba(0,230,118,0.3); }
  .curve-tag.contango { background: rgba(255,23,68,0.08); color: var(--red); border: 1px solid rgba(255,23,68,0.2); }
  .curve-tag.flat { background: rgba(255,179,0,0.08); color: var(--amber); border: 1px solid rgba(255,179,0,0.2); }

  /* ═══ MODEL DOCUMENTATION PAGE ═══ */
  .model-section { margin-bottom: 24px; }
  .model-formula { background: #080a0d; border: 1px solid var(--border); border-left: 3px solid var(--amber); padding: 12px 16px; font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--amber); line-height: 1.9; margin: 10px 0; letter-spacing: 0.5px; }
  .model-param-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 8px 0; }
  .model-param-table th { font-family: 'Barlow Condensed', sans-serif; font-size: 9px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); padding: 6px 10px; border-bottom: 1px solid var(--border); text-align: left; }
  .model-param-table td { padding: 6px 10px; border-bottom: 1px solid rgba(26,35,50,0.5); color: var(--text-dim); font-family: 'Share Tech Mono', monospace; font-size: 11px; }
  .model-param-table td:first-child { color: var(--amber); }
  .limitation-item { padding: 8px 12px; border-left: 2px solid var(--border); margin: 6px 0; font-size: 12px; color: var(--text-dim); line-height: 1.6; }
  .limitation-item.known { border-left-color: var(--amber); }
  .limitation-item strong { color: var(--text); }
</style>
</head>
<body>

<!-- ═══ EVENT COUNTDOWN BAR ═══ -->
<div id="event-countdown-bar">
  <div style="display:flex;flex-direction:column;gap:2px;">
    <div class="cdb-label"><span class="cdb-dot"></span>Market Event Incoming</div>
    <div class="cdb-event-title" id="cdb-event-title">—</div>
  </div>
  <div style="flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden;align-self:center;max-width:400px;">
    <div id="cdb-progress-bar" style="height:100%;background:var(--red);transition:width 1s linear;width:100%;"></div>
  </div>
  <div class="cdb-timer" id="cdb-timer">2:00</div>
</div>

<!-- ═══ BREAKING NEWS OVERLAY ═══ -->
<div id="breaking-news-overlay">
  <div class="bno-backdrop"></div>
  <div class="bno-scanlines"></div>
  <div class="bno-content">
    <div class="bno-breaking-tag">⚡ Breaking Market News</div>
    <div class="bno-headline" id="bno-headline"></div>
    <div class="bno-subline" id="bno-subline"></div>
    <div class="bno-impact-box">
      <div class="bno-impact-label">Expected Market Impact</div>
      <div class="bno-impact-text" id="bno-impact-text"></div>
    </div>
    <div class="bno-price-changes" id="bno-price-changes"></div>
    <button class="bno-dismiss" onclick="dismissBreakingNews()">▶ Continue Trading</button>
  </div>
</div>

<!-- ═══ INSIDER TIP OVERLAY ═══ -->
<div id="insider-tip-overlay">
  <div class="tip-card" id="tip-card">
    <div class="tip-card-header">
      <div class="tip-source-avatar" id="tip-avatar">??</div>
      <div>
        <div class="tip-source-name" id="tip-source-name">Source</div>
        <div class="tip-source-role" id="tip-source-role">Unknown</div>
      </div>
      <div class="tip-encrypted-tag">ENCRYPTED</div>
    </div>
    <div class="tip-card-body">
      <div class="tip-timestamp" id="tip-timestamp">Just now</div>
      <div class="tip-message" id="tip-message"></div>
      <div class="tip-hint" id="tip-hint"></div>
      <button class="tip-close-btn" onclick="closeTip()">◆ Acknowledge &amp; Close</button>
    </div>
  </div>
</div>

<!-- ═══ COMMODITY CHART MODAL ═══ -->
<div id="chart-modal">
  <div class="chart-modal-inner">
    <div class="chart-modal-header">
      <div>
        <div class="chart-commodity-name" id="chart-comm-name" style="color:var(--amber)">—</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:2px;" id="chart-comm-meta">—</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="text-align:right;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:22px;color:var(--amber);" id="chart-curr-price">—</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:11px;" id="chart-price-chg">—</div>
        </div>
        <button onclick="closeChartModal()" style="background:none;border:1px solid var(--border);color:var(--text-dim);padding:6px 12px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;">✕ CLOSE</button>
      </div>
    </div>
    <div class="chart-modal-body">
      <div class="chart-stats-row" id="chart-stats-row"></div>
      <div class="chart-tab-row">
        <button class="chart-tab active" onclick="switchChartTab('price',this)">Price History</button>
        <button class="chart-tab" onclick="switchChartTab('pct',this)">% Change</button>
        <button class="chart-tab" onclick="switchChartTab('volume',this)">Volatility</button>
      </div>
      <div style="position:relative;background:var(--black);border:1px solid var(--border);padding:10px;">
        <canvas id="commodityChart" height="260"></canvas>
      </div>
      <div class="chart-event-markers" id="chart-event-markers" style="margin-top:16px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;">Fired Events Affecting This Commodity</div>
        <div id="chart-event-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ EXECUTION RECEIPT TOAST ═══ -->
<div id="exec-receipt">
  <div class="receipt-header" id="receipt-header" style="color:var(--green)">▲ ORDER FILLED</div>
  <div id="receipt-rows"></div>
</div>

<div class="header">
  <div style="display:flex;align-items:center;gap:16px;">
    <div>
      <div class="logo">Commodity <span>Trading</span> Club</div>
      <div class="tagline">Full Day Simulation Framework · 4-Desk Structure</div>
    </div>
    <!-- KLU Hamburg Badge -->
    <div style="display:flex;align-items:center;gap:8px;padding:5px 12px;border:1px solid #1a2332;background:#0d1117;margin-left:4px;">
      <svg width="22" height="22" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="40" height="40" rx="2" fill="#002855"/>
        <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="#ffb300" font-family="Arial Black,sans-serif" font-size="13" font-weight="900">K</text>
      </svg>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:#c8d6e5;text-transform:uppercase;">Kühne Logistics University</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:#4a5568;letter-spacing:1px;">Hamburg · Commodity Trading Club</div>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="session-badge" id="sessionBadge">Pre-Market</div>
    <div class="clock" id="clock">08:30:00</div>
    <div title="Data auto-saved to browser" style="display:flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;">
      <span class="persist-dot" id="persist-dot"></span>
      <span id="persist-label">SAVED</span>
    </div>
  </div>
</div>

<div class="nav">
  <button class="tab live-tab active" onclick="showPage('live',this)">⬛ Live Sim <span class="tab-dot"></span></button>
  <button class="tab" onclick="showPage('overview',this)">Overview</button>
  <button class="tab" onclick="showPage('softs',this)">Softs & Hards</button>
  <button class="tab energy" onclick="showPage('energy',this)">Energy</button>
  <button class="tab agri" onclick="showPage('agri',this)">Agriculture</button>
  <button class="tab risk" onclick="showPage('risk',this)">Risk Desk</button>
  <button class="tab" onclick="showPage('scenarios',this)">Scenarios</button>
  <button class="tab" onclick="showPage('mechanics',this)">Mechanics</button>
  <button class="tab" onclick="showPage('debrief',this)">Debrief</button>
  <button class="tab" onclick="showPage('model',this)" style="color:var(--cyan);">⬡ Model</button>
  <button class="tab" onclick="showPage('about',this)" style="margin-left:auto;color:#4a5568;border-bottom:3px solid transparent;" id="tab-about">About</button>
</div>

<!-- ═══════════════════════════════ LIVE SIM PAGE ═══════════════════════════════ -->
<div class="page active" id="page-live">

  <!-- SCOREBOARD -->
  <div class="section-title cyan">Firmwide P&L Scoreboard</div>
  <div class="scoreboard">
    <div class="desk-score softs" id="score-softs">
      <div class="ds-name">Softs & Hards Desk</div>
      <div class="ds-pnl zero" id="pnl-softs">$0</div>
      <div class="ds-dll" id="dll-softs-text" style="color:var(--text-dim)">DLL: $0 / $150,000</div>
      <div class="dll-bar-wrap"><div class="dll-bar" id="dll-bar-softs" style="width:0%"></div></div>
      <div class="ds-meta" id="meta-softs">0 positions · 0 lots open</div>
    </div>
    <div class="desk-score energy" id="score-energy">
      <div class="ds-name">Energy Desk</div>
      <div class="ds-pnl zero" id="pnl-energy">$0</div>
      <div class="ds-dll" id="dll-energy-text" style="color:var(--text-dim)">DLL: $0 / $200,000</div>
      <div class="dll-bar-wrap"><div class="dll-bar" id="dll-bar-energy" style="width:0%"></div></div>
      <div class="ds-meta" id="meta-energy">0 positions · 0 lots open</div>
    </div>
    <div class="desk-score agri" id="score-agri">
      <div class="ds-name">Agriculture Desk</div>
      <div class="ds-pnl zero" id="pnl-agri">$0</div>
      <div class="ds-dll" id="dll-agri-text" style="color:var(--text-dim)">DLL: $0 / $150,000</div>
      <div class="dll-bar-wrap"><div class="dll-bar" id="dll-bar-agri" style="width:0%"></div></div>
      <div class="ds-meta" id="meta-agri">0 positions · 0 lots open</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="sim-controls">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;">Facilitator Controls</div>
    <button class="sim-btn amber" onclick="updateAllPnL()">↻ Refresh P&L</button>
    <button class="sim-btn blue" onclick="openPriceModal()">⬡ Override Prices</button>
    <button class="sim-btn red" onclick="generateEOD()">📋 EOD Report</button>
    <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="resetSim()">Reset Sim</button>
    <div style="display:flex;align-items:center;gap:8px;margin-left:auto;">
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--green);letter-spacing:1px;display:flex;align-items:center;gap:5px;">
        <span style="display:inline-block;width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1s infinite;"></span>
        LIVE FEED ACTIVE
      </div>
      <div class="sim-timer" id="sim-phase-label">Current Phase: Pre-Market</div>
    </div>
  </div>

  <div class="trade-panel">
    <!-- TRADE ENTRY -->
    <div>
      <div class="section-title">Trade Entry</div>
      <div class="trade-form">
        <div class="card-title">Execute Order</div>

        <!-- Order type selector -->
        <div class="order-type-row">
          <button class="order-type-btn active" id="ot-market" onclick="setOrderType('market')">Market</button>
          <button class="order-type-btn" id="ot-limit" onclick="setOrderType('limit')">Limit</button>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Desk</label>
            <select class="form-select" id="trade-desk" onchange="onDeskChange()">
              <option value="softs">Softs & Hards</option>
              <option value="energy">Energy</option>
              <option value="agri">Agriculture</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Commodity</label>
            <select class="form-select" id="trade-commodity" onchange="onCommChange()">
              <option value="Gold">Gold (10 oz/lot)</option>
              <option value="Copper">Copper (500 lbs/lot)</option>
              <option value="Coffee">Coffee (100 lbs/lot)</option>
              <option value="Sugar">Sugar (1,000 lbs/lot)</option>
              <option value="Cotton">Cotton (500 lbs/lot)</option>
              <option value="Silver">Silver (100 oz/lot)</option>
              <option value="WTI Crude">WTI Crude (100 bbl/lot)</option>
              <option value="Brent Crude">Brent Crude (100 bbl/lot)</option>
              <option value="Nat Gas">Nat Gas (1,000 MMBtu/lot)</option>
              <option value="Heating Oil">Heating Oil (42,000 gal/lot)</option>
              <option value="Corn">Corn (500 bu/lot)</option>
              <option value="Soybeans">Soybeans (500 bu/lot)</option>
              <option value="Wheat">Wheat (500 bu/lot)</option>
              <option value="Soy Meal">Soy Meal (100 ton/lot)</option>
              <option value="Live Cattle">Live Cattle (400 lbs/lot)</option>
            </select>
          </div>
        </div>

        <!-- Live Bid/Ask display -->
        <div class="bid-ask-display" id="bid-ask-display">
          <div class="bad-side bid">
            <div class="bad-label">Best Bid</div>
            <div class="bad-price bid" id="form-bid">—</div>
          </div>
          <div class="bad-side ask">
            <div class="bad-label">Best Ask</div>
            <div class="bad-price ask" id="form-ask">—</div>
          </div>
          <div class="bad-spread" id="form-spread" style="grid-column:1/-1;">Spread: —</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" id="price-label">Limit Price</label>
            <input class="form-input" type="number" id="trade-price" placeholder="0.00" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Lots</label>
            <input class="form-input" type="number" id="trade-lots" placeholder="1" min="1" max="20" oninput="updateMarginDisplay()">
          </div>
        </div>

        <!-- Margin requirement -->
        <div class="margin-req-display" id="margin-req-display">
          <span>Initial Margin (5%)</span>
          <span id="margin-req-val">—</span>
        </div>
        <div class="slippage-note" id="slippage-note">Market orders incur slippage · Limit orders fill at specified price</div>

        <div class="btn-row">
          <button class="btn-long" onclick="logTrade('L')">▲ BUY / LONG</button>
          <button class="btn-short" onclick="logTrade('S')">▼ SELL / SHORT</button>
        </div>
        <button class="btn-spread" onclick="openSpreadModal()">⇄ LOG SPREAD / MULTI-LEG TRADE</button>
      </div>

      <!-- OPEN POSITIONS -->
      <div class="section-title" style="margin-top:16px;">Open Positions</div>
      <div style="background:var(--panel);border:1px solid var(--border);overflow:auto;">
        <table class="positions-table" id="positions-table">
          <thead>
            <tr>
              <th>Desk</th><th>Commodity</th><th>Dir</th><th>Exec Price</th><th>Lots</th><th>Curr Price</th><th>Unreal P&L</th><th>Margin</th><th>Close</th>
            </tr>
          </thead>
          <tbody id="positions-body">
            <tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:16px;font-family:'Share Tech Mono',monospace;font-size:12px;">No open positions</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <!-- PRICE FEED -->
      <div class="section-title">Official Price Feed <span style="font-size:9px;color:var(--text-dim);font-family:'Share Tech Mono',monospace;">↗ CLICK COMMODITY FOR CHART</span></div>
      <div class="price-feed" id="price-feed-panel">
        <!-- generated by JS -->
      </div>

      <!-- ALERT FEED -->
      <div class="section-title" style="margin-top:16px;">Risk Alerts <span class="alert-badge" id="alert-badge">0</span></div>
      <div class="alert-feed">
        <div class="alert-feed-header">Live Risk Monitor Feed</div>
        <div class="alert-list" id="alert-list">
          <div class="alert-item info">
            <span class="alert-time">08:30</span>
            <span class="alert-msg">Simulation initialised. All desks at $0 P&L. Risk monitoring active.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TRADE BLOTTER -->
  <div class="section-title">Trade Blotter — All Logged Trades</div>
  <div class="blotter">
    <div class="blotter-header">
      <span>Time</span><span>Desk</span><span>Commodity</span><span>Dir</span><span>Lots</span><span>Entry</span><span>Exec</span><span>Slip</span><span>Curr</span><span>Unreal P&L</span>
    </div>
    <div class="blotter-body" id="blotter-body">
      <div class="blotter-empty">No trades logged. Use the trade entry form above to begin.</div>
    </div>
  </div>

  <!-- RISK ANALYTICS -->
  <div class="section-title red" style="margin-top:20px;">Risk Analytics <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;font-weight:400;text-transform:none;">95% Parametric VaR · 1-day holding period</span></div>
  <div class="risk-analytics-grid" id="risk-analytics-grid">
    <!-- filled by renderRiskAnalytics() -->
    <div class="ra-stat"><div class="ra-val" style="color:var(--text-dim)">—</div><div class="ra-lbl">Firmwide VaR</div><div class="ra-sub">Loading…</div></div>
    <div class="ra-stat"><div class="ra-val" style="color:var(--text-dim)">—</div><div class="ra-lbl">Firmwide Sharpe</div><div class="ra-sub">Since open</div></div>
    <div class="ra-stat"><div class="ra-val" style="color:var(--text-dim)">—</div><div class="ra-lbl">Total Notional</div><div class="ra-sub">Open positions</div></div>
    <div class="ra-stat"><div class="ra-val" style="color:var(--text-dim)">—</div><div class="ra-lbl">Margin Used</div><div class="ra-sub">5% initial</div></div>
  </div>
  <div style="background:var(--panel);border:1px solid var(--border);padding:12px 14px;margin-bottom:12px;">
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim);margin-bottom:10px;">VaR BY DESK</div>
    <div id="desk-var-rows">
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);padding:8px 0;">No open positions.</div>
    </div>
  </div>

  <!-- FUNDAMENTAL DRIVERS — INVENTORY & CURVE STRUCTURE -->
  <div class="section-title" style="margin-top:16px;">Fundamental Drivers <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;font-weight:400;text-transform:none;">Inventory Levels · Curve Structure · Supply Signals</span></div>
  <div class="inv-panel">
    <div class="inv-header">
      <div class="inv-header-title">Commodity Inventory Levels & Curve Structure</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);">Low inventory → Backwardation (spot premium) · High inventory → Contango (carry cost)</div>
    </div>
    <div class="inv-grid" id="inventory-grid">
      <!-- filled by renderInventory() -->
    </div>
  </div>

  <!-- SCENARIO FIRE PANEL -->
  <div class="section-title" style="margin-top:20px;">Facilitator — Fire Scenario Events</div>
  <div class="event-fire-panel">
    <div class="card-title">Click to inject a market event. A 2-minute countdown fires — then real price impacts hit automatically.</div>
    <div class="grid-2" style="margin-top:12px;">
      <div id="scenario-buttons-col1"></div>
      <div id="scenario-buttons-col2"></div>
    </div>
  </div>

  <!-- Morning Views -->
  <div class="section-title">Morning View Submissions</div>
  <div class="grid-3" id="morning-views-grid"></div>

</div><!-- /page-live -->

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: OVERVIEW -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-overview">
  <div class="section-title">Day Structure — Simulation Overview</div>
  <div class="grid-4" style="margin-bottom:24px;">
    <div class="stat-box"><div class="stat-value">4</div><div class="stat-label">Active Desks</div></div>
    <div class="stat-box"><div class="stat-value blue">6h</div><div class="stat-label">Sim Duration</div></div>
    <div class="stat-box"><div class="stat-value green">$10M</div><div class="stat-label">Notional Per Desk</div></div>
    <div class="stat-box"><div class="stat-value red">5+</div><div class="stat-label">Intraday Events</div></div>
  </div>
  <div class="grid-1-2">
    <div>
      <div class="section-title">Session Timeline</div>
      <div class="timeline">
        <div class="timeline-item"><div class="tl-time">08:30 – 09:00</div><div class="tl-title">Pre-Market Prep</div><div class="tl-body">Overnight review, position brief, risk limits set. Morning views submitted to facilitator.</div></div>
        <div class="timeline-item"><div class="tl-time">09:00 – 09:30</div><div class="tl-title">Morning Meeting</div><div class="tl-body">Each desk delivers 2-min morning view. Risk desk confirms limits. First trades begin.</div></div>
        <div class="timeline-item blue"><div class="tl-time blue">09:30 – 11:00</div><div class="tl-title">Session 1 — Opening</div><div class="tl-body">Live trading. First scenario events fire at 09:45 and 10:20.</div></div>
        <div class="timeline-item red"><div class="tl-time red">11:00 – 11:15</div><div class="tl-title">Mid-Morning Mark</div><div class="tl-body">Risk Desk publishes firmwide P&L snapshot. Alerts flagged.</div></div>
        <div class="timeline-item blue"><div class="tl-time blue">11:15 – 12:30</div><div class="tl-title">Session 2</div><div class="tl-body">Brazil frost event, China PMI. Highest volatility period.</div></div>
        <div class="timeline-item"><div class="tl-time">12:30 – 13:00</div><div class="tl-title">Lunch Break</div><div class="tl-body">No trading. Desks review positions and P&L.</div></div>
        <div class="timeline-item green"><div class="tl-time green">13:00 – 14:15</div><div class="tl-title">Session 3 — Final</div><div class="tl-body">OPEC surprise cut. Treasury auction failure. Desks manage into close.</div></div>
        <div class="timeline-item red"><div class="tl-time red">14:15 – 14:30</div><div class="tl-title">EOD Close</div><div class="tl-body">All positions marked. Final P&L locked. EOD report produced.</div></div>
        <div class="timeline-item"><div class="tl-time">14:30 – 15:30</div><div class="tl-title">Debrief</div><div class="tl-body">4-phase structured debrief. Awards. Learning capture.</div></div>
      </div>
    </div>
    <div>
      <div class="section-title">The Four Desks</div>
      <div style="display:grid;gap:12px;">
        <div class="role-card">
          <div class="role-name" style="color:var(--amber)">Softs & Hards Desk</div>
          <div class="role-desk">GOLD · SILVER · COPPER · COFFEE · SUGAR · COTTON</div>
          <div class="role-duties">Trades precious metals and soft commodities. Gold and silver respond to macro/USD; industrial metals (copper) track China growth. Soft commodities are weather and supply-chain driven. DLL: $150k. Max 15 lots, 5 per commodity.</div>
        </div>
        <div class="role-card">
          <div class="role-name" style="color:var(--blue)">Energy Desk</div>
          <div class="role-desk">WTI CRUDE · BRENT · NAT GAS · HEATING OIL</div>
          <div class="role-duties">Highest volatility desk. Focus: OPEC decisions, EIA inventory data, geopolitical risk, crack spreads. Brent/WTI spread trades are a key strategy. DLL: $200k. Max 12 lots, 70% concentration limit in crude.</div>
        </div>
        <div class="role-card">
          <div class="role-name" style="color:var(--green)">Agriculture Desk</div>
          <div class="role-desk">CORN · SOYBEANS · WHEAT · SOY MEAL · LIVE CATTLE</div>
          <div class="role-duties">Data-driven, USDA report dependent. Central trades: soy crush spread, corn/wheat substitution, old crop/new crop calendar. WASDE report at noon is the session-defining event. DLL: $150k. Max 15 lots, 4 per commodity.</div>
        </div>
        <div class="role-card">
          <div class="role-name" style="color:var(--red)">Risk Desk</div>
          <div class="role-desk">MONITOR · ENFORCE · REPORT</div>
          <div class="role-duties">Does not trade. Monitors all desks for DLL breaches, concentration limits, and intraday stop-out triggers. Issues alerts. Owns the EOD report. Has authority to force-close positions at 100% DLL.</div>
        </div>
      </div>
    </div>
  </div>
  <div class="section-title">Role Assignments (Per Desk)</div>
  <div class="grid-3">
    <div class="role-card"><div class="role-name" style="color:var(--amber)">Head Trader</div><div class="role-desk">DECISION MAKER</div><div class="role-duties">Final call on all trades. Sets the morning view. Manages desk P&L and limits. Speaks for the desk in morning meeting and debrief.</div></div>
    <div class="role-card"><div class="role-name" style="color:var(--amber)">Market Analyst</div><div class="role-desk">RESEARCH & SIGNALS</div><div class="role-duties">Tracks price feed, monitors macro events, reads scenario cards, and advises the Head Trader. Keeps the desk informed of cross-commodity signals.</div></div>
    <div class="role-card"><div class="role-name" style="color:var(--amber)">Trade Desk Associate</div><div class="role-desk">EXECUTION & LOGGING</div><div class="role-duties">Logs all trades in the app, tracks open positions, calculates real-time P&L, and monitors position limits for the desk.</div></div>
  </div>
  <div class="section-title" style="margin-top:8px;">Awards & Recognition</div>
  <div class="grid-4">
    <div class="stat-box"><div class="stat-value" style="font-size:28px;">🏆</div><div class="stat-label">Best Desk P&L</div></div>
    <div class="stat-box"><div class="stat-value red" style="font-size:28px;">⚡</div><div class="stat-label">Fastest Reaction</div></div>
    <div class="stat-box"><div class="stat-value green" style="font-size:28px;">🛡️</div><div class="stat-label">Best Risk Control</div></div>
    <div class="stat-box"><div class="stat-value" style="font-size:28px;color:var(--cyan);">💡</div><div class="stat-label">Best Trade Idea</div></div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: SOFTS & HARDS -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-softs">
  <div class="section-title">Softs & Hards Desk — Full Brief</div>
  <div class="grid-2">
    <div class="card">
      <div class="card-title">Desk Mandate</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.8;">The Softs & Hards desk spans two distinct universes: precious/industrial metals (gold, silver, copper) and agricultural soft commodities (coffee, sugar, cotton). Your edge is understanding cross-asset correlations — gold moves with macro risk sentiment and real yields, copper tracks China industrial demand, and soft commodities respond to weather and supply chain events. The desk is often the first to react to macro shocks (Fed, Treasury, DXY).</p>
    </div>
    <div class="card">
      <div class="card-title">Starting Universe</div>
      <table class="comm-table">
        <tr><th>Commodity</th><th>Exchange</th><th>Unit</th><th>Lot Size</th><th>Key Driver</th></tr>
        <tr><td class="commodity-name">Gold</td><td>COMEX</td><td>$/oz</td><td>10 oz</td><td class="neutral">Real yields / USD</td></tr>
        <tr><td class="commodity-name">Silver</td><td>COMEX</td><td>$/oz</td><td>100 oz</td><td class="neutral">Gold beta / industrial</td></tr>
        <tr><td class="commodity-name">Copper</td><td>COMEX</td><td>$/lb</td><td>500 lbs</td><td class="down">China PMI</td></tr>
        <tr><td class="commodity-name">Coffee</td><td>ICE</td><td>¢/lb</td><td>100 lbs</td><td class="up">Brazil weather</td></tr>
        <tr><td class="commodity-name">Sugar</td><td>ICE</td><td>¢/lb</td><td>1,000 lbs</td><td class="neutral">EM currencies</td></tr>
        <tr><td class="commodity-name">Cotton</td><td>ICE</td><td>¢/lb</td><td>500 lbs</td><td class="neutral">China textile demand</td></tr>
      </table>
    </div>
  </div>
  <div class="section-title">Pre-Market Checklist</div>
  <div class="grid-2">
    <div class="card">
      <div class="card-title">Metals Pre-Market</div>
      <ul class="checklist">
        <li>Check COMEX overnight gold — any major move? Check DXY (dollar index) direction</li>
        <li>Review US 10yr real yield — inverse correlation to gold is tight</li>
        <li>China PMI data — copper barometer for the day</li>
        <li>Fed speakers scheduled today? Any rate guidance?</li>
        <li>Silver/gold ratio — is silver cheap or expensive vs gold? (ratio trade)</li>
        <li>Copper LME inventories — rising stocks = bearish signal</li>
      </ul>
    </div>
    <div class="card">
      <div class="card-title">Softs Pre-Market</div>
      <ul class="checklist">
        <li>Brazil BRL/USD overnight — weak BRL = producers sell more = bearish coffee</li>
        <li>ICE coffee certified stocks — rising stocks cap upside</li>
        <li>Brazil weather forecast: any frost advisory for São Paulo or Minas Gerais?</li>
        <li>Sugar: India export quota news, Thailand harvest progress</li>
        <li>Cotton: US export sales, China import demand signals</li>
        <li>Position limits: max 5 lots per commodity, 15 lots total, DLL $150k</li>
      </ul>
    </div>
  </div>
  <div class="section-title">Key Structural Trades</div>
  <div class="grid-3">
    <div class="rule-block">
      <div class="rule-label amber">Gold/Silver Ratio Trade</div>
      The ratio trades between 70–90x historically. When ratio is high (silver cheap), long silver vs short gold. When ratio is low, reverse. A mean-reversion spread trade that doesn't require a macro view.
    </div>
    <div class="rule-block">
      <div class="rule-label amber">Copper as China Proxy</div>
      Copper is 55% China demand. If you have a view on Chinese growth (PMI, stimulus headlines), copper is your cleanest expression. Short copper on China slowdown fears; long on stimulus surprises.
    </div>
    <div class="rule-block">
      <div class="rule-label amber">Coffee — Frost Premium</div>
      Any frost advisory for Brazil's coffee belt = explosive upside. The 2021 frost sent prices +30% in two weeks. Size into frost news immediately — the window is short. Fade the spike once frost risk passes.
    </div>
  </div>
  <div class="section-title">Flashpoint Event — Gold & Real Yields</div>
  <div class="event-card">
    <div class="event-severity sev-high">■ HIGH IMPACT — WHEN FED SPEAK EVENT FIRES</div>
    <div class="event-title">Fed Governor Signals Rate Cut — Real Yields Fall</div>
    <div class="event-body">When the Fed Speak event fires (09:45), this is your moment. USD sells off, real yields drop — gold and silver rally hard. The question: how aggressive do you get? Gold +1.5–2% is typical. Silver usually outperforms gold in a rally (higher beta).</div>
    <div class="event-impact">Go long gold AND silver on the event. Watch the ratio. If copper is already positioned long by the desk, a USD sell-off confirms the view. Consider trimming copper if China PMI later disappoints.</div>
  </div>
  <div class="section-title">Morning View Template (Deliver at 09:00)</div>
  <div class="card">
    <div class="card-title">Softs & Hards Morning Statement — Fill In & Deliver Verbally</div>
    <div style="display:grid;gap:8px;font-size:13px;color:var(--text-dim);">
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(255,179,0,0.2);">📌 <strong style="color:var(--amber)">Metals View:</strong> Gold [Bull/Bear] — Target: $[X] | Silver [Bull/Bear] | Copper [Bull/Bear] — China view: [positive/negative]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(255,179,0,0.2);">📌 <strong style="color:var(--amber)">Softs View:</strong> Coffee [Bull/Bear] — Brazil weather: [Risk/Clear] | Sugar [Bull/Bear] | Cotton [Bull/Bear]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(255,179,0,0.2);">📌 <strong style="color:var(--amber)">Key Trade:</strong> [Describe your highest conviction trade for the day]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(255,179,0,0.2);">📌 <strong style="color:var(--text)">Risk Plan:</strong> Stop-out level: -$[X] | Hedge if Fed disappoints: [describe]</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: ENERGY -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-energy">
  <div class="section-title blue">Energy Desk — Full Brief</div>
  <div class="grid-2">
    <div class="card blue">
      <div class="card-title">Desk Mandate</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.8;">The Energy desk is the highest-volatility seat in the room. You trade crude oil (WTI and Brent), natural gas, and refined products (heating oil, crack spreads). Your daily P&L will swing more dramatically than any other desk. OPEC decisions, EIA inventory data, geopolitical risk, and weather (for nat gas) are your primary catalysts. The Brent/WTI spread and crack spread are core structural trades.</p>
    </div>
    <div class="card blue">
      <div class="card-title">Starting Universe</div>
      <table class="comm-table">
        <tr><th>Commodity</th><th>Exchange</th><th>Unit</th><th>Lot Size</th><th>Key Driver</th></tr>
        <tr><td class="commodity-name">WTI Crude</td><td>NYMEX</td><td>$/bbl</td><td>100 bbl</td><td class="neutral">OPEC / EIA stocks</td></tr>
        <tr><td class="commodity-name">Brent Crude</td><td>ICE</td><td>$/bbl</td><td>100 bbl</td><td class="neutral">Geopolitical risk</td></tr>
        <tr><td class="commodity-name">Nat Gas</td><td>NYMEX</td><td>$/MMBtu</td><td>1,000 MMBtu</td><td class="up">Weather / storage</td></tr>
        <tr><td class="commodity-name">Heating Oil</td><td>NYMEX</td><td>¢/gal</td><td>42,000 gal</td><td class="neutral">Winter demand</td></tr>
      </table>
    </div>
  </div>
  <div class="section-title blue">Pre-Market Checklist</div>
  <div class="grid-2">
    <div class="card blue">
      <div class="card-title">Crude Oil Pre-Market</div>
      <ul class="checklist">
        <li class="blue">API inventory data released last night — was it a build or draw? How does it compare to the 5yr average?</li>
        <li class="blue">Brent/WTI spread — is it wider or narrower than yesterday? What does this say about export demand?</li>
        <li class="blue">Any OPEC member statements overnight? Saudi Arabia or Russia headlines?</li>
        <li class="blue">Libya / Nigeria / Iraq production news — any outage or restart?</li>
        <li class="blue">USD index overnight — crude has an inverse correlation to the dollar</li>
        <li class="blue">EIA report today at 10:30 — consensus estimate for crude draw/build?</li>
      </ul>
    </div>
    <div class="card blue">
      <div class="card-title">Products & Nat Gas Pre-Market</div>
      <ul class="checklist">
        <li class="blue">Crack spread level: (2 × gasoline + heating oil − 3 × WTI) / 3 — is refining margin wide?</li>
        <li class="blue">Nat gas: NOAA 10-day weather outlook — heating degree days vs. 30yr norm?</li>
        <li class="blue">Nat gas storage report (Thursday) — stocks vs. 5yr avg?</li>
        <li class="blue">Position limits: max 12 lots total, 70% max in crude, DLL $200k, intraday stop -$100k</li>
        <li class="blue">Your biggest single risk: an OPEC surprise or EIA miss can move P&L by $50k+ in one event</li>
      </ul>
    </div>
  </div>
  <div class="section-title blue">Key Structural Trades</div>
  <div class="grid-3">
    <div class="rule-block blue">
      <div class="rule-label blue">Brent/WTI Spread</div>
      Brent typically trades at a premium to WTI due to export logistics. When geopolitical risk rises (Libya, Middle East), Brent widens vs WTI. Trade: long Brent / short WTI when risk spikes. Reverse when risk fades.
    </div>
    <div class="rule-block blue">
      <div class="rule-label blue">The Crack Spread</div>
      Long refined products vs short crude. Wide crack = buy the spread (refiners making money). Narrow crack = sell. The 3-2-1 crack: for every 3 barrels of crude, refiners produce 2 gasoline + 1 distillate.
    </div>
    <div class="rule-block blue">
      <div class="rule-label blue">EIA Inventory Play</div>
      At 10:30, you receive the EIA card. Consensus is –2.5Mb draw. You have 60 seconds before the room knows. A larger draw is bullish (buy), smaller/build is bearish (sell). Size reflects conviction and residual position.
    </div>
  </div>
  <div class="section-title blue">The EIA Report — Simulation's Biggest Energy Event</div>
  <div class="event-card blue">
    <div class="event-severity sev-high">■ HIGH IMPACT EVENT — 10:30 WEDNESDAY</div>
    <div class="event-title">EIA Weekly Petroleum Status Report</div>
    <div class="event-body">The facilitator will hand the Energy Desk a card at exactly 10:30 with the inventory number. Analysts expected a draw of 2.5Mb. The card shows the actual. The desk has 60 seconds to act before the number is announced to the room. Practice reading the number, computing the surprise, and trading conviction immediately. Speed matters.</div>
    <div class="event-impact blue">Consensus: –2.5Mb draw | If actual &gt; –3.5Mb → Bullish surprise → Buy crude aggressively | If actual &lt; –1.5Mb → Bearish miss → Sell</div>
  </div>
  <div class="section-title blue">Morning View Template (Deliver at 09:00)</div>
  <div class="card blue">
    <div class="card-title">Energy Desk Morning Statement</div>
    <div style="display:grid;gap:8px;font-size:13px;color:var(--text-dim);">
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(64,196,255,0.2);">📌 <strong style="color:var(--blue)">Crude View:</strong> [Bull/Bear] — WTI target: $[X] | Brent target: $[Y] | Max position: [Z] lots</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(64,196,255,0.2);">📌 <strong style="color:var(--blue)">Products View:</strong> Crack spread [widening/narrowing] — [Buy/Sell] the crack</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(64,196,255,0.2);">📌 <strong style="color:var(--blue)">Nat Gas View:</strong> [Bull/Bear] — Weather catalyst: [Yes/No] — Storage vs 5yr avg: [+/–]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(64,196,255,0.2);">📌 <strong style="color:var(--text)">Stop-out level:</strong> –$[X] | Hedge plan if EIA surprises bearish: [describe]</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: AGRICULTURE -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-agri">
  <div class="section-title green">Agriculture Desk — Full Brief</div>
  <div class="grid-2">
    <div class="card green">
      <div class="card-title">Desk Mandate</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.8;">The Agri desk trades the grain complex (corn, wheat, soybeans) and livestock. You are fundamentally driven by USDA reports, weather systems, export demand, and biofuels policy. Your edge is understanding the interdependency of the complex — corn competes with soybeans for acres, soy meal feeds livestock, and corn is the basis for ethanol. The crush spread and corn/wheat substitution are central trades.</p>
    </div>
    <div class="card green">
      <div class="card-title">Starting Universe</div>
      <table class="comm-table">
        <tr><th>Commodity</th><th>Exchange</th><th>Unit</th><th>Lot Size</th><th>Key Driver</th></tr>
        <tr><td class="commodity-name">Corn</td><td>CBOT</td><td>¢/bu</td><td>500 bu</td><td class="up">Acres/Ethanol</td></tr>
        <tr><td class="commodity-name">Soybeans</td><td>CBOT</td><td>¢/bu</td><td>500 bu</td><td class="up">China demand</td></tr>
        <tr><td class="commodity-name">Wheat (SRW)</td><td>CBOT</td><td>¢/bu</td><td>500 bu</td><td class="neutral">Black Sea supply</td></tr>
        <tr><td class="commodity-name">Soybean Meal</td><td>CBOT</td><td>$/ton</td><td>100 ton</td><td class="up">Feed demand</td></tr>
        <tr><td class="commodity-name">Live Cattle</td><td>CME</td><td>¢/lb</td><td>400 lbs</td><td class="neutral">Feedlot margins</td></tr>
      </table>
    </div>
  </div>
  <div class="section-title green">Pre-Market Checklist</div>
  <div class="grid-2">
    <div class="card green">
      <div class="card-title">Grains Pre-Market</div>
      <ul class="checklist">
        <li class="green">Check CBOT overnight session — any major moves vs last settlement?</li>
        <li class="green">Review weekly Export Sales report (released Thursday 8:30 AM)</li>
        <li class="green">Check Crop Progress report (USDA Monday 4pm — review next morning)</li>
        <li class="green">Brazil/Argentina weather — any drought or excessive rain forecasts?</li>
        <li class="green">Check corn/wheat spread: which is cheaper as a feed substitution?</li>
        <li class="green">Calculate the crush margin: Soybeans vs (meal + oil output)</li>
      </ul>
    </div>
    <div class="card green">
      <div class="card-title">Livestock Pre-Market</div>
      <ul class="checklist">
        <li class="green">Review USDA Cattle on Feed report (monthly — check if recent)</li>
        <li class="green">Check boxed beef cutout values — proxy for packer margins</li>
        <li class="green">Any pork export news to China or ASF (African Swine Fever) update?</li>
        <li class="green">Check corn prices — feedlot cost input for cattle traders</li>
        <li class="green">Position limits: max 4 lots per grain, 2 lots livestock, 10 lots total</li>
      </ul>
    </div>
  </div>
  <div class="section-title green">Key Structural Trades</div>
  <div class="grid-3">
    <div class="rule-block green">
      <div class="rule-label green">The Soy Crush</div>
      Long soybeans vs short soybean meal and soybean oil in the ratio 11:9:2. Represents crushing margin. Wide crush = profitable to crush = buy beans. Narrow crush = sell the complex.
    </div>
    <div class="rule-block green">
      <div class="rule-label green">Corn/Wheat Spread</div>
      When wheat is cheap relative to corn, feeders substitute wheat for corn — capping corn upside. Trading this ratio gives insight into feed demand switching and inter-grain competition.
    </div>
    <div class="rule-block green">
      <div class="rule-label green">Old Crop / New Crop</div>
      July (old crop) vs December (new crop) corn spread. If new crop is at a large discount, the market expects a big harvest. Widening = bearish production expectations.
    </div>
  </div>
  <div class="section-title green">USDA WASDE — Simulation's Agri Flashpoint</div>
  <div class="event-card green">
    <div class="event-severity sev-high">■ HIGH IMPACT EVENT — 12:00 NOON (MONTHLY)</div>
    <div class="event-title">USDA World Agricultural Supply and Demand Estimates (WASDE)</div>
    <div class="event-body">The facilitator will distribute a mock WASDE card at noon. It will show simulated corn, soy, and wheat ending stocks (in billion bushels). The desk's job is to immediately calculate whether the stocks number is bullish (below trade estimate) or bearish (above trade estimate) and act. The whole room watches this moment — this is where agri traders earn their reputation.</div>
    <div class="event-impact green">Pre-position your view before noon. Be ready to either confirm your trade or quickly reverse if the number shocks you. Reversing fast is a skill.</div>
  </div>
  <div class="section-title green">Morning View Template (Deliver at 09:00)</div>
  <div class="card green">
    <div class="card-title">Agriculture Desk Morning Statement</div>
    <div style="display:grid;gap:8px;font-size:13px;color:var(--text-dim);">
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(0,230,118,0.2);">📌 <strong style="color:var(--green)">Grains View:</strong> Corn [Bull/Bear] | Soybeans [Bull/Bear] | Wheat [Bull/Bear]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(0,230,118,0.2);">📌 <strong style="color:var(--green)">Crush Spread:</strong> Current margin: $[X]/MT | Direction: [Widening/Narrowing] | Trade: [Buy/Sell crush]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(0,230,118,0.2);">📌 <strong style="color:var(--green)">Livestock:</strong> Cattle [Bull/Bear] | Feed cost headwind: [High/Low]</div>
      <div style="padding:10px;background:#0a0e14;border:1px solid rgba(0,230,118,0.2);">📌 <strong style="color:var(--text)">WASDE Positioning:</strong> Pre-WASDE bias: [Long/Short/Flat] | Stop-out if wrong: $[X]</div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: RISK -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-risk">
  <div class="section-title red">Risk Desk — Full Brief</div>
  <div class="grid-2">
    <div class="card red">
      <div class="card-title">Risk Desk Mandate</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.8;">The Risk Desk does not trade. It is the guardian of firmwide capital. Your job is to monitor every desk's positions in real time, enforce limits, calculate aggregate exposure, and escalate problems before they become catastrophes. You own the EOD P&L report. The Head of Trading (facilitator) is your direct boss. In a real firm, the Risk Desk can override a trader's position — you have that power today.</p>
    </div>
    <div class="card red">
      <div class="card-title">Firm-Wide Limits</div>
      <table class="comm-table">
        <tr><th>Limit</th><th>Softs/Hards</th><th>Energy</th><th>Agri</th></tr>
        <tr><td>Daily Loss Limit</td><td class="down">-$150K</td><td class="down">-$200K</td><td class="down">-$150K</td></tr>
        <tr><td>Max Open Lots</td><td class="neutral">15 lots</td><td class="neutral">12 lots</td><td class="neutral">15 lots</td></tr>
        <tr><td>Single Commodity Max</td><td class="neutral">5 lots</td><td class="neutral">5 lots</td><td class="neutral">4 lots</td></tr>
        <tr><td>Concentration Limit</td><td class="neutral">60% one asset</td><td class="neutral">70% crude</td><td class="neutral">50% grains</td></tr>
        <tr><td>Intraday Stop-Out</td><td class="down">-$75K</td><td class="down">-$100K</td><td class="down">-$75K</td></tr>
      </table>
    </div>
  </div>
  <div class="section-title red">Risk Desk Workflow</div>
  <div class="timeline">
    <div class="timeline-item red"><div class="tl-time red">08:30 — PRE-MARKET</div><div class="tl-title">Receive Opening Position Sheet</div><div class="tl-body">Each desk submits their intended day-1 book to Risk before 09:00. Review for pre-existing concentration or limit breaches before any trade is executed.</div></div>
    <div class="timeline-item red"><div class="tl-time red">09:00 — OPEN</div><div class="tl-title">Begin Live Monitoring</div><div class="tl-body">Update P&L ledger every 10 minutes. Flag any desk within 50% of their DLL immediately.</div></div>
    <div class="timeline-item red"><div class="tl-time red">11:00 — MID-MORNING MARK</div><div class="tl-title">Publish Firmwide P&L Snapshot</div><div class="tl-body">Stand up and announce: each desk's current P&L, position count, and any limit proximity. Publicly name any desk at 75%+ of their DLL.</div></div>
    <div class="timeline-item red"><div class="tl-time red">EVENT RESPONSE</div><div class="tl-title">When a Scenario Event Fires</div><div class="tl-body">After any news event, re-mark positions at new prices. Did any desk move 20%+ of DLL in a single event? Issue a warning. Did any desk breach DLL? Issue a stop-out order immediately.</div></div>
    <div class="timeline-item red"><div class="tl-time red">14:15 — EOD MARK</div><div class="tl-title">Final Mark-to-Market and P&L Lock</div><div class="tl-body">Mark all positions at settlement prices. Produce the EOD P&L report. Present to the room at debrief. Use the EOD Report button in the Live Sim tab.</div></div>
  </div>
  <div class="section-title red">Escalation Protocol</div>
  <div class="grid-3">
    <div class="rule-block red"><div class="rule-label red">Yellow Alert — 50% DLL</div>Send a quiet verbal warning to the desk head. "You are at 50% of your daily limit. Suggest reducing size." Log the time and desk name.</div>
    <div class="rule-block red"><div class="rule-label red">Orange Alert — 75% DLL</div>Stand up and announce to the room. Desk must reduce open positions by 30% within 10 minutes or face forced liquidation. Notify facilitator.</div>
    <div class="rule-block red"><div class="rule-label red">Red Alert — 100% DLL</div>Immediate stop-out. Risk Desk instructs facilitator to close all desk positions at market. Desk is in "monitoring only" mode for remainder of day.</div>
  </div>
  <div class="section-title red">EOD Risk Report Template</div>
  <div class="card red"><div class="card-title">End of Day Report — Generated in Live Sim Tab</div><div style="font-family:'Share Tech Mono',monospace;font-size:12px;line-height:2;color:var(--text-dim);padding:10px;background:#0a0e14;border:1px solid rgba(255,23,68,0.2);">FIRMWIDE EOD RISK REPORT — [DATE]<br>──────────────────────────────────────<br>SOFTS/HARDS DESK: P&L: $[X] | Peak pos: [N] lots | Alerts: [N]<br>ENERGY DESK:      P&L: $[X] | Peak pos: [N] lots | Alerts: [N]<br>AGRI DESK:        P&L: $[X] | Peak pos: [N] lots | Alerts: [N]<br>──────────────────────────────────────<br>FIRMWIDE P&L:     $[TOTAL]<br>BIGGEST WIN:      [Commodity + Desk + $Amount]<br>BIGGEST LOSS:     [Commodity + Desk + $Amount]<br>RISK EVENTS:      [N alerts issued | N stop-outs]<br>──────────────────────────────────────<br>→ Click "EOD Report" on Live Sim tab to auto-generate this.</div></div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: SCENARIOS -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-scenarios">
  <div class="section-title">Intraday Scenario Deck — Facilitator Cards</div>
  <p style="font-size:13px;color:var(--text-dim);margin-bottom:20px;">The facilitator draws from this deck throughout the day. Each card is handed to the relevant desk or announced to all. Desks should react within 2 minutes. Use 5–7 events per session, spaced 15–25 minutes apart. Fire events live using the <strong style="color:var(--cyan)">Live Sim → Fire Scenario Events</strong> panel.</p>
  <div class="section-title blue">Session 1 Events (09:30 – 11:00)</div>
  <div class="event-card blue"><div class="event-severity sev-high">■ EVENT 1 — 09:45 | ALL DESKS</div><div class="event-title">Surprise Fed Speak: Rate Cut Expectations Surge</div><div class="event-body">Fed Governor speaks at a conference and signals the committee is "open to adjusting policy sooner than markets expect." US Dollar sells off sharply. Real yields fall. Risk appetite rises across markets.</div><div class="event-impact blue">ENERGY: Crude typically rallies 1–2% on USD weakness. METALS: Gold and silver rally. SOFTS: Slight positive for EM crop exporters. AGRI: Minimal direct impact unless grain exports become more competitive.</div></div>
  <div class="event-card"><div class="event-severity sev-med">■ EVENT 2 — 10:20 | ENERGY DESK</div><div class="event-title">Libyan Oil Field Shut Due to Militia Activity</div><div class="event-body">Reports emerge that the Es Sider oil terminal in Libya has been shut by militia forces. Production loss estimated at 300,000 barrels per day. Situation unclear — could resolve within hours or days.</div><div class="event-impact">CRUDE: Brent typically leads upside (+$1.50–$3). WTI follows. How much you trade depends on conviction about the duration of the outage. Do you chase it or fade the spike?</div></div>
  <div class="section-title blue">Session 2 Events (11:15 – 12:30)</div>
  <div class="event-card green"><div class="event-severity sev-high">■ EVENT 3 — 11:30 | AGRI DESK + SOFTS</div><div class="event-title">Brazil — Frost Warning Issued for São Paulo State Coffee Belt</div><div class="event-body">Brazilian meteorological agency issues a frost advisory covering key Arabica coffee growing regions. Temperatures forecast to drop to -2°C overnight for 3 consecutive nights. Last major frost in 2021 sent coffee prices up 30% in two weeks.</div><div class="event-impact green">COFFEE: Potentially explosive move upward. Softs desk should be very active. How much is already priced in? How do you size in without chasing?</div></div>
  <div class="event-card"><div class="event-severity sev-med">■ EVENT 4 — 12:00 | ALL DESKS</div><div class="event-title">China PMI Disappoints — Manufacturing Contraction Deepens</div><div class="event-body">China's official NBS manufacturing PMI prints at 47.8, well below the 49.5 consensus and deep in contraction territory. This is the worst reading in 14 months. Global growth fears resurface.</div><div class="event-impact">COPPER: Sells off hard (China = 55% of global copper demand). ENERGY: Crude sells off on demand concerns. GOLD: Could rally as safe-haven bid. GRAINS: Soybean exports to China at risk. SOFTS: Cotton and sugar weaken.</div></div>
  <div class="section-title green">Session 3 Events (13:00 – 14:15)</div>
  <div class="event-card"><div class="event-severity sev-med">■ EVENT 5 — 13:15 | AGRI DESK</div><div class="event-title">USDA Export Inspections — Corn Shipments Miss Target</div><div class="event-body">Weekly USDA Export Inspections show corn inspections of 32 million bushels, below the 41 million needed weekly to meet full-year export targets. Brazil continues to take market share from US corn. Year-to-date pace now 8% below last year.</div><div class="event-impact green">CORN: Bearish demand signal — typically –5 to –15 cents. Soybeans may follow if China is seen as redirecting purchases to Brazil. Consider whether to reduce long grain positions.</div></div>
  <div class="event-card blue"><div class="event-severity sev-high">■ EVENT 6 — 13:45 | ALL DESKS</div><div class="event-title">OPEC+ Emergency Statement — Additional 500,000 bbl/d Cut Announced</div><div class="event-body">Saudi Arabia and Russia release a joint statement announcing a voluntary production cut of 500,000 barrels per day effective next month. Markets had not priced this in. The statement is brief and leaves duration unclear.</div><div class="event-impact blue">CRUDE: Explosive upside. WTI +$3–6 typical on this kind of surprise. Energy desk — this is your moment. How big is your position? Do you add into the spike? AGRI: Indirect inflation impulse.</div></div>
  <div class="event-card red"><div class="event-severity sev-high">■ EVENT 7 — 14:00 | ALL DESKS — FINAL EVENT</div><div class="event-title">Surprise: US Treasury Auction Fails — Yields Surge</div><div class="event-body">A 10-year US Treasury auction sees the weakest demand in five years. Bid-to-cover ratio collapses. US 10yr yields jump 20bps in 10 minutes. The dollar strengthens sharply. Risk assets sell off across the board.</div><div class="event-impact">GOLD: Sells off despite being a safe-haven (rising real yields dominate). COMMODITIES: Broad sell-off across metals, energy, soft commodities. With only 15 minutes to close, who cuts fast and who freezes?</div></div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: MECHANICS -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-mechanics">
  <div class="section-title">Simulation Mechanics & Setup Guide</div>
  <div class="grid-2">
    <div>
      <div class="section-title">Capital & Position Rules</div>
      <div class="rule-block"><div class="rule-label amber">Starting Capital Per Desk</div>Each desk starts with $10,000,000 notional capital. This is not real cash — it represents your trading book. Position sizes are expressed in "lots" (contracts).</div>
      <div class="rule-block"><div class="rule-label amber">Simplified Contract Sizes (For Sim)</div>Crude Oil: 100 bbl/lot · Nat Gas: 1,000 MMBtu · Corn: 500 bushels · Soybeans: 500 bushels · Wheat: 500 bushels · Gold: 10 oz · Copper: 500 lbs · Coffee: 100 lbs · Sugar: 1,000 lbs</div>
      <div class="rule-block"><div class="rule-label amber">Bid/Offer Spread</div>The facilitator charges 1 tick bid/offer on all trades to simulate transaction costs. If you buy at $80.00 crude, you're immediately down $0.10/bbl × lots × 100 bbl.</div>
      <div class="rule-block"><div class="rule-label amber">Trade Execution</div>To trade, call out: "ENERGY DESK — BUY 3 LOTS WTI AT MARKET." The facilitator confirms or rejects (if over limits). Trades are logged in the Live Sim tab immediately.</div>
    </div>
    <div>
      <div class="section-title">Tools & Setup</div>
      <div class="rule-block blue"><div class="rule-label blue">Price Feed</div>Facilitator updates the "Official Price Sheet" in the Live Sim tab every 10 minutes. All P&L is calculated from that official sheet — not from personal devices.</div>
      <div class="rule-block blue"><div class="rule-label blue">P&L Tracking</div>All P&L is tracked in the Live Sim tab. Risk Desk monitors the scoreboard. Positions table shows all open trades with live unrealised P&L vs current price.</div>
      <div class="rule-block blue"><div class="rule-label blue">Communication Rules</div>Desks may talk to each other for interdesk trades. All interdesk trades go through the facilitator. No phone use for looking up prices — use only the official price feed in this app.</div>
      <div class="rule-block blue"><div class="rule-label blue">Physical Setup</div>Arrange desks in a U-shape. Facilitator stands at the front with this app on a projector. Each desk has a printed desk brief. Scenario cards are physically handed out by the facilitator.</div>
    </div>
  </div>
  <div class="section-title">Awards & Recognition</div>
  <div class="grid-4">
    <div class="stat-box"><div class="stat-value" style="font-size:28px;">🏆</div><div class="stat-label">Best Desk P&L</div></div>
    <div class="stat-box"><div class="stat-value red" style="font-size:28px;">⚡</div><div class="stat-label">Fastest Reaction</div></div>
    <div class="stat-box"><div class="stat-value green" style="font-size:28px;">🛡️</div><div class="stat-label">Best Risk Control</div></div>
    <div class="stat-box"><div class="stat-value" style="font-size:28px;color:var(--cyan);">💡</div><div class="stat-label">Best Trade Idea</div></div>
  </div>
  <div class="section-title">Rotation Schedule</div>
  <div class="card"><div class="card-title">Recommended Role Rotation (Multi-Session)</div><p style="font-size:13px;color:var(--text-dim);line-height:1.8;">Run the simulation across multiple club sessions. Each session, rotate roles so everyone experiences all desks including Risk. Suggested order: Session 1 → Agri desk (most data-driven, good for beginners). Session 2 → Energy (highest volatility, builds fast decision-making). Session 3 → Softs/Hards (cross-asset complexity). Session 4 → Risk Desk (forces a completely different mindset). Session 5+ → Full rotation, increase scenario complexity, add interdesk trades and credit lines.</p></div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: DEBRIEF -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-debrief">
  <div class="section-title">Structured Debrief — 14:30 to 15:30</div>
  <p style="font-size:13px;color:var(--text-dim);margin-bottom:20px;">The debrief is where 80% of the learning happens. Run it in four phases. The Risk Desk leads with the EOD report, then rotate through the desks. Facilitator asks the questions below — no one is allowed to stay silent.</p>
  <div class="grid-2">
    <div>
      <div class="section-title red">Phase 1 — Risk Desk Report (10 min)</div>
      <div class="timeline">
        <div class="timeline-item red"><div class="tl-time red">STEP 1</div><div class="tl-title">Risk Desk reads the EOD report</div><div class="tl-body">P&L by desk, peak positions, alerts issued, breaches, firmwide P&L. Generated automatically in Live Sim tab.</div></div>
        <div class="timeline-item red"><div class="tl-time red">STEP 2</div><div class="tl-title">Announce the day's Best and Worst trade</div><div class="tl-body">The single biggest winning trade and the biggest losing trade — named by desk and commodity.</div></div>
        <div class="timeline-item red"><div class="tl-time red">STEP 3</div><div class="tl-title">Risk Desk verdict</div><div class="tl-body">Did any desk take reckless risk? Was any desk too conservative? Was risk management tight enough?</div></div>
      </div>
      <div class="section-title" style="margin-top:20px;">Phase 2 — Desk-by-Desk (30 min)</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">Each desk gets 7–8 minutes. Facilitator asks these questions:</p>
      <div class="debrief-q">What was your original morning view and how close did you stick to it?</div>
      <div class="debrief-q blue">Which event surprised you most? How did you react — and was that reaction right?</div>
      <div class="debrief-q green">What was your best trade today — what gave you conviction?</div>
      <div class="debrief-q red">What was your worst trade — what would you do differently?</div>
      <div class="debrief-q">Did you ever feel emotional about a losing position? How did that affect your decisions?</div>
      <div class="debrief-q blue">Did you know what the other desks were doing? Should you have paid more attention to cross-commodity signals?</div>
    </div>
    <div>
      <div class="section-title">Phase 3 — Cross-Desk Discussion (15 min)</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:12px;">Full room discussion. Facilitator leads:</p>
      <div class="debrief-q">When China PMI disappointed — how did each desk react differently? Were the fastest movers right?</div>
      <div class="debrief-q blue">Did the OPEC cut surprise help or hurt desks already long? What does that say about position sizing into event risk?</div>
      <div class="debrief-q green">What was the correlation between gold and crude today? Did anyone exploit this?</div>
      <div class="debrief-q red">The Treasury auction failure at 14:00 — who cut positions fastest and who held on? Who was right?</div>
      <div class="debrief-q">If you could redesign your desk's morning brief, what would you add?</div>
      <div class="section-title" style="margin-top:20px;">Phase 4 — Awards & Learning Capture (5 min)</div>
      <div class="card" style="margin-bottom:12px;">
        <div class="card-title">Award Categories</div>
        <ul class="checklist">
          <li><strong style="color:var(--amber)">Best P&L Desk</strong> — Highest total P&L, risk-adjusted</li>
          <li class="blue"><strong style="color:var(--blue)">Fastest Reactor</strong> — Best response to a news event (voted by room)</li>
          <li class="green"><strong style="color:var(--green)">Best Discipline</strong> — Desk that best managed limits without sacrificing returns</li>
          <li class="red"><strong style="color:var(--red)">Worst Hold</strong> — The trade everyone should have cut but didn't (educational)</li>
          <li><strong style="color:var(--cyan)">Best Trade Thesis</strong> — Most insightful morning view or spread trade (voted by room)</li>
        </ul>
      </div>
      <div class="section-title">Key Lessons to Reinforce</div>
      <div class="rule-block"><div class="rule-label amber">Position Sizing</div>Most new traders lose money not because they're wrong about direction — they're wrong about size. How many desks over-concentrated on a single commodity?</div>
      <div class="rule-block blue"><div class="rule-label blue">Speed vs. Precision</div>In fast-moving events (OPEC, EIA), you can't wait for perfect information. The skill is making good-enough decisions fast.</div>
      <div class="rule-block green"><div class="rule-label green">Cross-Commodity Signals</div>Commodities don't move in isolation. The China PMI hit copper AND soybeans AND crude — did anyone connect the dots fast?</div>
    </div>
  </div>
  <!-- EOD Report output -->
  <div class="section-title" style="margin-top:20px;">Auto-Generated EOD Report</div>
  <div id="debrief-eod-placeholder" style="color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:12px;padding:16px;background:#0a0e14;border:1px solid var(--border);">No EOD report generated yet. Go to Live Sim tab and click "EOD Report" to generate.</div>
  <div id="debrief-eod-report" style="display:none;"></div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- MODALS -->
<!-- ═══════════════════════════════════════════════════ -->

<!-- Price Update Modal -->
<div class="modal-overlay" id="modal-price">
  <div class="modal blue">
    <div class="modal-header">
      <div class="modal-title">Update Official Prices</div>
      <button class="modal-close" onclick="closeModal('modal-price')">✕</button>
    </div>
    <div class="modal-body" id="price-modal-body">
      <!-- generated dynamically -->
    </div>
    <div class="modal-footer">
      <button class="sim-btn blue" onclick="applyPrices()">Apply Prices & Refresh P&L</button>
      <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="closeModal('modal-price')">Cancel</button>
    </div>
  </div>
</div>

<!-- EOD Report Modal -->
<div class="modal-overlay" id="modal-eod">
  <div class="modal red" style="max-width:720px;">
    <div class="modal-header">
      <div class="modal-title">EOD Risk Report</div>
      <button class="modal-close" onclick="closeModal('modal-eod')">✕</button>
    </div>
    <div class="modal-body" id="eod-modal-body"></div>
    <div class="modal-footer">
      <button class="sim-btn amber" onclick="copyEOD()">Copy Report</button>
      <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="closeModal('modal-eod')">Close</button>
    </div>
  </div>
</div>

<!-- Event Fire Modal -->
<div class="modal-overlay" id="modal-event">
  <div class="modal" id="modal-event-inner">
    <div class="modal-header">
      <div class="modal-title" id="modal-event-title">Event</div>
      <button class="modal-close" onclick="closeModal('modal-event')">✕</button>
    </div>
    <div class="modal-body" id="modal-event-body"></div>
    <div class="modal-footer">
      <button class="sim-btn amber" id="modal-event-fire-btn">🔥 Fire This Event</button>
      <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="closeModal('modal-event')">Cancel</button>
    </div>
  </div>
</div>

<!-- Spread Trade Modal -->
<div class="modal-overlay" id="modal-spread">
  <div class="modal cyan" style="max-width:680px;">
    <div class="modal-header">
      <div class="modal-title">⇄ Log Spread / Multi-Leg Trade</div>
      <button class="modal-close" onclick="closeModal('modal-spread')">✕</button>
    </div>
    <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
      <div class="form-row" style="margin-bottom:14px;">
        <div class="form-group">
          <label class="form-label">Spread Template</label>
          <select class="form-select" id="spread-template-sel" onchange="renderSpreadLegs()"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Desk</label>
          <select class="form-select" id="spread-desk-sel">
            <option value="softs">Softs & Hards</option>
            <option value="energy">Energy</option>
            <option value="agri">Agriculture</option>
          </select>
        </div>
      </div>
      <div id="spread-legs-container"></div>
      <div style="background:rgba(0,229,255,0.04);border:1px solid rgba(0,229,255,0.15);padding:10px 12px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:6px;">
        Each leg is logged as a separate trade but grouped in the blotter under the same spread ID. Close each leg individually or use the position table.
      </div>
    </div>
    <div class="modal-footer">
      <button class="sim-btn cyan" onclick="logSpreadTrade()">⇄ Log All Legs</button>
      <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="closeModal('modal-spread')">Cancel</button>
    </div>
  </div>
</div>

<script>
(function() {
// ═══ MISSING cyan sim-btn style ═══
const style = document.createElement('style');
style.textContent = '.sim-btn.cyan{color:var(--cyan);border-color:var(--cyan)}.sim-btn.cyan:hover{background:var(--cyan);color:var(--black)}';
document.head.appendChild(style);
})();
</script>
<!-- Morning View Modal -->
<div class="modal-overlay" id="modal-morning">
  <div class="modal" id="modal-morning-inner" style="max-width:650px;">
    <div class="modal-header">
      <div class="modal-title" id="modal-morning-title">Morning View</div>
      <button class="modal-close" onclick="closeModal('modal-morning')">✕</button>
    </div>
    <div class="modal-body" id="modal-morning-body"></div>
    <div class="modal-footer">
      <button class="sim-btn green" id="modal-morning-submit">✓ Submit Morning View</button>
      <button class="sim-btn" style="color:var(--text-dim);border-color:var(--border);" onclick="closeModal('modal-morning')">Cancel</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════ STATE ═══════════════════════
const DESKS = {
  softs: { name: 'Softs & Hards', dll: 150000, stopOut: 75000, maxLots: 15 },
  energy: { name: 'Energy', dll: 200000, stopOut: 100000, maxLots: 12 },
  agri: { name: 'Agriculture', dll: 150000, stopOut: 75000, maxLots: 15 }
};

const CONTRACT_SIZES = {
  'Gold': 10, 'Silver': 100, 'Copper': 500, 'Coffee': 100,
  'Sugar': 1000, 'Cotton': 500, 'WTI Crude': 100, 'Brent Crude': 100,
  'Nat Gas': 1000, 'Heating Oil': 42000, 'Corn': 500, 'Soybeans': 500,
  'Wheat': 500, 'Soy Meal': 100, 'Live Cattle': 400
};

const DEFAULT_PRICES = {
  'Gold': 2320.0, 'Silver': 27.50, 'Copper': 4.12, 'Coffee': 185.0,
  'Sugar': 22.5, 'Cotton': 82.0, 'WTI Crude': 80.50, 'Brent Crude': 84.20,
  'Nat Gas': 2.65, 'Heating Oil': 255.0, 'Corn': 450.0, 'Soybeans': 1180.0,
  'Wheat': 540.0, 'Soy Meal': 350.0, 'Live Cattle': 182.0
};

// ═══════════════════════ PRICE MODEL PARAMETERS ═══════════════════════
// Hybrid GBM + Ornstein-Uhlenbeck parameters per commodity
// drift: % annualised directional bias (μ)
// vol:   % per tick (σ_tick) — annualised σ = vol * √(120 ticks/hr * 6.5 hr/day * 252)
// mr (θ): OU mean-reversion speed toward session open price
// spread_bps: bid/ask half-spread in basis points
// slip_base: base slippage % for 1-lot market order
// commission: $ per lot transaction cost
const DRIFT_PROFILES = {
  'Gold':        { drift: +0.08, vol: 0.04, mr: 0.010, min_pct: 0.85, max_pct: 1.18, spread_bps: 5,  slip_base: 0.03, commission: 2.50 },
  'Silver':      { drift: +0.12, vol: 0.07, mr: 0.015, min_pct: 0.80, max_pct: 1.22, spread_bps: 8,  slip_base: 0.05, commission: 1.50 },
  'Copper':      { drift: -0.05, vol: 0.06, mr: 0.012, min_pct: 0.82, max_pct: 1.20, spread_bps: 10, slip_base: 0.04, commission: 2.00 },
  'Coffee':      { drift: +0.10, vol: 0.09, mr: 0.008, min_pct: 0.75, max_pct: 1.30, spread_bps: 12, slip_base: 0.06, commission: 1.00 },
  'Sugar':       { drift: +0.04, vol: 0.05, mr: 0.010, min_pct: 0.85, max_pct: 1.18, spread_bps: 10, slip_base: 0.04, commission: 0.50 },
  'Cotton':      { drift: -0.03, vol: 0.04, mr: 0.012, min_pct: 0.88, max_pct: 1.15, spread_bps: 14, slip_base: 0.05, commission: 1.00 },
  'WTI Crude':   { drift: +0.06, vol: 0.08, mr: 0.010, min_pct: 0.78, max_pct: 1.22, spread_bps: 4,  slip_base: 0.03, commission: 3.00 },
  'Brent Crude': { drift: +0.07, vol: 0.08, mr: 0.010, min_pct: 0.78, max_pct: 1.22, spread_bps: 4,  slip_base: 0.03, commission: 3.00 },
  'Nat Gas':     { drift: -0.08, vol: 0.14, mr: 0.008, min_pct: 0.65, max_pct: 1.40, spread_bps: 18, slip_base: 0.08, commission: 2.00 },
  'Heating Oil': { drift: +0.05, vol: 0.07, mr: 0.010, min_pct: 0.80, max_pct: 1.22, spread_bps: 12, slip_base: 0.05, commission: 2.50 },
  'Corn':        { drift: -0.04, vol: 0.05, mr: 0.012, min_pct: 0.85, max_pct: 1.18, spread_bps: 8,  slip_base: 0.04, commission: 1.50 },
  'Soybeans':    { drift: +0.03, vol: 0.06, mr: 0.010, min_pct: 0.82, max_pct: 1.20, spread_bps: 9,  slip_base: 0.04, commission: 1.50 },
  'Wheat':       { drift: +0.02, vol: 0.07, mr: 0.009, min_pct: 0.80, max_pct: 1.22, spread_bps: 10, slip_base: 0.05, commission: 1.50 },
  'Soy Meal':    { drift: +0.04, vol: 0.06, mr: 0.010, min_pct: 0.82, max_pct: 1.20, spread_bps: 11, slip_base: 0.04, commission: 1.50 },
  'Live Cattle': { drift: +0.01, vol: 0.03, mr: 0.015, min_pct: 0.90, max_pct: 1.12, spread_bps: 16, slip_base: 0.06, commission: 2.00 },
};

// Correlation matrix (simplified — shared shock factor)
// Group A: energy cluster; Group B: grains cluster; Group C: metals cluster
const CORR_GROUPS = {
  energy:  ['WTI Crude','Brent Crude','Heating Oil','Nat Gas'],
  metals:  ['Gold','Silver','Copper'],
  softs:   ['Coffee','Sugar','Cotton'],
  grains:  ['Corn','Soybeans','Wheat','Soy Meal'],
  livestock: ['Live Cattle'],
};

let _driftInterval = null;
let _driftTick = 0;

// ── Chart data structures — declared here so driftTick can reference them ──
const PRICE_HISTORY = {};
const MAX_HISTORY = 240; // 2 hours at 30s ticks
const EVENT_MARKERS = []; // {tick, comm, label, pct, color}

// ═══════════════════════ BOX-MULLER NORMAL SAMPLER ═══════════════════════
// Generates standard normal random variates for GBM
// Box-Muller transform: exact N(0,1) from two uniform samples
function randn() {
  let u, v;
  do { u = Math.random(); v = Math.random(); } while (u === 0);
  return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}

// ═══════════════════════ INVENTORY ENGINE ═══════════════════════
// Initial inventory levels (% of capacity, 0–100)
const INVENTORY_INIT = {
  'Gold': 55, 'Silver': 48, 'Copper': 62, 'Coffee': 38, 'Sugar': 71, 'Cotton': 44,
  'WTI Crude': 52, 'Brent Crude': 49, 'Nat Gas': 67, 'Heating Oil': 58,
  'Corn': 41, 'Soybeans': 55, 'Wheat': 63, 'Soy Meal': 46, 'Live Cattle': 72,
};
// Supply/demand imbalance per tick (% of capacity). Positive = supply > demand (inventory builds)
const INVENTORY_DYNAMICS = {
  'Gold': { mu: 0.0, vol: 0.15 }, 'Silver': { mu: -0.02, vol: 0.18 },
  'Copper': { mu: -0.03, vol: 0.20 }, 'Coffee': { mu: -0.05, vol: 0.25 },
  'Sugar': { mu: +0.04, vol: 0.18 }, 'Cotton': { mu: -0.02, vol: 0.15 },
  'WTI Crude': { mu: -0.04, vol: 0.22 }, 'Brent Crude': { mu: -0.03, vol: 0.22 },
  'Nat Gas': { mu: +0.06, vol: 0.30 }, 'Heating Oil': { mu: -0.02, vol: 0.20 },
  'Corn': { mu: -0.04, vol: 0.20 }, 'Soybeans': { mu: -0.03, vol: 0.22 },
  'Wheat': { mu: +0.02, vol: 0.25 }, 'Soy Meal': { mu: -0.03, vol: 0.20 },
  'Live Cattle': { mu: +0.05, vol: 0.12 },
};
// Inventory state — persists through session
const INVENTORY = { ...INVENTORY_INIT };

function getInventoryPressure(comm) {
  const inv = INVENTORY[comm];
  if (inv < 20) return +0.05;   // severe supply squeeze → extra positive drift
  if (inv < 30) return +0.025;
  if (inv > 80) return -0.03;   // oversupply → negative drift pressure
  if (inv > 70) return -0.015;
  return 0;
}

function getCurveStructure(comm) {
  const inv = INVENTORY[comm];
  if (inv < 30) return 'backwardation';
  if (inv > 70) return 'contango';
  return 'flat';
}

function tickInventory() {
  for (const comm of Object.keys(INVENTORY)) {
    const dyn = INVENTORY_DYNAMICS[comm];
    const change = dyn.mu + dyn.vol * randn() * 0.3; // scale down for 30s ticks
    INVENTORY[comm] = Math.max(5, Math.min(95, INVENTORY[comm] + change));
  }
}

// ═══════════════════════ BID/ASK ENGINE ═══════════════════════
function getBidAsk(comm) {
  const prof = DRIFT_PROFILES[comm];
  const mid = state.prices[comm];
  const halfSpread = mid * (prof.spread_bps / 10000) / 2;
  return { bid: mid - halfSpread, ask: mid + halfSpread, spread: halfSpread * 2 };
}

function calcSlippage(comm, lots, dir) {
  const prof = DRIFT_PROFILES[comm];
  // Square-root market impact model: slippage grows with sqrt(size)
  const slipPct = prof.slip_base * Math.sqrt(lots) / 100;
  const mid = state.prices[comm];
  // Long orders push price up, short orders push price down
  return dir === 'L' ? mid * slipPct : -(mid * slipPct);
}

function getExecPrice(comm, lots, dir, orderType, limitPrice) {
  if (orderType === 'limit') return limitPrice;
  const { bid, ask } = getBidAsk(comm);
  const base = dir === 'L' ? ask : bid;
  const slip = calcSlippage(comm, lots, dir);
  return base + slip;
}

// ═══════════════════════ GBM + OU PRICE ENGINE ═══════════════════════
const DT = 1 / 120; // 30s tick as fraction of 1 hour

function startPriceDrift() {
  if (_driftInterval) return; // already running
  _driftInterval = setInterval(driftTick, 30000); // every 30s
}

function driftTick() {
  _driftTick++;

  // ── Generate group (correlated) shocks using Box-Muller ──
  const groupShocks = {};
  for (const grp of Object.keys(CORR_GROUPS)) {
    groupShocks[grp] = randn() * 0.0003; // ±~0.03% group shock
  }

  // ── Update inventory each tick ──
  if (_driftTick % 2 === 0) tickInventory(); // update inventory every 60s

  let anyChange = false;
  for (const [comm, profile] of Object.entries(DRIFT_PROFILES)) {
    const S0 = DEFAULT_PRICES[comm];   // long-run equilibrium (OU anchor)
    const S  = state.prices[comm];     // current price
    const minP = S0 * profile.min_pct;
    const maxP = S0 * profile.max_pct;

    // ── GBM component: S(t+dt) = S(t)·exp((μ-σ²/2)·dt + σ·√dt·ε) ──
    const mu    = profile.drift / 100 / 120;          // per-tick drift (from %/hr)
    const sigma = profile.vol   / 100;                // per-tick vol (already in %/tick)
    const eps   = randn();
    const gbm   = Math.exp((mu - 0.5 * sigma * sigma) + sigma * eps) - 1; // log-return

    // ── OU mean-reversion overlay: θ·(S₀ - S)/S ──
    const ouCorrection = profile.mr * (S0 - S) / S0;

    // ── Correlated group shock ──
    let corrShock = 0;
    for (const [grp, members] of Object.entries(CORR_GROUPS)) {
      if (members.includes(comm)) corrShock = groupShocks[grp];
    }

    // ── Inventory pressure (fundamental signal) ──
    const invPressure = getInventoryPressure(comm) / 100 / 120;

    // ── Combine: total return for this tick ──
    const totalReturn = gbm + ouCorrection / 120 + corrShock * 0.5 + invPressure;
    const newPrice = Math.min(maxP, Math.max(minP, S * (1 + totalReturn)));

    if (Math.abs(newPrice - S) > 0.0001) {
      state.prices[comm] = newPrice;
      anyChange = true;
    }
  }

  // ── Record to price history (for charts & VaR) ──
  for (const comm of Object.keys(state.prices)) {
    if (!PRICE_HISTORY[comm]) PRICE_HISTORY[comm] = [];
    PRICE_HISTORY[comm].push(state.prices[comm]);
    if (PRICE_HISTORY[comm].length > MAX_HISTORY) PRICE_HISTORY[comm].shift();
  }

  if (anyChange) {
    updateAllPnL();
    renderPriceFeed();
    updateBidAskDisplay();   // keep form live bid/ask fresh
    renderRiskAnalytics();   // recompute VaR / Sharpe
    if (_driftTick % 6 === 0) renderInventory(); // update inventory display every 3 min
    if (_driftTick % 10 === 0) saveState();
  }
}

const STORAGE_KEY = 'ktc_sim_state_v2';

function saveState() {
  try {
    const { firedEvents, seenTips, ...rest } = state;
    const serialisable = {
      ...rest,
      firedEvents: [...firedEvents],
      seenTips: [...(seenTips || new Set())]
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(serialisable));
    // Flash the save indicator
    const dot = document.getElementById('persist-dot');
    const lbl = document.getElementById('persist-label');
    if (dot) { dot.style.background='var(--amber)'; setTimeout(()=>dot.style.background='var(--green)',800); }
    if (lbl) { lbl.textContent='SAVED'; }
  } catch(e) {
    const lbl = document.getElementById('persist-label');
    if (lbl) lbl.textContent='ERR';
  }
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    parsed.firedEvents = new Set(parsed.firedEvents || []);
    parsed.seenTips = new Set(parsed.seenTips || []);
    return parsed;
  } catch(e) { return null; }
}

const savedState = loadState();
let state = savedState || {
  prices: { ...DEFAULT_PRICES },
  trades: [],
  alerts: [],
  alertCount: 0,
  firedEvents: new Set(),
  seenTips: new Set(),
  morningViews: { softs: null, energy: null, agri: null },
  tradeIdCounter: 1,
  spreadIdCounter: 1,
  spreads: []
};
// Ensure new fields exist on old saved state
if (!state.spreads) state.spreads = [];
if (!state.spreadIdCounter) state.spreadIdCounter = 1;
if (!state.seenTips) state.seenTips = new Set();

const SCENARIOS = [
  { id: 'e1', time: '09:45', title: 'Fed Speak: Rate Cut Signal', session: 1, severity: 'med',
    body: 'Fed Governor signals committee is "open to adjusting policy sooner than markets expect." USD sells off. Real yields fall. Risk appetite rises.',
    impact: 'ENERGY: Crude +1–2% on USD weakness. METALS: Gold & silver rally. SOFTS: Positive for EM crop exporters. AGRI: Minimal direct impact.',
    color: 'blue',
    tip: {
      source: 'R.K.', name: 'R. Krishnamurthy', role: 'Former Fed Economist · Private Advisor',
      message: "Heads up — just left a call with someone close to the FOMC comms team. The prepared remarks have been edited twice this morning. They're softening the tightening language. I'd watch real yields and the dollar very carefully before 10am.",
      hint: 'Implication: if the language shift is confirmed, USD-denominated commodities could catch a bid. Gold and crude are the obvious beneficiaries.'
    }
  },
  { id: 'e2', time: '10:20', title: 'Libya Es Sider Terminal Shut', session: 1, severity: 'med',
    body: 'Militia forces have shut the Es Sider oil terminal. Production loss: 300,000 bbl/day. Duration unclear — hours or days.',
    impact: 'CRUDE: Brent leads (+$1.50–$3). WTI follows. Chase or fade the spike?',
    color: 'amber',
    tip: {
      source: 'A.B.', name: 'A. Ben Salah', role: 'NOC Logistics Consultant · Tripoli',
      message: "Hearing some noise from the terminal workers — armed group moved in around 0400 local. Management is not on site. This isn't a labour dispute. Could be a few hours, could be a week. Nobody knows.",
      hint: 'If confirmed: Brent/WTI spread likely to widen. Supply shock trades. Don\'t be short crude right now.'
    }
  },
  { id: 'e3', time: '11:30', title: 'Brazil Frost Warning — Coffee Belt', session: 2, severity: 'high',
    body: 'Brazilian met agency issues frost advisory for Arabica coffee regions in São Paulo state. -2°C forecast for 3 consecutive nights. 2021 frost sent coffee +30%.',
    impact: 'COFFEE: Potentially explosive move upward. Softs desk — how do you size in without chasing?',
    color: 'green',
    tip: {
      source: 'C.F.', name: 'C. Ferreira', role: 'Agronomist · CECAFÉ Member',
      message: "Weather station at Franca just registered 0°C at 600m elevation. INMET updated their advisory 20 minutes ago but it hasn\'t gone mainstream yet. The orchards between Franca and Patrocínio are the vulnerable ones — they didn't recover fully from 2021.",
      hint: 'If the cold snap lasts 3 nights as forecast, we\'re looking at irreversible damage to flowering. Coffee could gap hard at open tomorrow.'
    }
  },
  { id: 'e4', time: '12:00', title: 'China PMI Disappoints — 47.8 vs 49.5', session: 2, severity: 'high',
    body: 'China NBS manufacturing PMI prints 47.8 vs 49.5 consensus. Worst reading in 14 months. Global growth fears resurface.',
    impact: 'COPPER: Sells off hard. ENERGY: Crude down on demand fears. GOLD: Safe-haven rally possible. GRAINS: Soybean exports to China at risk.',
    color: 'amber',
    tip: {
      source: 'W.L.', name: 'W. Liu', role: 'Macro Analyst · Former PBOC Research',
      message: "The NBS number coming at noon — I'm seeing sub-48 whisper numbers circulating in Shanghai. The official consensus at 49.5 is going to get blown out. The manufacturing sub-index is the one to watch, especially new export orders.",
      hint: 'Copper gets hit first and hardest on a China miss. Soy complex follows. Consider reducing long copper and grain exposure ahead of noon.'
    }
  },
  { id: 'e5', time: '13:15', title: 'USDA Export Inspections Miss — Corn', session: 3, severity: 'med',
    body: 'Corn inspections: 32M bu vs 41M bu needed to meet yearly targets. Brazil taking market share. YTD pace 8% below last year.',
    impact: 'CORN: Bearish –5 to –15 cents. Soybeans may follow. Consider reducing long grain positions.',
    color: 'green',
    tip: {
      source: 'M.T.', name: 'M. Torres', role: 'USDA Export Reporting · Retired',
      message: "Numbers from the inspection reports look soft this week. Brazilian origin shipments are undercutting us by $8–12/MT in Southeast Asia. The weekly figure is going to disappoint — don't hold your corn longs into 13:15.",
      hint: 'Corn first, then watch wheat and soy for sympathy moves. Brazil is structurally cheaper right now — this is a multi-week headwind.'
    }
  },
  { id: 'e6', time: '13:45', title: 'OPEC+ Emergency Cut — 500K bbl/d', session: 3, severity: 'high',
    body: 'Saudi Arabia and Russia announce a voluntary 500,000 bbl/day cut effective next month. Markets had NOT priced this in.',
    impact: 'CRUDE: Explosive upside. WTI +$3–6 typical. Energy desk — this is your moment. Are you long? Do you add into the spike?',
    color: 'blue',
    tip: {
      source: 'F.A.', name: 'F. Al-Rashidi', role: 'Gulf State Energy Advisor',
      message: "Riyadh is not happy with current prices. There was an unscheduled call between MBS and Putin last night. I can't confirm volumes but when those two talk outside of scheduled meetings, supply adjustments follow. I'd be long crude before 2pm.",
      hint: 'If they announce voluntaries rather than quota changes it\'s harder for the market to front-run, but the direction is clear. Energy desk should be positioned long.'
    }
  },
  { id: 'e7', time: '14:00', title: '🚨 US Treasury Auction Fails — FINAL EVENT', session: 3, severity: 'high',
    body: '10-year Treasury auction: worst demand in 5 years. Bid-to-cover collapses. 10yr yields +20bps in 10 min. Dollar surges. Risk-off.',
    impact: 'GOLD: Sells off (rising real yields dominate). BROAD COMMODITY SELL-OFF. Only 15 minutes to close — who cuts fast? Who freezes?',
    color: 'red',
    tip: {
      source: 'P.S.', name: 'P. Steinberg', role: 'Fixed Income PM · Ex-Pimco',
      message: "Primary dealer desks are talking about very thin demand going into today's 10yr. The indirect bid has been absent for two weeks. If bid-to-cover comes in under 2.2, yields are going to spike and risk assets will sell hard. Reposition out of longs before 14:00.",
      hint: 'Rising real yields crush gold (the non-yielding asset) first. Then commodities broadly reprice on dollar strength. This is a cover-your-risk event, not a buying opportunity.'
    }
  },
];

// ═══════════════════════ CLOCK ═══════════════════════
let _lastPhase = null; // null = not yet initialised; skip toast on first tick
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = h+':'+m+':'+s;
  const totalMin = now.getHours()*60 + now.getMinutes();
  let badge = 'Pre-Market', color = 'var(--amber)';
  if (totalMin >= 510 && totalMin < 540) { badge = 'Pre-Market'; }
  else if (totalMin >= 540 && totalMin < 570) { badge = 'Morning Mtg'; }
  else if (totalMin >= 570 && totalMin < 660) { badge = 'Session 1'; color='var(--blue)'; }
  else if (totalMin >= 660 && totalMin < 675) { badge = 'Mid Mark'; color='var(--red)'; }
  else if (totalMin >= 675 && totalMin < 750) { badge = 'Session 2'; color='var(--blue)'; }
  else if (totalMin >= 750 && totalMin < 780) { badge = 'Lunch'; color='var(--text-dim)'; }
  else if (totalMin >= 780 && totalMin < 855) { badge = 'Session 3'; color='var(--green)'; }
  else if (totalMin >= 855 && totalMin < 870) { badge = 'EOD Close'; color='var(--red)'; }
  else if (totalMin >= 870) { badge = 'Debrief'; color='var(--amber)'; }
  const el = document.getElementById('sessionBadge');
  el.textContent = badge;
  el.style.borderColor = color;
  el.style.color = color;
  document.getElementById('sim-phase-label').textContent = 'Current Phase: ' + badge;

  // Phase-change announcement — skip on very first tick (null) to avoid spurious toast on load
  if (_lastPhase !== null && badge !== _lastPhase) {
    addAlert('info', `🕐 PHASE CHANGE → ${badge.toUpperCase()}`);
    showPhaseToast(badge, color);
  }
  _lastPhase = badge;
}
updateClock();
setInterval(updateClock, 1000);

// ═══════════════════════ PAGES ═══════════════════════
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (el) el.classList.add('active');
}

// ═══════════════════════ PRICE FEED UI ═══════════════════════
// Track previous prices for direction arrows
let _prevPrices = { ...DEFAULT_PRICES };

function renderPriceFeed() {
  const panel = document.getElementById('price-feed-panel');
  const groups = [
    { label: 'Metals', items: ['Gold','Silver','Copper'] },
    { label: 'Softs', items: ['Coffee','Sugar','Cotton'] },
    { label: 'Energy', items: ['WTI Crude','Brent Crude','Nat Gas','Heating Oil'] },
    { label: 'Grains & Livestock', items: ['Corn','Soybeans','Wheat','Soy Meal','Live Cattle'] },
  ];
  let html = '<div style="font-family:\'Share Tech Mono\',monospace;font-size:9px;color:var(--text-dim);text-align:right;padding:2px 0 4px;letter-spacing:1px;">AUTO-FEED · CLICK ROW FOR CHART</div>';
  for (const grp of groups) {
    html += `<div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--text-dim);padding:6px 0 4px;border-bottom:1px solid var(--border);margin-bottom:2px;">${grp.label}</div>`;
    for (const item of grp.items) {
      const p = state.prices[item];
      const prev = _prevPrices[item] || p;
      const def = DEFAULT_PRICES[item];
      const chgFromOpen = ((p - def) / def * 100);
      const chgSign = chgFromOpen >= 0 ? '+' : '';
      const dirArrow = p > prev ? '▲' : p < prev ? '▼' : '–';
      const dirClass = p > prev ? 'up' : p < prev ? 'dn' : '';
      const chgColor = chgFromOpen > 0 ? 'var(--green)' : chgFromOpen < 0 ? 'var(--red)' : 'var(--text-dim)';
      const safeItem = item.replace(/ /g,'_');
      html += `<div class="price-row" id="pricerow-${safeItem}" onclick="openCommodityChart('${item}')" style="cursor:pointer;" title="Click to open ${item} chart">
        <span class="price-name">${item}</span>
        <span class="price-val" id="priceval-${safeItem}" style="color:var(--amber)">${p.toFixed(2)}</span>
        <span class="price-change" style="color:${chgColor};font-family:'Share Tech Mono',monospace;font-size:10px;">${chgSign}${chgFromOpen.toFixed(2)}%</span>
        <span class="price-trend ${dirClass}">${dirArrow}</span>
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:4px;">↗</span>
      </div>`;
    }
  }
  // Update prev prices for next render
  _prevPrices = { ...state.prices };
  panel.innerHTML = html;
}

function openPriceModal() {
  const body = document.getElementById('price-modal-body');
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
  for (const [k, v] of Object.entries(state.prices)) {
    html += `<div class="form-group">
      <label class="form-label">${k}</label>
      <input class="form-input" type="number" step="0.01" id="pm-${k.replace(/ /g,'_')}" value="${v.toFixed(2)}">
    </div>`;
  }
  html += '</div>';
  body.innerHTML = html;
  document.getElementById('modal-price').classList.add('active');
}

function applyPrices() {
  for (const k of Object.keys(state.prices)) {
    const el = document.getElementById('pm-'+k.replace(/ /g,'_'));
    if (el) {
      const val = parseFloat(el.value);
      if (!isNaN(val) && val > 0) state.prices[k] = val;
    }
  }
  renderPriceFeed();
  updateAllPnL();
  saveState();
  closeModal('modal-price');
  addAlert('info', 'Official prices updated by facilitator. All P&L recalculated.');
}

// ═══════════════════════ ORDER TYPE STATE ═══════════════════════
let _orderType = 'market';
function setOrderType(type) {
  _orderType = type;
  document.getElementById('ot-market').classList.toggle('active', type === 'market');
  document.getElementById('ot-limit').classList.toggle('active', type === 'limit');
  document.getElementById('price-label').textContent = type === 'limit' ? 'Limit Price' : 'Override Price (optional)';
  document.getElementById('slippage-note').textContent = type === 'market'
    ? 'Market order: executes at ask/bid + slippage. Price field optional override.'
    : 'Limit order: fills at specified price. No slippage applied.';
  updateBidAskDisplay();
}

function onDeskChange() {
  const desk = document.getElementById('trade-desk').value;
  const sel = document.getElementById('trade-commodity');
  const opts = sel.options;
  const softsItems = ['Gold','Silver','Copper','Coffee','Sugar','Cotton'];
  const energyItems = ['WTI Crude','Brent Crude','Nat Gas','Heating Oil'];
  const agriItems = ['Corn','Soybeans','Wheat','Soy Meal','Live Cattle'];
  const allowed = desk === 'softs' ? softsItems : desk === 'energy' ? energyItems : agriItems;
  for (let o of opts) { o.hidden = !allowed.includes(o.value); }
  const firstVisible = [...opts].find(o => !o.hidden);
  if (firstVisible) sel.value = firstVisible.value;
  updateBidAskDisplay();
}

function onCommChange() { updateBidAskDisplay(); }

function updateBidAskDisplay() {
  const comm = document.getElementById('trade-commodity')?.value;
  if (!comm || !state.prices[comm]) return;
  const { bid, ask, spread } = getBidAsk(comm);
  const mid = state.prices[comm];
  document.getElementById('form-bid').textContent = bid.toFixed(mid < 10 ? 4 : 2);
  document.getElementById('form-ask').textContent = ask.toFixed(mid < 10 ? 4 : 2);
  const spreadBps = (spread / mid * 10000).toFixed(1);
  document.getElementById('form-spread').textContent = `Spread: ${spread.toFixed(mid < 10 ? 4 : 2)} (${spreadBps} bps)`;
  updateMarginDisplay();
}

function updateMarginDisplay() {
  const comm = document.getElementById('trade-commodity')?.value;
  const lots = parseInt(document.getElementById('trade-lots')?.value) || 1;
  if (!comm || !state.prices[comm]) return;
  const notional = lots * (CONTRACT_SIZES[comm] || 1) * state.prices[comm];
  const margin = notional * 0.05;
  document.getElementById('margin-req-val').textContent = '$' + margin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

let _receiptTimeout = null;
function showExecReceipt(lines, isReject) {
  const el = document.getElementById('exec-receipt');
  const hdr = document.getElementById('receipt-header');
  const rows = document.getElementById('receipt-rows');
  el.className = 'exec-receipt active' + (isReject ? ' reject' : '');
  hdr.textContent = isReject ? '✕ ORDER REJECTED' : '▲ ORDER FILLED';
  hdr.style.color = isReject ? 'var(--red)' : 'var(--green)';
  rows.innerHTML = lines.map(([l,r]) => `<div class="receipt-row"><span>${l}</span><span>${r}</span></div>`).join('');
  el.style.display = 'block';
  clearTimeout(_receiptTimeout);
  _receiptTimeout = setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// ═══════════════════════ TRADES ═══════════════════════
function getTime() {
  const now = new Date();
  return String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
}

function logTrade(dir) {
  const desk      = document.getElementById('trade-desk').value;
  const commodity = document.getElementById('trade-commodity').value;
  const lots      = parseInt(document.getElementById('trade-lots').value);
  const overridePrice = parseFloat(document.getElementById('trade-price').value);
  const orderType = _orderType;

  // ── Validation ──
  if (!lots || lots < 1) { flashAlert('warn','Missing Lots','Please enter a number of lots.'); return; }
  if (orderType === 'limit' && (!overridePrice || overridePrice <= 0)) {
    flashAlert('warn','Limit Price Required','Enter a limit price for limit orders.'); return;
  }

  // ── Position limit check ──
  const openLots = state.trades.filter(t => t.desk === desk && t.status === 'open').reduce((s,t)=>s+t.lots,0);
  if (openLots + lots > DESKS[desk].maxLots) {
    flashAlert('danger','Position Limit Breach',`${DESKS[desk].name} would exceed ${DESKS[desk].maxLots} lot limit.`);
    addAlert('danger', `LIMIT BREACH: ${DESKS[desk].name} — ${openLots + lots} lots > limit ${DESKS[desk].maxLots}`);
    showExecReceipt([['Reason','Position limit exceeded'],['Current lots',openLots],['Attempted',lots],['Limit',DESKS[desk].maxLots]], true);
    return;
  }

  // ── Compute execution price with bid/ask + slippage ──
  const execPrice = getExecPrice(commodity, lots, dir, orderType, overridePrice || state.prices[commodity]);
  const midPrice  = state.prices[commodity];
  const { bid, ask } = getBidAsk(commodity);
  const prof = DRIFT_PROFILES[commodity];

  // Slippage in $ and %
  const baseExec  = dir === 'L' ? ask : bid;
  const slipDollar = Math.abs(execPrice - baseExec);
  const slipPct   = (slipDollar / midPrice * 100).toFixed(3);

  // Commission
  const commission = (prof.commission || 2) * lots;

  // Notional + initial margin
  const contractSz = CONTRACT_SIZES[commodity] || 1;
  const notional   = lots * contractSz * execPrice;
  const initMargin = notional * 0.05;

  const trade = {
    id: state.tradeIdCounter++,
    time: getTime(),
    desk, commodity, dir, lots,
    price:        execPrice,         // execution price (includes spread + slippage)
    midAtEntry:   midPrice,          // mid-market at time of order
    slippage:     slipDollar * lots * contractSz, // total slippage cost in $
    commission,
    contractSize: contractSz,
    notional,
    initMargin,
    orderType,
    status: 'open',
    currPrice: execPrice,
  };
  state.trades.push(trade);

  // ── Show execution receipt ──
  showExecReceipt([
    ['Commodity', commodity],
    ['Direction', dir === 'L' ? 'LONG' : 'SHORT'],
    ['Lots', lots],
    ['Mid at order', midPrice.toFixed(4)],
    [dir==='L' ? 'Ask' : 'Bid', baseExec.toFixed(4)],
    ['Exec price', execPrice.toFixed(4)],
    orderType === 'market' ? ['Slippage', slipPct + '% ($' + (slipDollar * lots * contractSz).toFixed(2) + ')'] : ['Order type', 'Limit (no slip)'],
    ['Commission', '$' + commission.toFixed(2)],
    ['Notional', '$' + notional.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')],
    ['Init margin (5%)', '$' + initMargin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')],
  ], false);

  addAlert('info', `EXEC: ${DESKS[desk].name} ${dir === 'L' ? 'LONG' : 'SHORT'} ${lots}L ${commodity} @ ${execPrice.toFixed(4)} [slip: ${slipPct}%]`);

  document.getElementById('trade-price').value = '';
  document.getElementById('trade-lots').value = '';

  updateAllPnL();
  renderBlotter();
  renderPositions();
  renderRiskAnalytics();
  saveState();
}

function closeTrade(id) {
  const t = state.trades.find(x => x.id === id);
  if (!t) return;
  t.status = 'closed';
  const pnl = calcPnL(t);
  addAlert(pnl >= 0 ? 'good' : 'warn', `CLOSED: ${DESKS[t.desk].name} closed ${t.lots}L ${t.commodity} — P&L: ${fmt(pnl)}`);
  updateAllPnL();
  renderBlotter();
  renderPositions();
  saveState();
}

function calcPnL(t) {
  const curr = t.status === 'closed' ? t.currPrice : (state.prices[t.commodity] || t.currPrice);
  const diff = t.dir === 'L' ? (curr - t.price) : (t.price - curr);
  return diff * t.lots * t.contractSize;
}

function fmt(n) {
  const s = Math.abs(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  return (n >= 0 ? '+$' : '-$') + s;
}

function fmtAbs(n) {
  return '$' + Math.abs(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// ═══════════════════════ P&L SCOREBOARD ═══════════════════════
function updateAllPnL() {
  for (const deskKey of ['softs','energy','agri']) {
    const openTrades = state.trades.filter(t => t.desk === deskKey && t.status === 'open');
    openTrades.forEach(t => t.currPrice = state.prices[t.commodity] || t.currPrice);

    const pnl = state.trades.filter(t => t.desk === deskKey).reduce((s,t) => s + calcPnL(t), 0);
    const dll = DESKS[deskKey].dll;
    const dllPct = Math.min(Math.abs(pnl < 0 ? pnl : 0) / dll * 100, 100);
    const openLots = openTrades.reduce((s,t)=>s+t.lots,0);

    const pnlEl = document.getElementById('pnl-'+deskKey);
    pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + Math.abs(pnl).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    pnlEl.className = 'ds-pnl ' + (pnl > 0 ? 'pos' : pnl < 0 ? 'neg' : 'zero');

    const dllText = document.getElementById('dll-'+deskKey+'-text');
    dllText.textContent = `DLL Used: ${fmtAbs(Math.max(0,-pnl))} / ${fmtAbs(dll)} (${dllPct.toFixed(0)}%)`;
    dllText.style.color = dllPct >= 75 ? 'var(--red)' : dllPct >= 50 ? 'var(--amber)' : 'var(--text-dim)';

    const bar = document.getElementById('dll-bar-'+deskKey);
    bar.style.width = dllPct + '%';
    bar.className = 'dll-bar ' + (dllPct >= 75 ? 'danger' : dllPct >= 50 ? 'warn' : '');

    document.getElementById('meta-'+deskKey).textContent = `${openTrades.length} positions · ${openLots} lots open`;

    // Auto-alerts
    if (pnl < 0) {
      const lossAmt = Math.abs(pnl);
      if (lossAmt >= dll) { addAlert('danger', `🚨 STOP-OUT: ${DESKS[deskKey].name} has breached DLL ($${lossAmt.toFixed(0)} loss). Force-close all positions immediately!`); }
      else if (lossAmt >= dll * 0.75) { addAlert('warn', `⚠ ORANGE ALERT: ${DESKS[deskKey].name} at ${dllPct.toFixed(0)}% of DLL. Must reduce positions 30% within 10 min.`); }
      else if (lossAmt >= dll * 0.5) { addAlert('warn', `YELLOW ALERT: ${DESKS[deskKey].name} at ${dllPct.toFixed(0)}% of DLL. Suggest reducing size.`); }
    }
  }
  renderPositions();
}

// ═══════════════════════ BLOTTER ═══════════════════════
function renderBlotter() {
  const body = document.getElementById('blotter-body');
  if (state.trades.length === 0) {
    body.innerHTML = '<div class="blotter-empty">No trades logged. Use the trade entry form above to begin.</div>';
    return;
  }
  body.innerHTML = [...state.trades].reverse().map(t => {
    const pnl = calcPnL(t);
    const curr = state.prices[t.commodity] || t.currPrice;
    const spreadTag = t.spreadId ? `<span class="spread-badge">SPR#${t.spreadId} L${t.legNum}</span>` : '';
    const midAtEntry = t.midAtEntry ? t.midAtEntry.toFixed(4) : t.price.toFixed(4);
    const slipStr = t.slippage != null ? '$' + Math.abs(t.slippage).toFixed(2) : '—';
    return `<div class="blotter-row">
      <span style="font-family:'Share Tech Mono',monospace;font-size:11px;">${t.time}</span>
      <span class="desk">${t.desk === 'softs' ? 'S/H' : t.desk === 'energy' ? 'NRG' : 'AGR'}</span>
      <span>${t.commodity}${spreadTag}</span>
      <span class="${t.dir === 'L' ? 'long' : 'short'}">${t.dir === 'L' ? 'LONG' : 'SHORT'}</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:11px;">${t.lots}</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim)">${midAtEntry}</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:11px;">${t.price.toFixed(4)}</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--amber)">${slipStr}</span>
      <span style="font-family:'Share Tech Mono',monospace;font-size:11px;">${curr.toFixed(4)}</span>
      <span class="${pnl >= 0 ? 'pos' : 'neg'}">${fmt(pnl)}</span>
    </div>`;
  }).join('');
}

// ═══════════════════════ POSITIONS ═══════════════════════
function renderPositions() {
  const body = document.getElementById('positions-body');
  const open = state.trades.filter(t => t.status === 'open');
  if (open.length === 0) {
    body.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-dim);padding:16px;font-family:\'Share Tech Mono\',monospace;font-size:12px;">No open positions</td></tr>';
    return;
  }
  body.innerHTML = open.map(t => {
    const curr = state.prices[t.commodity] || t.currPrice;
    const pnl = calcPnL(t);
    const margin = t.initMargin || (t.lots * t.contractSize * t.price * 0.05);
    return `<tr>
      <td style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;">${t.desk === 'softs' ? 'S/H' : t.desk === 'energy' ? 'NRG' : 'AGR'}</td>
      <td style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;">${t.commodity}</td>
      <td style="color:${t.dir==='L'?'var(--green)':'var(--red)'};font-family:'Share Tech Mono',monospace;font-size:12px;">${t.dir==='L'?'LONG':'SHORT'}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;">${t.price.toFixed(4)}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;">${t.lots}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--amber)">${curr.toFixed(4)}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:${pnl>=0?'var(--green)':'var(--red)'}">${fmt(pnl)}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim)">$${margin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')}</td>
      <td><button class="close-pos-btn" onclick="closeTrade(${t.id})">CLOSE</button></td>
    </tr>`;
  }).join('');
}

// ═══════════════════════ ALERTS ═══════════════════════
let alertThrottle = {};
function addAlert(type, msg) {
  const key = type + msg;
  const now = Date.now();
  if (alertThrottle[key] && now - alertThrottle[key] < 5000) return;
  alertThrottle[key] = now;

  state.alerts.unshift({ type, msg, time: getTime() });
  state.alertCount++;
  const badge = document.getElementById('alert-badge');
  badge.textContent = state.alertCount;
  badge.classList.add('show');

  const list = document.getElementById('alert-list');
  const item = document.createElement('div');
  item.className = `alert-item ${type}`;
  item.innerHTML = `<span class="alert-time">${getTime()}</span><span class="alert-msg">${msg}</span>`;
  list.insertBefore(item, list.firstChild);
  if (list.children.length > 30) list.removeChild(list.lastChild);
}

let flashTimeout;
function flashAlert(type, title, body) {
  const existing = document.querySelector('.alert-flash');
  if (existing) existing.remove();
  const div = document.createElement('div');
  div.className = 'alert-flash';
  div.innerHTML = `<div class="alert-flash-inner ${type}"><div class="af-title ${type}">${title}</div><div class="af-body">${body}</div></div>`;
  document.body.appendChild(div);
  clearTimeout(flashTimeout);
  flashTimeout = setTimeout(() => div.remove(), 4000);
}

// ═══════════════════════ SCENARIOS ═══════════════════════
function renderScenarioButtons() {
  const col1 = document.getElementById('scenario-buttons-col1');
  const col2 = document.getElementById('scenario-buttons-col2');
  col1.innerHTML = '';
  col2.innerHTML = '';
  SCENARIOS.forEach((ev, i) => {
    const fired = state.firedEvents.has(ev.id);
    const tipSeen = state.seenTips && state.seenTips.has(ev.id);
    const isHigh = ev.severity === 'high';

    // Wrapper div
    const wrap = document.createElement('div');
    wrap.className = 'event-btn-wrap';

    const btn = document.createElement('button');
    btn.className = `event-btn ${isHigh ? 'high-sev' : ''} ${fired ? 'fired' : ''}`;
    btn.innerHTML = `<span>${ev.time} — ${ev.title}</span><span class="ev-time">Session ${ev.session}</span>`;
    if (!fired) btn.onclick = () => previewEvent(ev);

    wrap.appendChild(btn);

    // Add tip button if tip exists and event not yet fired
    if (ev.tip && !fired) {
      const tipBtn = document.createElement('button');
      tipBtn.className = 'tip-btn';
      tipBtn.title = 'Insider intelligence — show source tip';
      tipBtn.textContent = tipSeen ? '✓ TIP' : '⚑ TIP';
      tipBtn.style.opacity = tipSeen ? '0.5' : '1';
      tipBtn.onclick = (e) => { e.stopPropagation(); showTip(ev); };
      wrap.appendChild(tipBtn);
    }

    (i < 4 ? col1 : col2).appendChild(wrap);
  });
}

function previewEvent(ev) {
  const modal = document.getElementById('modal-event');
  const inner = document.getElementById('modal-event-inner');
  inner.className = 'modal ' + (ev.color || '');
  document.getElementById('modal-event-title').textContent = `Event — ${ev.time} — ${ev.title}`;
  document.getElementById('modal-event-body').innerHTML = `
    <div style="margin-bottom:12px;font-size:13px;line-height:1.7;">${ev.body}</div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--${ev.color==='green'?'green':ev.color==='blue'?'blue':'amber'});padding:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,179,0,0.15);">${ev.impact}</div>`;
  document.getElementById('modal-event-fire-btn').onclick = () => fireEvent(ev);
  modal.classList.add('active');
}

function fireEvent(ev) {
  state.firedEvents.add(ev.id);
  closeModal('modal-event');
  renderScenarioButtons();
  saveState();
  // Start the 2-minute countdown
  startEventCountdown(ev);
}

// ═══════════════════════ EVENT COUNTDOWN ═══════════════════════
let _countdownInterval = null;

function startEventCountdown(ev) {
  // Clear any existing countdown
  if (_countdownInterval) clearInterval(_countdownInterval);

  const bar = document.getElementById('event-countdown-bar');
  const timerEl = document.getElementById('cdb-timer');
  const titleEl = document.getElementById('cdb-event-title');
  const progressEl = document.getElementById('cdb-progress-bar');

  titleEl.textContent = ev.title;
  bar.classList.add('active');

  const TOTAL = 120; // 2 minutes
  let remaining = TOTAL;

  function tick() {
    remaining--;
    const m = Math.floor(remaining / 60);
    const s = String(remaining % 60).padStart(2, '0');
    timerEl.textContent = `${m}:${s}`;

    // Progress bar shrinks
    progressEl.style.width = (remaining / TOTAL * 100) + '%';

    // Flash red below 30s
    if (remaining <= 30) {
      timerEl.style.fontSize = '36px';
    }

    if (remaining <= 0) {
      clearInterval(_countdownInterval);
      _countdownInterval = null;
      bar.classList.remove('active');
      // FIRE the actual price impact!
      triggerEventPriceImpact(ev);
    }
  }

  tick();
  _countdownInterval = setInterval(tick, 1000);
  addAlert('info', `📡 EVENT QUEUED: "${ev.title}" — Impact in 2:00. Desks: prepare positions.`);
}

// ═══════════════════════ PRICE IMPACTS ═══════════════════════
// Each scenario has defined price impacts with randomised variance
const SCENARIO_IMPACTS = {
  'e1': { // Fed Rate Cut Signal — USD weakness, gold+, crude+
    'Gold':       { pct: +1.8, range: 0.6 },
    'Silver':     { pct: +2.1, range: 0.8 },
    'WTI Crude':  { pct: +1.2, range: 0.5 },
    'Brent Crude':{ pct: +1.3, range: 0.5 },
    'Coffee':     { pct: +0.8, range: 0.4 },
    'Copper':     { pct: +0.9, range: 0.4 },
  },
  'e2': { // Libya Es Sider shut
    'WTI Crude':  { pct: +2.5, range: 0.8 },
    'Brent Crude':{ pct: +3.2, range: 1.0 },
    'Heating Oil':{ pct: +2.1, range: 0.6 },
    'Nat Gas':    { pct: +0.5, range: 0.3 },
  },
  'e3': { // Brazil frost — coffee
    'Coffee':     { pct: +6.5, range: 2.5 },
    'Sugar':      { pct: +1.8, range: 0.7 },
    'Cotton':     { pct: +0.6, range: 0.3 },
  },
  'e4': { // China PMI miss
    'Copper':     { pct: -3.2, range: 0.8 },
    'WTI Crude':  { pct: -1.8, range: 0.6 },
    'Brent Crude':{ pct: -1.6, range: 0.5 },
    'Gold':       { pct: +1.1, range: 0.5 }, // safe haven
    'Soybeans':   { pct: -1.9, range: 0.6 },
    'Corn':       { pct: -1.2, range: 0.4 },
    'Soy Meal':   { pct: -1.4, range: 0.5 },
  },
  'e5': { // USDA corn miss
    'Corn':       { pct: -2.2, range: 0.8 },
    'Soybeans':   { pct: -1.1, range: 0.5 },
    'Wheat':      { pct: -0.9, range: 0.4 },
    'Soy Meal':   { pct: -0.8, range: 0.3 },
  },
  'e6': { // OPEC+ cut
    'WTI Crude':  { pct: +4.5, range: 1.5 },
    'Brent Crude':{ pct: +4.8, range: 1.5 },
    'Heating Oil':{ pct: +3.2, range: 0.8 },
    'Nat Gas':    { pct: +1.0, range: 0.5 },
    'Gold':       { pct: +0.7, range: 0.3 }, // inflation hedge
  },
  'e7': { // Treasury auction fail — risk off
    'Gold':       { pct: -1.8, range: 0.8 }, // rising real yields
    'Silver':     { pct: -2.1, range: 0.9 },
    'WTI Crude':  { pct: -2.4, range: 0.8 },
    'Brent Crude':{ pct: -2.2, range: 0.8 },
    'Copper':     { pct: -2.8, range: 0.9 },
    'Corn':       { pct: -1.1, range: 0.4 },
    'Soybeans':   { pct: -1.3, range: 0.5 },
    'Wheat':      { pct: -0.9, range: 0.3 },
    'Coffee':     { pct: -1.0, range: 0.4 },
  }
};

function triggerEventPriceImpact(ev) {
  // ── Record event marker tick position BEFORE repricing ──
  const markerTick = PRICE_HISTORY[Object.keys(PRICE_HISTORY)[0]]?.length || 0;

  const impacts = SCENARIO_IMPACTS[ev.id];
  if (!impacts) {
    showBreakingNews(ev, [], null);
    return;
  }

  const changes = [];
  for (const [comm, cfg] of Object.entries(impacts)) {
    if (state.prices[comm] === undefined) continue;
    // Randomise: base pct ± range/2
    const variance = (Math.random() - 0.5) * cfg.range;
    const actualPct = cfg.pct + variance;
    const oldPrice = state.prices[comm];
    const newPrice = oldPrice * (1 + actualPct / 100);
    state.prices[comm] = Math.max(newPrice, 0.01);
    changes.push({ comm, oldPrice, newPrice: state.prices[comm], pct: actualPct });
  }

  // Gentle Brownian nudge on unaffected commodities (market sympathies)
  for (const comm of Object.keys(state.prices)) {
    if (!impacts[comm]) {
      const nudge = (Math.random() - 0.5) * 0.3; // ±0.15%
      state.prices[comm] = Math.max(state.prices[comm] * (1 + nudge / 100), 0.01);
    }
  }

  updateAllPnL();
  renderPriceFeed();
  flashPriceChanges(changes);
  saveState();

  // ── Record event markers for chart display ──
  for (const change of changes) {
    EVENT_MARKERS.push({ tick: markerTick, comm: change.comm, label: ev.title, pct: change.pct, color: ev.color || 'amber', evId: ev.id });
  }

  addAlert('danger', `⚡ MARKET IMPACT: ${ev.title} — ${changes.length} commodities repriced`);
  showBreakingNews(ev, changes, impacts);
}

function flashPriceChanges(changes) {
  // Small delay to let renderPriceFeed() rebuild DOM first
  setTimeout(() => {
    changes.forEach(c => {
      const rowId = 'pricerow-' + c.comm.replace(/ /g, '_');
      const row = document.getElementById(rowId);
      if (row) {
        row.classList.remove('flash-up', 'flash-dn');
        void row.offsetWidth;
        row.classList.add(c.pct > 0 ? 'flash-up' : 'flash-dn');
        setTimeout(() => row.classList.remove('flash-up','flash-dn'), 2500);
      }
    });
  }, 50);
}

// ═══════════════════════ BREAKING NEWS OVERLAY ═══════════════════════
function showBreakingNews(ev, changes, impacts) {
  const overlay = document.getElementById('breaking-news-overlay');
  const headlineEl = document.getElementById('bno-headline');
  const sublineEl = document.getElementById('bno-subline');
  const impactEl = document.getElementById('bno-impact-text');
  const priceChangesEl = document.getElementById('bno-price-changes');

  // Headline character-by-character reveal
  headlineEl.innerHTML = '';
  const chars = ev.title.split('');
  chars.forEach((ch, i) => {
    const span = document.createElement('span');
    span.className = 'bno-char';
    span.textContent = ch === ' ' ? '\u00a0' : ch;
    span.style.animationDelay = (0.4 + i * 0.04) + 's';
    headlineEl.appendChild(span);
  });

  sublineEl.textContent = ev.body;
  impactEl.textContent = ev.impact;

  // Price change chips
  priceChangesEl.innerHTML = changes.map(c => {
    const sign = c.pct > 0 ? '+' : '';
    return `<div class="bno-price-chip">
      <div class="pc-name">${c.comm}</div>
      <div class="pc-delta ${c.pct > 0 ? 'up' : 'dn'}">${sign}${c.pct.toFixed(1)}%</div>
    </div>`;
  }).join('');

  overlay.classList.add('active');
  // Auto-dismiss after 12 seconds
  setTimeout(() => dismissBreakingNews(), 12000);
}

function dismissBreakingNews() {
  document.getElementById('breaking-news-overlay').classList.remove('active');
}

// ═══════════════════════ INSIDER TIPS ═══════════════════════
function showTip(ev) {
  if (!ev.tip) return;
  const t = ev.tip;
  const overlay = document.getElementById('insider-tip-overlay');

  document.getElementById('tip-avatar').textContent = t.source;
  document.getElementById('tip-source-name').textContent = t.name;
  document.getElementById('tip-source-role').textContent = t.role;
  document.getElementById('tip-message').textContent = t.message;
  document.getElementById('tip-hint').textContent = '💡 ' + t.hint;
  document.getElementById('tip-timestamp').textContent = getTime() + ' — Received via encrypted channel';

  overlay.classList.add('active');

  // Mark tip as seen
  if (!state.seenTips) state.seenTips = new Set();
  state.seenTips.add(ev.id);
  renderScenarioButtons();
  addAlert('warn', `📬 INTEL RECEIVED: Source "${t.source}" — check tip on "${ev.title}"`);
}

function closeTip() {
  document.getElementById('insider-tip-overlay').classList.remove('active');
}

// Click outside tip card to close
document.getElementById('insider-tip-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeTip();
});

// ═══════════════════════ COMMODITY CHART ═══════════════════════
// PRICE_HISTORY, MAX_HISTORY, EVENT_MARKERS declared above (near driftTick)

// Initialise with seed history (simulated pre-session drift from open prices)
(function seedHistory() {
  const SEED_POINTS = 40; // ~20 minutes of pre-session history
  for (const comm of Object.keys(DEFAULT_PRICES)) {
    PRICE_HISTORY[comm] = [];
    let p = DEFAULT_PRICES[comm];
    const prof = DRIFT_PROFILES[comm] || { vol: 0.05 };
    for (let i = 0; i < SEED_POINTS; i++) {
      p = p * (1 + (Math.random() - 0.5) * prof.vol * 0.8 / 100);
      PRICE_HISTORY[comm].push(p);
    }
    // Set final seed point to match current state price
    PRICE_HISTORY[comm].push(state.prices[comm]);
  }
})();

// ── Price history and event markers are recorded inline in driftTick() and triggerEventPriceImpact() ──

let _currentChartComm = null;
let _chartInstance = null;
let _activeChartTab = 'price';

function openCommodityChart(comm) {
  _currentChartComm = comm;
  _activeChartTab = 'price';

  // Reset tab UI
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.chart-tab')[0].classList.add('active');

  const modal = document.getElementById('chart-modal');
  modal.classList.add('active');
  renderChartContent(comm);
}

function closeChartModal() {
  document.getElementById('chart-modal').classList.remove('active');
  if (_chartInstance) { _chartInstance.destroy(); _chartInstance = null; }
  _currentChartComm = null;
}

document.getElementById('chart-modal').addEventListener('click', function(e) {
  if (e.target === this) closeChartModal();
});

function switchChartTab(tab, el) {
  _activeChartTab = tab;
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (_currentChartComm) renderChartContent(_currentChartComm);
}

const COMM_META = {
  'Gold': 'USD/troy oz · COMEX · 10 oz/lot', 'Silver': 'USD/troy oz · COMEX · 100 oz/lot',
  'Copper': 'USD/lb · COMEX · 500 lbs/lot', 'Coffee': 'USd/lb · ICE NY · 100 lbs/lot',
  'Sugar': 'USd/lb · ICE NY · 1,000 lbs/lot', 'Cotton': 'USd/lb · ICE · 500 lbs/lot',
  'WTI Crude': 'USD/bbl · NYMEX · 100 bbl/lot', 'Brent Crude': 'USD/bbl · ICE · 100 bbl/lot',
  'Nat Gas': 'USD/MMBtu · NYMEX · 1,000 MMBtu/lot', 'Heating Oil': 'USd/gal · NYMEX · 42,000 gal/lot',
  'Corn': 'USd/bu · CBOT · 500 bu/lot', 'Soybeans': 'USd/bu · CBOT · 500 bu/lot',
  'Wheat': 'USd/bu · CBOT · 500 bu/lot', 'Soy Meal': 'USD/ton · CBOT · 100 ton/lot',
  'Live Cattle': 'USd/lb · CME · 400 lbs/lot',
};

function renderChartContent(comm) {
  const history = PRICE_HISTORY[comm] || [];
  const curr = state.prices[comm];
  const open = DEFAULT_PRICES[comm];
  const chgPct = ((curr - open) / open * 100);
  const chgSign = chgPct >= 0 ? '+' : '';
  const chgColor = chgPct >= 0 ? 'var(--green)' : 'var(--red)';

  // Header
  document.getElementById('chart-comm-name').textContent = comm;
  document.getElementById('chart-comm-meta').textContent = COMM_META[comm] || '';
  document.getElementById('chart-curr-price').textContent = curr.toFixed(2);
  const chgEl = document.getElementById('chart-price-chg');
  chgEl.textContent = `${chgSign}${chgPct.toFixed(2)}% from open`;
  chgEl.style.color = chgColor;

  // Stats
  const prices = history.length > 0 ? history : [open, curr];
  const hiPrice = Math.max(...prices);
  const loPrice = Math.min(...prices);
  const vol = (() => {
    if (prices.length < 2) return 0;
    const returns = prices.slice(1).map((p,i) => (p - prices[i]) / prices[i] * 100);
    const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
    const variance = returns.reduce((a,b)=>a+(b-mean)**2,0)/returns.length;
    return Math.sqrt(variance);
  })();
  const momentum = prices.length >= 10 ? ((prices[prices.length-1] - prices[prices.length-10]) / prices[prices.length-10] * 100) : chgPct;
  const momSign = momentum >= 0 ? '+' : '';

  document.getElementById('chart-stats-row').innerHTML = `
    <div class="chart-stat"><div class="chart-stat-val" style="color:var(--amber)">${curr.toFixed(2)}</div><div class="chart-stat-lbl">Current</div></div>
    <div class="chart-stat"><div class="chart-stat-val" style="color:var(--text-dim)">${open.toFixed(2)}</div><div class="chart-stat-lbl">Session Open</div></div>
    <div class="chart-stat"><div class="chart-stat-val" style="color:var(--green)">${hiPrice.toFixed(2)}</div><div class="chart-stat-lbl">Session High</div></div>
    <div class="chart-stat"><div class="chart-stat-val" style="color:var(--red)">${loPrice.toFixed(2)}</div><div class="chart-stat-lbl">Session Low</div></div>
    <div class="chart-stat"><div class="chart-stat-val" style="color:${momentum>=0?'var(--green)':'var(--red)'}">${momSign}${momentum.toFixed(2)}%</div><div class="chart-stat-lbl">10-Tick Mom.</div></div>
  `;

  // Build chart data
  const labels = prices.map((_, i) => {
    const minsAgo = (prices.length - 1 - i) * 0.5;
    if (minsAgo === 0) return 'Now';
    if (minsAgo % 5 === 0) return `-${minsAgo}m`;
    return '';
  });

  let dataValues;
  if (_activeChartTab === 'pct') {
    dataValues = prices.map(p => ((p - open) / open * 100));
  } else if (_activeChartTab === 'volume') {
    // Simulated volatility: rolling 5-tick std dev
    dataValues = prices.map((p, i) => {
      if (i < 4) return 0;
      const window = prices.slice(i-4, i+1);
      const mean = window.reduce((a,b)=>a+b,0)/5;
      return Math.sqrt(window.reduce((a,b)=>a+(b-mean)**2,0)/5) / mean * 100;
    });
  } else {
    dataValues = prices;
  }

  const isUp = dataValues[dataValues.length-1] >= dataValues[0];
  const lineColor = isUp ? '#00e676' : '#ff1744';
  const fillColor = isUp ? 'rgba(0,230,118,0.06)' : 'rgba(255,23,68,0.06)';

  // Find event marker positions for this commodity
  const commMarkers = EVENT_MARKERS.filter(m => m.comm === comm);

  if (_chartInstance) _chartInstance.destroy();

  const ctx = document.getElementById('commodityChart').getContext('2d');

  // Build annotation plugins data for event markers
  const pointColors = labels.map((_, i) => {
    const isMarker = commMarkers.some(m => {
      const histLen = history.length;
      const markerIdx = m.tick - (MAX_HISTORY - histLen);
      return Math.abs(i - markerIdx) <= 1;
    });
    return isMarker ? '#ff1744' : 'transparent';
  });
  const pointRadii = pointColors.map(c => c === 'transparent' ? 0 : 5);

  _chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: dataValues,
        borderColor: lineColor,
        backgroundColor: fillColor,
        borderWidth: 1.5,
        fill: true,
        tension: 0.3,
        pointRadius: pointRadii,
        pointBackgroundColor: pointColors,
        pointBorderColor: pointColors,
      }]
    },
    options: {
      responsive: true,
      animation: { duration: 300 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117',
          borderColor: '#1a2332',
          borderWidth: 1,
          titleColor: '#ffb300',
          bodyColor: '#c8d6e5',
          callbacks: {
            label: ctx => {
              const v = ctx.raw;
              if (_activeChartTab === 'pct' || _activeChartTab === 'volume') return ` ${v.toFixed(3)}%`;
              return ` ${v.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#1a2332', drawTicks: false },
          ticks: { color: '#4a5568', font: { family: 'Share Tech Mono', size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 12 },
          border: { color: '#1a2332' }
        },
        y: {
          grid: { color: '#1a2332' },
          ticks: { color: '#4a5568', font: { family: 'Share Tech Mono', size: 9 },
            callback: v => _activeChartTab === 'price' ? v.toFixed(1) : v.toFixed(2) + '%'
          },
          border: { color: '#1a2332' }
        }
      }
    }
  });

  // Event markers list
  const evList = document.getElementById('chart-event-list');
  if (commMarkers.length === 0) {
    evList.innerHTML = `<div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);padding:8px 0;">No fired events have affected ${comm} yet.</div>`;
  } else {
    evList.innerHTML = commMarkers.map(m => {
      const sign = m.pct >= 0 ? '+' : '';
      const dotColor = m.pct >= 0 ? 'var(--green)' : 'var(--red)';
      return `<div class="cem-item">
        <div class="cem-dot" style="background:${dotColor}"></div>
        <div class="cem-time">T-${MAX_HISTORY - m.tick}</div>
        <div class="cem-text"><strong style="color:var(--text)">${m.label}</strong> → ${sign}${m.pct.toFixed(1)}% impact on ${comm}</div>
      </div>`;
    }).join('');
  }
}

// ═══════════════════════ EOD REPORT ═══════════════════════
function generateEOD() {
  const now = new Date().toLocaleDateString('en-GB');
  let firmPnL = 0;
  let bestTrade = null, worstTrade = null;
  let bestPnL = -Infinity, worstPnL = Infinity;

  let lines = [`FIRMWIDE EOD RISK REPORT — ${now}`, '─'.repeat(50)];

  for (const [key, desk] of Object.entries(DESKS)) {
    const deskTrades = state.trades.filter(t => t.desk === key);
    const pnl = deskTrades.reduce((s,t)=>s+calcPnL(t),0);
    const openTrades = deskTrades.filter(t=>t.status==='open');
    const peakLots = deskTrades.reduce((s,t)=>Math.max(s,t.lots),0);
    firmPnL += pnl;
    lines.push(`${desk.name.toUpperCase().padEnd(18)}: P&L: ${fmt(pnl).padEnd(12)} | Open: ${openTrades.length} pos | Peak: ${peakLots} lots`);

    deskTrades.forEach(t => {
      const p = calcPnL(t);
      if (p > bestPnL) { bestPnL = p; bestTrade = t; }
      if (p < worstPnL) { worstPnL = p; worstTrade = t; }
    });
  }

  lines.push('─'.repeat(50));
  lines.push(`FIRMWIDE P&L:     ${fmt(firmPnL)}`);
  lines.push(`BIGGEST WIN:      ${bestTrade ? `${bestTrade.commodity} (${DESKS[bestTrade.desk].name}) ${fmt(bestPnL)}` : 'N/A'}`);
  lines.push(`BIGGEST LOSS:     ${worstTrade ? `${worstTrade.commodity} (${DESKS[worstTrade.desk].name}) ${fmt(worstPnL)}` : 'N/A'}`);
  lines.push(`EVENTS FIRED:     ${state.firedEvents.size} / ${SCENARIOS.length}`);
  lines.push(`TOTAL TRADES:     ${state.trades.length}`);
  lines.push('─'.repeat(50));
  lines.push('RISK DESK VERDICT: [Complete verbally in debrief]');

  const reportText = lines.join('\n');

  const body = document.getElementById('eod-modal-body');
  body.innerHTML = `<div class="eod-report">${reportText.replace(/\+\$([\d,]+)/g,'<span class="eod-pos">+$$1</span>').replace(/-\$([\d,]+)/g,'<span class="eod-neg">-$$1</span>').replace(/(FIRMWIDE|BIGGEST|EVENTS|TOTAL|RISK DESK)/g,'<span class="eod-highlight">$1</span>')}</div>`;

  document.getElementById('modal-eod').classList.add('active');

  // Also populate debrief tab
  const debriefPlaceholder = document.getElementById('debrief-eod-placeholder');
  const debriefReport = document.getElementById('debrief-eod-report');
  if (debriefPlaceholder) debriefPlaceholder.style.display = 'none';
  if (debriefReport) {
    debriefReport.style.display = 'block';
    debriefReport.innerHTML = `<div class="eod-report">${reportText}</div>`;
  }
  window._eodText = reportText;
}

function copyEOD() {
  if (window._eodText) {
    navigator.clipboard.writeText(window._eodText).then(() => {
      flashAlert('info','Copied','EOD report copied to clipboard.');
    }).catch(() => {
      flashAlert('warn','Copy Failed','Please manually select and copy the report text.');
    });
  }
}

// ═══════════════════════ MORNING VIEWS ═══════════════════════
function renderMorningViews() {
  const grid = document.getElementById('morning-views-grid');
  const deskDefs = [
    { key: 'softs', label: 'Softs & Hards', color: 'amber', fields: ['Metals View (Gold, Silver, Copper)', 'Softs View (Coffee, Sugar, Cotton)', 'Key Trade Thesis', 'Stop-Out Level & Hedge Plan'] },
    { key: 'energy', label: 'Energy', color: 'blue', fields: ['Crude View (WTI & Brent targets)', 'Products View (Crack spread direction)', 'Nat Gas View', 'Stop-Out Level & EIA hedge plan'] },
    { key: 'agri', label: 'Agriculture', color: 'green', fields: ['Grains View (Corn, Soy, Wheat)', 'Crush Spread View', 'Livestock View', 'WASDE Positioning & Stop-Out'] },
  ];
  grid.innerHTML = deskDefs.map(d => {
    const submitted = state.morningViews[d.key];
    if (submitted) {
      return `<div class="card ${d.color}" style="padding:16px;">
        <div class="card-title" style="color:var(--${d.color})">${d.label} Morning View — SUBMITTED</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);line-height:1.9;">
          ${Object.entries(submitted).map(([k,v]) => `<div><span style="color:var(--${d.color})">${k}:</span> ${v || '—'}</div>`).join('')}
        </div>
        <button class="sim-btn ${d.color}" style="margin-top:10px;width:100%;" onclick="openMorningView('${d.key}')">Edit View</button>
      </div>`;
    }
    return `<div class="card ${d.color}" style="padding:16px;">
      <div class="card-title" style="color:var(--${d.color})">${d.label} Desk</div>
      <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Morning view not yet submitted. Desk Head: complete before 09:00.</p>
      <button class="sim-btn ${d.color}" style="width:100%;" onclick="openMorningView('${d.key}')">📋 Submit Morning View</button>
    </div>`;
  }).join('');
}

function openMorningView(deskKey) {
  const deskDefs = {
    softs: { label: 'Softs & Hards', color: 'amber', fields: ['Metals View (Gold, Silver, Copper)', 'Softs View (Coffee, Sugar, Cotton)', 'Key Trade Thesis', 'Stop-Out Level & Hedge Plan'] },
    energy: { label: 'Energy', color: 'blue', fields: ['Crude View (WTI & Brent targets)', 'Products View (Crack spread direction)', 'Nat Gas View', 'Stop-Out Level & EIA hedge plan'] },
    agri: { label: 'Agriculture', color: 'green', fields: ['Grains View (Corn, Soy, Wheat)', 'Crush Spread View', 'Livestock View', 'WASDE Positioning & Stop-Out'] },
  };
  const d = deskDefs[deskKey];
  const existing = state.morningViews[deskKey] || {};
  const modal = document.getElementById('modal-morning');
  const inner = document.getElementById('modal-morning-inner');
  inner.className = 'modal ' + d.color;
  document.getElementById('modal-morning-title').textContent = d.label + ' — Morning View';
  document.getElementById('modal-morning-body').innerHTML = d.fields.map(f => `
    <div class="mv-section">
      <div class="mv-label">${f}</div>
      <textarea class="mv-textarea" id="mv-${f.replace(/[^a-z]/gi,'_')}" placeholder="${f}...">${existing[f] || ''}</textarea>
    </div>`).join('');
  document.getElementById('modal-morning-submit').onclick = () => {
    const view = {};
    d.fields.forEach(f => { view[f] = document.getElementById('mv-'+f.replace(/[^a-z]/gi,'_')).value; });
    state.morningViews[deskKey] = view;
    saveState();
    closeModal('modal-morning');
    renderMorningViews();
    addAlert('good', `${d.label} morning view submitted.`);
    flashAlert('info', 'Morning View Submitted', d.label + ' view locked in.');
  };
  modal.classList.add('active');
}

// ═══════════════════════ MODALS ═══════════════════════
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('active'); });
});

// ═══════════════════════ RESET ═══════════════════════
function resetSim() {
  if (!confirm('Reset simulation? All trades, positions, alerts and morning views will be cleared.')) return;
  state.trades = [];
  state.alerts = [];
  state.alertCount = 0;
  state.firedEvents = new Set();
  state.seenTips = new Set();
  state.morningViews = { softs: null, energy: null, agri: null };
  state.tradeIdCounter = 1;
  state.spreadIdCounter = 1;
  state.spreads = [];
  state.prices = { ...DEFAULT_PRICES };
  state.pnlHistory = [];
  localStorage.removeItem(STORAGE_KEY);
  // Reset chart history, event markers, inventory
  EVENT_MARKERS.length = 0;
  for (const comm of Object.keys(PRICE_HISTORY)) {
    PRICE_HISTORY[comm] = [DEFAULT_PRICES[comm]];
  }
  Object.assign(INVENTORY, INVENTORY_INIT);
  if (_chartInstance) { _chartInstance.destroy(); _chartInstance = null; }
  document.getElementById('chart-modal').classList.remove('active');
  document.getElementById('alert-badge').classList.remove('show');
  document.getElementById('alert-list').innerHTML = '<div class="alert-item info"><span class="alert-time">--:--</span><span class="alert-msg">Simulation reset. All desks at $0 P&L.</span></div>';
  document.getElementById('blotter-body').innerHTML = '<div class="blotter-empty">No trades logged.</div>';
  // Reset spread template select
  const spreadSel = document.getElementById('spread-template-sel');
  if (spreadSel) spreadSel.innerHTML = '';
  renderPriceFeed();
  updateAllPnL();
  renderBlotter();
  renderPositions();
  renderScenarioButtons();
  renderMorningViews();
  renderRiskAnalytics();
  renderInventory();
  updateBidAskDisplay();
}

// ═══════════════════════ COMMODITY FILTER BY DESK ═══════════════════════
// onDeskChange() and onCommChange() now defined in the execution section above

// ═══════════════════════ VaR & SHARPE ANALYTICS ═══════════════════════
function calcCommVol(comm) {
  // Rolling 20-tick std dev of log-returns from PRICE_HISTORY
  const hist = PRICE_HISTORY[comm];
  if (!hist || hist.length < 5) {
    // Fallback to profile vol scaled to daily
    return (DRIFT_PROFILES[comm]?.vol || 0.05) / 100 * Math.sqrt(120);
  }
  const window = hist.slice(-20);
  const logRets = [];
  for (let i = 1; i < window.length; i++) {
    if (window[i-1] > 0) logRets.push(Math.log(window[i] / window[i-1]));
  }
  if (logRets.length < 2) return (DRIFT_PROFILES[comm]?.vol || 0.05) / 100 * Math.sqrt(120);
  const mean = logRets.reduce((a,b)=>a+b,0)/logRets.length;
  const variance = logRets.reduce((a,b)=>a+(b-mean)**2,0)/(logRets.length-1);
  const sigTick = Math.sqrt(variance);
  // Scale tick vol to daily: σ_daily = σ_tick * √(120 ticks/day)
  return sigTick * Math.sqrt(120);
}

function calcPositionVaR(t) {
  // Parametric VaR: z * σ_daily * Notional
  // z = 1.645 for 95% one-tailed
  const Z = 1.645;
  const curr = state.prices[t.commodity] || t.price;
  const notional = t.lots * t.contractSize * curr;
  const sigDaily = calcCommVol(t.commodity);
  return Z * sigDaily * notional;
}

function calcDeskVaR(deskKey) {
  const openTrades = state.trades.filter(t => t.desk === deskKey && t.status === 'open');
  return openTrades.reduce((s, t) => s + calcPositionVaR(t), 0);
}

function calcFirmSharpe() {
  // Collect tick-by-tick P&L snapshots stored in state.pnlHistory
  if (!state.pnlHistory || state.pnlHistory.length < 5) return null;
  const hist = state.pnlHistory;
  const diffs = [];
  for (let i = 1; i < hist.length; i++) diffs.push(hist[i] - hist[i-1]);
  const mean = diffs.reduce((a,b)=>a+b,0)/diffs.length;
  const variance = diffs.reduce((a,b)=>a+(b-mean)**2,0)/(diffs.length-1);
  const sig = Math.sqrt(variance);
  if (sig === 0) return null;
  // Raw per-tick Sharpe, annualise: * √(252 * 120)
  const ann = Math.sqrt(252 * 120);
  return (mean / sig) * ann;
}

function renderRiskAnalytics() {
  // Compute total open notional and margin
  const openTrades = state.trades.filter(t => t.status === 'open');
  const totalNotional = openTrades.reduce((s,t) => s + (t.lots * t.contractSize * (state.prices[t.commodity]||t.price)), 0);
  const totalMargin   = openTrades.reduce((s,t) => s + (t.initMargin || t.lots * t.contractSize * t.price * 0.05), 0);

  // Firm VaR = sum of desk VaRs (conservative, no netting)
  const firmVaR = ['softs','energy','agri'].reduce((s,d) => s + calcDeskVaR(d), 0);

  // Record P&L snapshot for Sharpe
  const firmPnL = state.trades.reduce((s,t) => s + calcPnL(t), 0);
  if (!state.pnlHistory) state.pnlHistory = [];
  state.pnlHistory.push(firmPnL);
  if (state.pnlHistory.length > 200) state.pnlHistory.shift();

  const sharpe = calcFirmSharpe();

  // Grid stats
  const grid = document.getElementById('risk-analytics-grid');
  if (!grid) return;
  grid.innerHTML = `
    <div class="ra-stat">
      <div class="ra-val" style="color:${firmVaR > 50000 ? 'var(--red)' : 'var(--amber)'}">${firmVaR > 0 ? '$' + firmVaR.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',') : '—'}</div>
      <div class="ra-lbl">Firmwide 95% VaR</div>
      <div class="ra-sub">1-day parametric · sum-of-desks</div>
    </div>
    <div class="ra-stat">
      <div class="ra-val" style="color:${sharpe == null ? 'var(--text-dim)' : sharpe >= 1 ? 'var(--green)' : sharpe >= 0 ? 'var(--amber)' : 'var(--red)'}">${sharpe != null ? sharpe.toFixed(2) : '—'}</div>
      <div class="ra-lbl">Sharpe Ratio (Ann.)</div>
      <div class="ra-sub">R_f = 0 · intraday horizon</div>
    </div>
    <div class="ra-stat">
      <div class="ra-val" style="color:var(--text)">${totalNotional > 0 ? '$' + (totalNotional/1000).toFixed(0) + 'K' : '—'}</div>
      <div class="ra-lbl">Total Notional</div>
      <div class="ra-sub">${openTrades.length} open position${openTrades.length!==1?'s':''}</div>
    </div>
    <div class="ra-stat">
      <div class="ra-val" style="color:var(--text-dim)">${totalMargin > 0 ? '$' + totalMargin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',') : '—'}</div>
      <div class="ra-lbl">Margin Held</div>
      <div class="ra-sub">5% initial margin rate</div>
    </div>
  `;

  // Desk VaR rows
  const deskRows = document.getElementById('desk-var-rows');
  if (!deskRows) return;
  const deskDefs = [
    { key: 'softs',  label: 'Softs & Hards', dll: 150000 },
    { key: 'energy', label: 'Energy',         dll: 200000 },
    { key: 'agri',   label: 'Agriculture',    dll: 150000 },
  ];
  const rowsHtml = deskDefs.map(d => {
    const deskPnL = state.trades.filter(t=>t.desk===d.key).reduce((s,t)=>s+calcPnL(t),0);
    const deskVaR = calcDeskVaR(d.key);
    const deskOpen = openTrades.filter(t=>t.desk===d.key);
    const varPct = Math.min(deskVaR / d.dll * 100, 100);
    const barColor = varPct > 75 ? 'var(--red)' : varPct > 40 ? 'var(--amber)' : 'var(--green)';
    const sharpe_desk = state.pnlHistory && state.pnlHistory.length > 5 ? '—' : '—'; // desk-level Sharpe would need per-desk history
    return `<div class="desk-var-row">
      <div class="desk-var-name">${d.label.split(' ')[0]}</div>
      <div>
        <div class="desk-var-bar-wrap"><div class="desk-var-bar" style="width:${varPct}%;background:${barColor}"></div></div>
      </div>
      <div style="color:${deskVaR>0?'var(--amber)':'var(--text-dim)'}">${deskVaR>0?'$'+deskVaR.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,','):'—'}</div>
      <div style="color:${deskPnL>=0?'var(--green)':'var(--red)'}">${fmt(deskPnL)}</div>
      <div style="color:var(--text-dim)">${deskOpen.length} pos</div>
    </div>`;
  }).join('');
  deskRows.innerHTML = rowsHtml || '<div style="font-family:\'Share Tech Mono\',monospace;font-size:11px;color:var(--text-dim);padding:8px 0;">No open positions.</div>';
}

// ═══════════════════════ INVENTORY & CURVE STRUCTURE ═══════════════════════
function renderInventory() {
  const grid = document.getElementById('inventory-grid');
  if (!grid) return;

  const COMM_ORDER = [
    'WTI Crude','Brent Crude','Nat Gas','Heating Oil',
    'Gold','Silver','Copper',
    'Coffee','Sugar','Cotton',
    'Corn','Soybeans','Wheat','Soy Meal','Live Cattle',
  ];

  grid.innerHTML = COMM_ORDER.map(comm => {
    const inv = INVENTORY[comm] || 50;
    const curve = getCurveStructure(comm);
    const curveLabel = { backwardation: 'BACKWDTN', contango: 'CONTANGO', flat: 'FLAT' }[curve];
    const barColor = inv < 30 ? 'var(--green)' : inv > 70 ? 'var(--red)' : 'var(--amber)';
    const pressure = getInventoryPressure(comm);
    const pressureStr = pressure > 0 ? `↑+${(pressure*100).toFixed(2)}% bias` : pressure < 0 ? `↓${(pressure*100).toFixed(2)}% bias` : 'neutral';
    return `<div class="inv-item">
      <div class="inv-comm">${comm}</div>
      <div class="inv-level-wrap"><div class="inv-level-bar" style="width:${inv.toFixed(0)}%;background:${barColor}"></div></div>
      <div class="inv-stats">
        <span class="inv-stat">Inv: <span>${inv.toFixed(0)}%</span></span>
        <span class="inv-stat" style="color:${pressure > 0 ? 'var(--green)' : pressure < 0 ? 'var(--red)' : 'var(--text-dim)'}">${pressureStr}</span>
      </div>
      <span class="curve-tag ${curve}">${curveLabel}</span>
    </div>`;
  }).join('');
}

// ═══════════════════════ INIT ═══════════════════════
// Initialise desk commodity filter
onDeskChange();

renderPriceFeed();
renderScenarioButtons();
renderMorningViews();
updateAllPnL();
renderBlotter();
renderPositions();
renderRiskAnalytics();
renderInventory();
updateBidAskDisplay();
startPriceDrift(); // Auto price drift — fires every 30s for 6-hour session

// Restore alert feed from saved state
if (savedState && savedState.alerts && savedState.alerts.length > 0) {
  const list = document.getElementById('alert-list');
  list.innerHTML = '';
  const badge = document.getElementById('alert-badge');
  badge.textContent = savedState.alertCount || 0;
  if (savedState.alertCount > 0) badge.classList.add('show');
  // alerts stored newest-first, render them in that order
  savedState.alerts.forEach(a => {
    const item = document.createElement('div');
    item.className = `alert-item ${a.type}`;
    item.innerHTML = `<span class="alert-time">${a.time}</span><span class="alert-msg">${a.msg}</span>`;
    list.appendChild(item);
  });
}

// ═══════════════════════ PHASE TOAST ═══════════════════════
function showPhaseToast(phase, color) {
  const existing = document.getElementById('phase-toast');
  if (existing) existing.remove();
  const div = document.createElement('div');
  div.id = 'phase-toast';
  div.style.cssText = `position:fixed;top:0;left:0;right:0;z-index:9999;background:rgba(8,10,13,0.97);border-bottom:3px solid ${color};padding:20px;text-align:center;animation:phaseToastIn 0.4s ease;`;
  div.innerHTML = `
    <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:4px;margin-bottom:4px;">PHASE CHANGE</div>
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;letter-spacing:4px;color:${color};">${phase.toUpperCase()}</div>`;
  document.body.appendChild(div);
  setTimeout(() => { if (div.parentNode) div.style.animation = 'phaseToastOut 0.5s ease forwards'; }, 3000);
  setTimeout(() => { if (div.parentNode) div.remove(); }, 3600);
}

// ═══════════════════════ SPREAD / MULTI-LEG TRADES ═══════════════════════
const SPREAD_TEMPLATES = {
  'Brent/WTI Spread': { desk: 'energy', legs: [
    { label: 'Leg 1 — LONG Brent Crude', commodity: 'Brent Crude', dir: 'L' },
    { label: 'Leg 2 — SHORT WTI Crude',  commodity: 'WTI Crude',   dir: 'S' }
  ]},
  'Crack Spread (Long HO / Short WTI)': { desk: 'energy', legs: [
    { label: 'Leg 1 — LONG Heating Oil', commodity: 'Heating Oil', dir: 'L' },
    { label: 'Leg 2 — SHORT WTI Crude',  commodity: 'WTI Crude',   dir: 'S' }
  ]},
  'Gold/Silver Ratio (Long Silver / Short Gold)': { desk: 'softs', legs: [
    { label: 'Leg 1 — LONG Silver', commodity: 'Silver', dir: 'L' },
    { label: 'Leg 2 — SHORT Gold',  commodity: 'Gold',   dir: 'S' }
  ]},
  'Soy Crush (Long Beans / Short Meal)': { desk: 'agri', legs: [
    { label: 'Leg 1 — LONG Soybeans',   commodity: 'Soybeans', dir: 'L' },
    { label: 'Leg 2 — SHORT Soy Meal',  commodity: 'Soy Meal', dir: 'S' }
  ]},
  'Corn/Wheat Spread (Long Wheat / Short Corn)': { desk: 'agri', legs: [
    { label: 'Leg 1 — LONG Wheat', commodity: 'Wheat', dir: 'L' },
    { label: 'Leg 2 — SHORT Corn',  commodity: 'Corn',  dir: 'S' }
  ]},
  'Custom Spread (2 legs)': { desk: null, legs: [
    { label: 'Leg 1', commodity: null, dir: 'L' },
    { label: 'Leg 2', commodity: null, dir: 'S' }
  ]},
};

function openSpreadModal() {
  const modal = document.getElementById('modal-spread');
  // populate template selector
  const sel = document.getElementById('spread-template-sel');
  if (sel.options.length === 0) {
    Object.keys(SPREAD_TEMPLATES).forEach(k => {
      const o = document.createElement('option'); o.value = k; o.textContent = k; sel.appendChild(o);
    });
  }
  renderSpreadLegs();
  modal.classList.add('active');
}

function renderSpreadLegs() {
  const key = document.getElementById('spread-template-sel').value;
  const tpl = SPREAD_TEMPLATES[key];
  const container = document.getElementById('spread-legs-container');
  const deskSel = document.getElementById('spread-desk-sel');

  if (tpl.desk) {
    deskSel.value = tpl.desk;
    deskSel.disabled = true;
  } else {
    deskSel.disabled = false;
  }

  const allCommodities = Object.keys(CONTRACT_SIZES);

  container.innerHTML = tpl.legs.map((leg, i) => {
    const isCustom = !leg.commodity;
    const commodityHtml = isCustom
      ? `<select class="form-select" id="spread-leg-${i}-comm">${allCommodities.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>`
      : `<div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;color:var(--text);padding:8px 10px;background:var(--black);border:1px solid var(--border);">${leg.commodity}</div>`;

    const isCustomDir = !leg.dir;
    const dirHtml = isCustomDir
      ? `<select class="form-select" id="spread-leg-${i}-dir"><option value="L">LONG</option><option value="S">SHORT</option></select>`
      : `<div style="padding:8px 10px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:${leg.dir==='L'?'var(--green)':'var(--red)'};background:var(--black);border:1px solid var(--border);">${leg.dir==='L'?'▲ LONG':'▼ SHORT'}</div>`;

    return `
      <div style="background:#0a0e14;border:1px solid var(--border);border-left:3px solid ${i===0?'var(--green)':'var(--red)'};padding:12px;margin-bottom:10px;">
        <div class="form-label" style="margin-bottom:8px;">${leg.label}</div>
        <div style="display:grid;grid-template-columns:2fr 1fr 80px;gap:8px;align-items:end;">
          <div>
            <div class="form-label">Commodity</div>
            ${commodityHtml}
          </div>
          <div>
            <div class="form-label">Direction</div>
            ${dirHtml}
          </div>
          <div>
            <div class="form-label">Lots</div>
            <input class="form-input" type="number" id="spread-leg-${i}-lots" value="1" min="1" max="10">
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="form-label">Entry Price</div>
          <input class="form-input" type="number" id="spread-leg-${i}-price" step="0.01" placeholder="${leg.commodity && state.prices[leg.commodity] ? state.prices[leg.commodity].toFixed(2) : '0.00'}">
        </div>
      </div>`;
  }).join('');
}

function logSpreadTrade() {
  const key = document.getElementById('spread-template-sel').value;
  const tpl = SPREAD_TEMPLATES[key];
  const desk = document.getElementById('spread-desk-sel').value;
  const legs = [];

  for (let i = 0; i < tpl.legs.length; i++) {
    const legTpl = tpl.legs[i];
    const commodity = legTpl.commodity || document.getElementById(`spread-leg-${i}-comm`)?.value;
    const dir = legTpl.dir || document.getElementById(`spread-leg-${i}-dir`)?.value;
    const price = parseFloat(document.getElementById(`spread-leg-${i}-price`).value);
    const lots = parseInt(document.getElementById(`spread-leg-${i}-lots`).value);

    if (!price || price <= 0) { flashAlert('warn', 'Missing Price', `Enter a price for Leg ${i+1}.`); return; }
    if (!lots || lots < 1)   { flashAlert('warn', 'Missing Lots', `Enter lots for Leg ${i+1}.`); return; }
    legs.push({ commodity, dir, price, lots });
  }

  // Check total lot limits
  const existingLots = state.trades.filter(t => t.desk === desk && t.status === 'open').reduce((s,t)=>s+t.lots,0);
  const addingLots = legs.reduce((s,l)=>s+l.lots,0);
  if (existingLots + addingLots > DESKS[desk].maxLots) {
    flashAlert('danger','Position Limit Breach',`Would exceed max ${DESKS[desk].maxLots} lots for ${DESKS[desk].name}.`);
    return;
  }

  const spreadId = state.spreadIdCounter++;
  const spreadName = key;
  legs.forEach((leg, i) => {
    const trade = {
      id: state.tradeIdCounter++,
      time: getTime(),
      desk,
      commodity: leg.commodity,
      dir: leg.dir,
      price: leg.price,
      lots: leg.lots,
      contractSize: CONTRACT_SIZES[leg.commodity] || 1,
      status: 'open',
      currPrice: state.prices[leg.commodity] || leg.price,
      spreadId,
      spreadName,
      legNum: i + 1
    };
    state.trades.push(trade);
  });

  addAlert('info', `📊 SPREAD: ${DESKS[desk].name} — ${spreadName} (${legs.length} legs logged)`);
  flashAlert('info', 'Spread Logged', `${spreadName} — ${legs.length} legs entered for ${DESKS[desk].name}`);
  closeModal('modal-spread');
  updateAllPnL();
  renderBlotter();
  renderPositions();
  saveState();
}

// Fix about tab active styling
document.getElementById('tab-about').addEventListener('click', function() {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  this.classList.add('active');
  this.style.color = 'var(--amber)';
  this.style.borderBottomColor = 'var(--amber)';
});
document.querySelectorAll('.tab:not(#tab-about)').forEach(t => {
  t.addEventListener('click', function() {
    const at = document.getElementById('tab-about');
    at.style.color = '#4a5568';
    at.style.borderBottomColor = 'transparent';
  });
});
</script>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: MODEL DOCUMENTATION -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-model">
  <div class="section-title cyan">Model Documentation <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;font-weight:400;text-transform:none;">Technical specification — price processes, risk metrics, execution framework</span></div>

  <div class="grid-2">
    <div>
      <div class="model-section">
        <div class="section-title">1. Price Process — Hybrid GBM / Ornstein-Uhlenbeck</div>
        <p style="font-size:12px;color:var(--text-dim);line-height:1.8;margin-bottom:10px;">Commodity prices are modelled as a hybrid process combining Geometric Brownian Motion with a mean-reverting Ornstein-Uhlenbeck layer. Commodities are fundamentally mean-reverting due to production response, storage economics, and seasonal demand — pure GBM is insufficient for physical commodities.</p>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;">Discrete GBM Component</div>
        <div class="model-formula">S(t+Δt) = S(t) · exp( (μ - σ²/2)·Δt + σ·√Δt·ε )
ε ~ N(0,1)
μ = annualised drift (commodity-specific, per table below)
σ = annualised volatility
Δt = 1/120 hour  (30-second tick interval)</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Mean-Reversion (OU) Overlay</div>
        <div class="model-formula">dS = θ · (μ_LR - S) · dt + σ · dW
θ  = speed of reversion (0.008–0.015 per tick)
μ_LR = session-open price (long-run equilibrium proxy)
Implementation: correction += θ · (S₀ - S_curr) / S₀ · 100%</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Cross-Asset Correlation</div>
        <div class="model-formula">Shared group shock applied each tick:
  Energy:  WTI · Brent · Heating Oil · Nat Gas   (ρ ≈ 0.70)
  Metals:  Gold · Silver · Copper                (ρ ≈ 0.60)
  Softs:   Coffee · Sugar · Cotton               (ρ ≈ 0.45)
  Grains:  Corn · Soybeans · Wheat · Soy Meal    (ρ ≈ 0.65)
ε_group ~ Uniform(-0.03%, +0.03%) each tick</div>
      </div>

      <div class="model-section">
        <div class="section-title">2. Execution Framework</div>
        <p style="font-size:12px;color:var(--text-dim);line-height:1.8;margin-bottom:10px;">Two order types supported. Market orders execute at the live ask (long) or bid (short) plus a lot-size-dependent slippage adjustment. Limit orders fill at the specified price with no slippage, subject to price reaching the level.</p>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;">Bid/Ask Spread</div>
        <div class="model-formula">Bid = S_mid · (1 - spread_bps / 20000)
Ask = S_mid · (1 + spread_bps / 20000)
Spread varies by liquidity class (4–20 bps, see table)</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Slippage (Market Orders)</div>
        <div class="model-formula">Slippage_pct = base_slip · √(lots)
Direction: long → executed higher; short → executed lower
Typical: 0.02%–0.12% per trade depending on size</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Margin</div>
        <div class="model-formula">Initial margin = 5% of notional value
Notional = lots · contract_size · current_price
Margin call threshold: equity < 50% of initial margin
(Simulated alert only — no forced liquidation in club mode)</div>
      </div>
    </div>

    <div>
      <div class="model-section">
        <div class="section-title">3. Risk Metrics</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;">Parametric VaR (95%, 1-day)</div>
        <div class="model-formula">VaR = z · σ_daily · Notional
z = 1.645  (95% one-tailed confidence)
σ_daily = σ_tick · √(120)  [tick → daily scaling]
σ_tick = rolling 20-tick std dev of log-returns
Aggregated: Σ(desk VaR) — conservative (no netting)</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Known Limitations</div>
        <div class="limitation-item known"><strong>Normality:</strong> Parametric VaR assumes Gaussian returns. Commodity returns exhibit fat tails — true tail risk understated by ~20–40% vs historical simulation.</div>
        <div class="limitation-item known"><strong>Independence:</strong> Desk VaR summed without portfolio correlation offset. Diversified VaR in practice is lower.</div>
        <div class="limitation-item known"><strong>Short estimation window:</strong> 20-tick rolling window underestimates volatility after event shocks (regime change).</div>
        <div class="section-title" style="font-size:9px;margin-bottom:6px;margin-top:12px;">Sharpe Ratio</div>
        <div class="model-formula">Sharpe = E[R] / σ_R
R = P&L change per tick / initial notional
σ_R = std dev of per-tick returns
Annualised: Sharpe_ann = Sharpe · √(252 · 120 ticks/day)
R_f = 0 (intraday horizon; risk-free rate immaterial)</div>
      </div>

      <div class="model-section">
        <div class="section-title">4. Inventory & Curve Structure</div>
        <p style="font-size:12px;color:var(--text-dim);line-height:1.8;margin-bottom:10px;">Inventory levels evolve stochastically and feed back into drift bias and curve structure classification. This models the fundamental storage/convenience yield relationship.</p>
        <div class="model-formula">Inventory(t+Δt) = Inventory(t) + supply - demand + ε
ε ~ N(0, σ_inv)  per tick
Curve structure:
  Inventory &lt; 30% capacity → BACKWARDATION (spot premium)
  Inventory &gt; 70% capacity → CONTANGO (carry cost dominates)
  30–70%                   → FLAT / NEUTRAL
Inventory pressure on drift:
  &lt;20%: additional drift += +0.05%/tick
  &gt;80%: additional drift -= 0.03%/tick</div>
      </div>

      <div class="model-section">
        <div class="section-title green">5. CV Description</div>
        <div style="background:#080a0d;border:1px solid rgba(0,230,118,0.2);border-left:3px solid var(--green);padding:14px 16px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);line-height:1.9;">
          <div style="color:var(--green);font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;">Suggested CV Language</div>
          "Developed a multi-desk commodity risk &amp; execution engine featuring hybrid GBM/Ornstein-Uhlenbeck stochastic price modelling with cross-asset correlation shocks, bid/ask spread simulation with lot-size-dependent slippage, 95% parametric VaR and intraday Sharpe analytics, 5% margin enforcement, and fundamental inventory-driven curve structure signals (backwardation/contango). Deployed as a zero-dependency single-file web application for live trading simulations at KLU Commodity Trading Club, Hamburg."
        </div>
      </div>
    </div>
  </div>

  <div class="section-title" style="margin-top:8px;">Full Parameter Table</div>
  <div style="background:var(--panel);border:1px solid var(--border);overflow-x:auto;">
    <table class="model-param-table">
      <thead>
        <tr><th>Commodity</th><th>μ drift/hr</th><th>σ vol/tick</th><th>θ OU speed</th><th>Spread bps</th><th>Slip base</th><th>Circuit breaker</th></tr>
      </thead>
      <tbody id="model-param-tbody">
        <tr><td>Gold</td><td>+0.08%</td><td>0.04%</td><td>0.010</td><td>5</td><td>0.03%</td><td>85%–118%</td></tr>
        <tr><td>Silver</td><td>+0.12%</td><td>0.07%</td><td>0.015</td><td>8</td><td>0.05%</td><td>80%–122%</td></tr>
        <tr><td>Copper</td><td>-0.05%</td><td>0.06%</td><td>0.012</td><td>10</td><td>0.04%</td><td>82%–120%</td></tr>
        <tr><td>Coffee</td><td>+0.10%</td><td>0.09%</td><td>0.008</td><td>12</td><td>0.06%</td><td>75%–130%</td></tr>
        <tr><td>Sugar</td><td>+0.04%</td><td>0.05%</td><td>0.010</td><td>10</td><td>0.04%</td><td>85%–118%</td></tr>
        <tr><td>Cotton</td><td>-0.03%</td><td>0.04%</td><td>0.012</td><td>14</td><td>0.05%</td><td>88%–115%</td></tr>
        <tr><td>WTI Crude</td><td>+0.06%</td><td>0.08%</td><td>0.010</td><td>4</td><td>0.03%</td><td>78%–122%</td></tr>
        <tr><td>Brent Crude</td><td>+0.07%</td><td>0.08%</td><td>0.010</td><td>4</td><td>0.03%</td><td>78%–122%</td></tr>
        <tr><td>Nat Gas</td><td>-0.08%</td><td>0.14%</td><td>0.008</td><td>18</td><td>0.08%</td><td>65%–140%</td></tr>
        <tr><td>Heating Oil</td><td>+0.05%</td><td>0.07%</td><td>0.010</td><td>12</td><td>0.05%</td><td>80%–122%</td></tr>
        <tr><td>Corn</td><td>-0.04%</td><td>0.05%</td><td>0.012</td><td>8</td><td>0.04%</td><td>85%–118%</td></tr>
        <tr><td>Soybeans</td><td>+0.03%</td><td>0.06%</td><td>0.010</td><td>9</td><td>0.04%</td><td>82%–120%</td></tr>
        <tr><td>Wheat</td><td>+0.02%</td><td>0.07%</td><td>0.009</td><td>10</td><td>0.05%</td><td>80%–122%</td></tr>
        <tr><td>Soy Meal</td><td>+0.04%</td><td>0.06%</td><td>0.010</td><td>11</td><td>0.04%</td><td>82%–120%</td></tr>
        <tr><td>Live Cattle</td><td>+0.01%</td><td>0.03%</td><td>0.015</td><td>16</td><td>0.06%</td><td>90%–112%</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════ -->
<!-- PAGE: ABOUT / CREATOR -->
<!-- ═══════════════════════════════════════════════════ -->
<div class="page" id="page-about">
  <div style="max-width:900px;margin:0 auto;">

    <!-- Open Source Banner -->
    <div style="background:linear-gradient(135deg,#0d1117 60%,#0a1520);border:1px solid #1a2332;border-top:3px solid var(--amber);padding:32px 36px;margin-bottom:28px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle,rgba(255,179,0,0.04) 0%,transparent 70%);pointer-events:none;"></div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;color:var(--amber);margin-bottom:10px;text-transform:uppercase;">Open Source Project</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:36px;font-weight:900;letter-spacing:2px;color:var(--text);line-height:1;margin-bottom:6px;">Commodity Trading Simulation <span style="color:var(--amber)">Framework</span></div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);margin-bottom:24px;letter-spacing:1px;">v1.0 · Full Day Multi-Desk Trading Simulation · HTML/CSS/JS · No Dependencies</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div style="padding:6px 14px;border:1px solid rgba(255,179,0,0.3);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--amber);text-transform:uppercase;">◆ Free to Use</div>
        <div style="padding:6px 14px;border:1px solid rgba(0,230,118,0.3);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--green);text-transform:uppercase;">◆ Open Source</div>
        <div style="padding:6px 14px;border:1px solid rgba(64,196,255,0.3);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--blue);text-transform:uppercase;">◆ Educational Use</div>
        <div style="padding:6px 14px;border:1px solid rgba(255,179,0,0.3);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;color:var(--amber);text-transform:uppercase;">◆ Single File · Zero Setup</div>
      </div>
    </div>

    <!-- Creator Card -->
    <div style="display:grid;grid-template-columns:auto 1fr;gap:0;margin-bottom:28px;border:1px solid #1a2332;overflow:hidden;">
      <!-- Left accent strip + avatar area -->
      <div style="background:linear-gradient(180deg,#0d1520,#080a0d);border-right:1px solid #1a2332;padding:32px 28px;display:flex;flex-direction:column;align-items:center;gap:16px;min-width:180px;">
        <div style="width:80px;height:80px;border:2px solid var(--amber);background:#0a0e14;display:flex;align-items:center;justify-content:center;position:relative;">
          <span style="font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:var(--amber);">MM</span>
          <div style="position:absolute;bottom:-1px;right:-1px;width:18px;height:18px;background:var(--green);display:flex;align-items:center;justify-content:center;">
            <span style="font-size:9px;">✓</span>
          </div>
        </div>
        <div style="text-align:center;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;color:var(--amber);text-transform:uppercase;margin-bottom:4px;">Creator</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim);letter-spacing:1px;">Hamburg, DE</div>
        </div>
        <!-- KLU Badge -->
        <div style="border:1px solid #1a2332;background:#080a0d;padding:10px 14px;text-align:center;width:100%;">
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:900;letter-spacing:2px;color:#40c4ff;text-transform:uppercase;margin-bottom:2px;">KLU</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--text-dim);letter-spacing:1px;line-height:1.6;">Kühne Logistics<br>University</div>
          <div style="width:100%;height:1px;background:linear-gradient(90deg,transparent,#40c4ff,transparent);margin:6px 0;"></div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:7px;color:var(--text-dim);letter-spacing:1px;">M.Sc. Global Logistics<br>& Supply Chain Mgmt</div>
        </div>
      </div>

      <!-- Right: bio content -->
      <div style="padding:32px 32px;background:#0d1117;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:900;letter-spacing:1px;color:var(--text);margin-bottom:2px;">Matteo Mazzantini</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--amber);letter-spacing:2px;margin-bottom:20px;">FOUNDER & HEAD OF TRADING · KLU SOFT COMMODITY & ENERGY TRADING CLUB</div>

        <p style="font-size:13px;color:var(--text-dim);line-height:1.9;margin-bottom:20px;">
          This simulation framework was designed and built by Matteo Mazzantini as part of his work founding KLU's first Commodity Trading Club. The tool was created to bridge academic theory with real-world commodity market mechanics — giving students hands-on experience with physical market structure, derivatives, and risk management across cocoa, coffee, grains, and energy markets.
        </p>

        <!-- Stats row -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
          <div style="background:#080a0d;border:1px solid #1a2332;padding:12px;text-align:center;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:20px;color:var(--amber);margin-bottom:2px;">4</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;">Trading Desks</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;padding:12px;text-align:center;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:20px;color:var(--green);margin-bottom:2px;">15+</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;">Commodities</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;padding:12px;text-align:center;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:20px;color:var(--blue);margin-bottom:2px;">1</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;">HTML File</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;padding:12px;text-align:center;">
            <div style="font-family:'Share Tech Mono',monospace;font-size:20px;color:var(--cyan);margin-bottom:2px;">0</div>
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;">Dependencies</div>
          </div>
        </div>

        <!-- Background highlights -->
        <div class="section-title green" style="margin-bottom:14px;">Background</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
          <div style="background:#080a0d;border:1px solid #1a2332;border-left:3px solid var(--amber);padding:12px 14px;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:6px;">Current Role</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">Working Student at <strong style="color:var(--text)">Hanseatic Cocoa & Commodities</strong>, Hamburg — supporting senior brokers on physical cocoa & coffee contracts, hedging advisory, and price risk analysis.</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;border-left:3px solid var(--blue);padding:12px 14px;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--blue);text-transform:uppercase;margin-bottom:6px;">Academic</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.7;"><strong style="color:var(--text)">M.Sc. Global Logistics & Supply Chain Management</strong>, Kühne Logistics University, Hamburg (2025–present). B.A. Global Governance, University of Rome Tor Vergata.</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;border-left:3px solid var(--green);padding:12px 14px;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--green);text-transform:uppercase;margin-bottom:6px;">Trading Club</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">Founded and runs KLU's first <strong style="color:var(--text)">Commodity Trading Club</strong> (Nov 2025). Leads weekly market briefings, manages simulated multi-commodity trading books, and organises industry-facing workshops.</div>
          </div>
          <div style="background:#080a0d;border:1px solid #1a2332;border-left:3px solid var(--cyan);padding:12px 14px;">
            <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;margin-bottom:6px;">Technical Skills</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.7;">Python · SQL · Excel (Advanced) · SAP S/4HANA · Power BI · SAS Visual Analytics · Data Science specialization.</div>
          </div>
        </div>

        <!-- Contact -->
        <div style="background:#080a0d;border:1px solid rgba(255,179,0,0.15);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
          <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);">
            <span style="color:var(--amber)">✉</span> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f19c908b8b909f85989f98df9c90b1969c90989ddf929e9c">[email&#160;protected]</a> &nbsp;·&nbsp; <span style="color:var(--amber)">📍</span> Hamburg, DE
          </div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;">Languages: English C2 · Italian C2 · Russian A1</div>
        </div>
      </div>
    </div>

    <!-- Licence / attribution note -->
    <div style="background:#080a0d;border:1px solid #1a2332;padding:16px 20px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--text-dim);line-height:1.9;text-align:center;">
      This tool is free for educational and non-commercial use. If you use or adapt this simulation, please credit <span style="color:var(--amber)">Matteo Mazzantini / KLU Commodity Trading Club, Hamburg</span>.<br>
      <span style="color:var(--text-dim);font-size:10px;">Built with
